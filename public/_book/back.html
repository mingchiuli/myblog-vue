<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>第 1 章 后端 | 关于本博客</title>
  <meta name="description" content="本博客代码合集" />
  <meta name="generator" content="bookdown 0.23 and GitBook 2.6.7" />

  <meta property="og:title" content="第 1 章 后端 | 关于本博客" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="本博客代码合集" />
  <meta name="github-repo" content="yihui/bookdown-chinese" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="第 1 章 后端 | 关于本博客" />
  
  <meta name="twitter:description" content="本博客代码合集" />
  

<meta name="author" content="MingChiu Li" />


<meta name="date" content="2022-01-04" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="author.html"/>
<link rel="next" href="front.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery-3.6.0.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">VUEBLOG</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>前言</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#致谢"><i class="fa fa-check"></i>致谢</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="author.html"><a href="author.html"><i class="fa fa-check"></i>作者简介</a></li>
<li class="chapter" data-level="1" data-path="back.html"><a href="back.html"><i class="fa fa-check"></i><b>1</b> 后端</a>
<ul>
<li class="chapter" data-level="1.1" data-path="back.html"><a href="back.html#mysql"><i class="fa fa-check"></i><b>1.1</b> mysql</a></li>
<li class="chapter" data-level="1.2" data-path="back.html"><a href="back.html#shiro"><i class="fa fa-check"></i><b>1.2</b> Shiro</a></li>
<li class="chapter" data-level="1.3" data-path="back.html"><a href="back.html#controller"><i class="fa fa-check"></i><b>1.3</b> controller</a></li>
<li class="chapter" data-level="1.4" data-path="back.html"><a href="back.html#redis"><i class="fa fa-check"></i><b>1.4</b> Redis</a></li>
<li class="chapter" data-level="1.5" data-path="back.html"><a href="back.html#elasticsearch"><i class="fa fa-check"></i><b>1.5</b> ElasticSearch</a></li>
<li class="chapter" data-level="1.6" data-path="back.html"><a href="back.html#rabbitmq"><i class="fa fa-check"></i><b>1.6</b> RabbitMQ</a></li>
<li class="chapter" data-level="1.7" data-path="back.html"><a href="back.html#websocket"><i class="fa fa-check"></i><b>1.7</b> WebSocket</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="back.html"><a href="back.html#javax的api"><i class="fa fa-check"></i><b>1.7.1</b> javax的API：</a></li>
<li class="chapter" data-level="1.7.2" data-path="back.html"><a href="back.html#spring的api"><i class="fa fa-check"></i><b>1.7.2</b> spring的API</a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="back.html"><a href="back.html#统一缓存和统一异常处理"><i class="fa fa-check"></i><b>1.8</b> 统一缓存和统一异常处理</a></li>
<li class="chapter" data-level="1.9" data-path="back.html"><a href="back.html#其他部分"><i class="fa fa-check"></i><b>1.9</b> 其他部分</a></li>
<li class="chapter" data-level="1.10" data-path="back.html"><a href="back.html#日志监控"><i class="fa fa-check"></i><b>1.10</b> 日志监控</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="front.html"><a href="front.html"><i class="fa fa-check"></i><b>2</b> 前端</a>
<ul>
<li class="chapter" data-level="2.1" data-path="front.html"><a href="front.html#components"><i class="fa fa-check"></i><b>2.1</b> components</a></li>
<li class="chapter" data-level="2.2" data-path="front.html"><a href="front.html#router"><i class="fa fa-check"></i><b>2.2</b> router</a></li>
<li class="chapter" data-level="2.3" data-path="front.html"><a href="front.html#vuex"><i class="fa fa-check"></i><b>2.3</b> vuex</a></li>
<li class="chapter" data-level="2.4" data-path="front.html"><a href="front.html#other"><i class="fa fa-check"></i><b>2.4</b> other</a></li>
<li class="chapter" data-level="2.5" data-path="front.html"><a href="front.html#axios"><i class="fa fa-check"></i><b>2.5</b> axios</a></li>
<li class="chapter" data-level="2.6" data-path="front.html"><a href="front.html#main"><i class="fa fa-check"></i><b>2.6</b> main</a></li>
<li class="chapter" data-level="2.7" data-path="front.html"><a href="front.html#permission"><i class="fa fa-check"></i><b>2.7</b> permission</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>参考文献</a></li>
<li class="divider"></li>
<li><a href="https://bookdown.org" target="blank">本书由 bookdown 强力驱动</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">关于本博客</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="back" class="section level1" number="1">
<h1><span class="header-section-number">第 1 章</span> 后端</h1>
<div id="mysql" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> mysql</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="back.html#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> `m_user` (</span>
<span id="cb3-2"><a href="back.html#cb3-2" aria-hidden="true" tabindex="-1"></a>  `id` bigint(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> AUTO_INCREMENT,</span>
<span id="cb3-3"><a href="back.html#cb3-3" aria-hidden="true" tabindex="-1"></a>  `username` <span class="dt">varchar</span>(<span class="dv">64</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-4"><a href="back.html#cb3-4" aria-hidden="true" tabindex="-1"></a>  `avatar` <span class="dt">varchar</span>(<span class="dv">255</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-5"><a href="back.html#cb3-5" aria-hidden="true" tabindex="-1"></a>  `email` <span class="dt">varchar</span>(<span class="dv">64</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-6"><a href="back.html#cb3-6" aria-hidden="true" tabindex="-1"></a>  `password` <span class="dt">varchar</span>(<span class="dv">64</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-7"><a href="back.html#cb3-7" aria-hidden="true" tabindex="-1"></a>  `status` <span class="dt">int</span>(<span class="dv">5</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-8"><a href="back.html#cb3-8" aria-hidden="true" tabindex="-1"></a>  `created` datetime <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-9"><a href="back.html#cb3-9" aria-hidden="true" tabindex="-1"></a>  `last_login` datetime <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-10"><a href="back.html#cb3-10" aria-hidden="true" tabindex="-1"></a>  `role` vachar(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-11"><a href="back.html#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (`id`),</span>
<span id="cb3-12"><a href="back.html#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">KEY</span> `UK_USERNAME` (`username`) <span class="kw">USING</span> BTREE</span>
<span id="cb3-13"><a href="back.html#cb3-13" aria-hidden="true" tabindex="-1"></a>) ENGINE<span class="op">=</span>InnoDB <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8;</span>
<span id="cb3-14"><a href="back.html#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="back.html#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">TABLE</span> `m_blog` (</span>
<span id="cb3-16"><a href="back.html#cb3-16" aria-hidden="true" tabindex="-1"></a>  `id` bigint(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> AUTO_INCREMENT,</span>
<span id="cb3-17"><a href="back.html#cb3-17" aria-hidden="true" tabindex="-1"></a>  `user_id` bigint(<span class="dv">20</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-18"><a href="back.html#cb3-18" aria-hidden="true" tabindex="-1"></a>  `title` <span class="dt">varchar</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-19"><a href="back.html#cb3-19" aria-hidden="true" tabindex="-1"></a>  `description` <span class="dt">varchar</span>(<span class="dv">255</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-20"><a href="back.html#cb3-20" aria-hidden="true" tabindex="-1"></a>  `content` longtext,</span>
<span id="cb3-21"><a href="back.html#cb3-21" aria-hidden="true" tabindex="-1"></a>  `created` datetime <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">ON</span> <span class="kw">UPDATE</span> <span class="fu">CURRENT_TIMESTAMP</span>,</span>
<span id="cb3-22"><a href="back.html#cb3-22" aria-hidden="true" tabindex="-1"></a>  `status` tinyint(<span class="dv">4</span>) <span class="kw">DEFAULT</span> <span class="kw">NULL</span>,</span>
<span id="cb3-23"><a href="back.html#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (`id`)</span>
<span id="cb3-24"><a href="back.html#cb3-24" aria-hidden="true" tabindex="-1"></a>) ENGINE<span class="op">=</span>InnoDB AUTO_INCREMENT<span class="op">=</span><span class="dv">11</span> <span class="kw">DEFAULT</span> CHARSET<span class="op">=</span>utf8mb4;</span>
<span id="cb3-25"><a href="back.html#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="back.html#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> `vueblog`.`m_user` (`id`, `username`, `avatar`, `email`, `password`, `status`, `created`, `last_login`) <span class="kw">VALUES</span> (<span class="st">&#39;1&#39;</span>, <span class="st">&#39;markerhub&#39;</span>, <span class="st">&#39;https://image-1300566513.cos.ap-guangzhou.myqcloud.com/upload/images/5a9f48118166308daba8b6da7e466aab.jpg&#39;</span>, <span class="kw">NULL</span>, <span class="st">&#39;96e79218965eb72c92a549dd5a330112&#39;</span>, <span class="st">&#39;0&#39;</span>, <span class="st">&#39;2020-04-20 10:44:01&#39;</span>, <span class="kw">NULL</span>);</span></code></pre></div>
<p>user表里<span class="math inline">\(username\)</span>字段还是加上unique为宜。</p>
<p>持久层用的框架是mybatis-plus。后来我发觉JDBCTemplate其实也可以，只是现在企业基本没有用它的。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="back.html#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="back.html#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">;</span></span>
<span id="cb4-3"><a href="back.html#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="back.html#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">TableField</span><span class="op">;</span></span>
<span id="cb4-5"><a href="back.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">TableName</span><span class="op">;</span></span>
<span id="cb4-6"><a href="back.html#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">IdType</span><span class="op">;</span></span>
<span id="cb4-7"><a href="back.html#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">TableId</span><span class="op">;</span></span>
<span id="cb4-8"><a href="back.html#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">LocalDateTime</span><span class="op">;</span></span>
<span id="cb4-9"><a href="back.html#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb4-10"><a href="back.html#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">LinkedHashMap</span><span class="op">;</span></span>
<span id="cb4-11"><a href="back.html#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="back.html#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonFormat</span><span class="op">;</span></span>
<span id="cb4-13"><a href="back.html#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonDeserialize</span><span class="op">;</span></span>
<span id="cb4-14"><a href="back.html#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonSerialize</span><span class="op">;</span></span>
<span id="cb4-15"><a href="back.html#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">datatype</span><span class="op">.</span><span class="im">jsr310</span><span class="op">.</span><span class="im">deser</span><span class="op">.</span><span class="im">LocalDateTimeDeserializer</span><span class="op">;</span></span>
<span id="cb4-16"><a href="back.html#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">datatype</span><span class="op">.</span><span class="im">jsr310</span><span class="op">.</span><span class="im">ser</span><span class="op">.</span><span class="im">LocalDateTimeSerializer</span><span class="op">;</span></span>
<span id="cb4-17"><a href="back.html#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb4-18"><a href="back.html#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">EqualsAndHashCode</span><span class="op">;</span></span>
<span id="cb4-19"><a href="back.html#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="back.html#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">constraints</span><span class="op">.</span><span class="im">NotBlank</span><span class="op">;</span></span>
<span id="cb4-21"><a href="back.html#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="back.html#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-23"><a href="back.html#cb4-23" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb4-24"><a href="back.html#cb4-24" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> </span>
<span id="cb4-25"><a href="back.html#cb4-25" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb4-26"><a href="back.html#cb4-26" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb4-27"><a href="back.html#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb4-28"><a href="back.html#cb4-28" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb4-29"><a href="back.html#cb4-29" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb4-30"><a href="back.html#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb4-31"><a href="back.html#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="at">@EqualsAndHashCode</span><span class="op">(</span>callSuper <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb4-32"><a href="back.html#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="at">@TableName</span><span class="op">(</span><span class="st">&quot;m_blog&quot;</span><span class="op">)</span></span>
<span id="cb4-33"><a href="back.html#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Blog <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb4-34"><a href="back.html#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="back.html#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> serialVersionUID <span class="op">=</span> <span class="dv">1032384974924024L</span><span class="op">;</span></span>
<span id="cb4-36"><a href="back.html#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="back.html#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@TableId</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> type <span class="op">=</span> IdType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb4-38"><a href="back.html#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb4-39"><a href="back.html#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="back.html#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">//文章对应的用户名字</span></span>
<span id="cb4-41"><a href="back.html#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@TableField</span><span class="op">(</span>exist <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb4-42"><a href="back.html#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> username<span class="op">;</span></span>
<span id="cb4-43"><a href="back.html#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="back.html#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> userId<span class="op">;</span></span>
<span id="cb4-45"><a href="back.html#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="back.html#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;标题不能为空&quot;</span><span class="op">)</span></span>
<span id="cb4-47"><a href="back.html#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> title<span class="op">;</span></span>
<span id="cb4-48"><a href="back.html#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="back.html#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;摘要不能为空&quot;</span><span class="op">)</span></span>
<span id="cb4-50"><a href="back.html#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> description<span class="op">;</span></span>
<span id="cb4-51"><a href="back.html#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="back.html#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;内容不能为空&quot;</span><span class="op">)</span></span>
<span id="cb4-53"><a href="back.html#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> content<span class="op">;</span></span>
<span id="cb4-54"><a href="back.html#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="back.html#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonDeserialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeDeserializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb4-56"><a href="back.html#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonSerialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeSerializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb4-57"><a href="back.html#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonFormat</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="op">)</span></span>
<span id="cb4-58"><a href="back.html#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime created<span class="op">;</span></span>
<span id="cb4-59"><a href="back.html#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="back.html#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> status<span class="op">;</span></span>
<span id="cb4-61"><a href="back.html#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="back.html#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">@TableField</span><span class="op">(</span>exist <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb4-63"><a href="back.html#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> readSum<span class="op">;</span></span>
<span id="cb4-64"><a href="back.html#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="back.html#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">@TableField</span><span class="op">(</span>exist <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb4-66"><a href="back.html#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> readRecent<span class="op">;</span></span>
<span id="cb4-67"><a href="back.html#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="back.html#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="back.html#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">;</span></span>
<span id="cb5-3"><a href="back.html#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="back.html#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">TableField</span><span class="op">;</span></span>
<span id="cb5-5"><a href="back.html#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">TableName</span><span class="op">;</span></span>
<span id="cb5-6"><a href="back.html#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">IdType</span><span class="op">;</span></span>
<span id="cb5-7"><a href="back.html#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">TableId</span><span class="op">;</span></span>
<span id="cb5-8"><a href="back.html#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">LocalDateTime</span><span class="op">;</span></span>
<span id="cb5-9"><a href="back.html#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb5-10"><a href="back.html#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="back.html#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonFormat</span><span class="op">;</span></span>
<span id="cb5-12"><a href="back.html#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonDeserialize</span><span class="op">;</span></span>
<span id="cb5-13"><a href="back.html#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonSerialize</span><span class="op">;</span></span>
<span id="cb5-14"><a href="back.html#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">datatype</span><span class="op">.</span><span class="im">jsr310</span><span class="op">.</span><span class="im">deser</span><span class="op">.</span><span class="im">LocalDateTimeDeserializer</span><span class="op">;</span></span>
<span id="cb5-15"><a href="back.html#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">datatype</span><span class="op">.</span><span class="im">jsr310</span><span class="op">.</span><span class="im">ser</span><span class="op">.</span><span class="im">LocalDateTimeSerializer</span><span class="op">;</span></span>
<span id="cb5-16"><a href="back.html#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb5-17"><a href="back.html#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">EqualsAndHashCode</span><span class="op">;</span></span>
<span id="cb5-18"><a href="back.html#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="back.html#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">constraints</span><span class="op">.</span><span class="im">Email</span><span class="op">;</span></span>
<span id="cb5-20"><a href="back.html#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">constraints</span><span class="op">.</span><span class="im">NotBlank</span><span class="op">;</span></span>
<span id="cb5-21"><a href="back.html#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="back.html#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb5-23"><a href="back.html#cb5-23" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb5-24"><a href="back.html#cb5-24" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> </span>
<span id="cb5-25"><a href="back.html#cb5-25" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb5-26"><a href="back.html#cb5-26" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb5-27"><a href="back.html#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb5-28"><a href="back.html#cb5-28" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb5-29"><a href="back.html#cb5-29" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb5-30"><a href="back.html#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb5-31"><a href="back.html#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="at">@EqualsAndHashCode</span><span class="op">(</span>callSuper <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb5-32"><a href="back.html#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="at">@TableName</span><span class="op">(</span><span class="st">&quot;m_user&quot;</span><span class="op">)</span></span>
<span id="cb5-33"><a href="back.html#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> User <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb5-34"><a href="back.html#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="back.html#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> serialVersionUID <span class="op">=</span> <span class="dv">18428328402842084L</span><span class="op">;</span></span>
<span id="cb5-36"><a href="back.html#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="back.html#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@TableId</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> type <span class="op">=</span> IdType<span class="op">.</span><span class="fu">AUTO</span><span class="op">)</span></span>
<span id="cb5-38"><a href="back.html#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb5-39"><a href="back.html#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="back.html#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;昵称不能为空&quot;</span><span class="op">)</span></span>
<span id="cb5-41"><a href="back.html#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> username<span class="op">;</span></span>
<span id="cb5-42"><a href="back.html#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="back.html#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> avatar<span class="op">;</span></span>
<span id="cb5-44"><a href="back.html#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="back.html#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;邮箱不能为空&quot;</span><span class="op">)</span></span>
<span id="cb5-46"><a href="back.html#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Email</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;邮箱格式不正确&quot;</span><span class="op">)</span></span>
<span id="cb5-47"><a href="back.html#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> email<span class="op">;</span></span>
<span id="cb5-48"><a href="back.html#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="back.html#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> password<span class="op">;</span></span>
<span id="cb5-50"><a href="back.html#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="back.html#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> status<span class="op">;</span></span>
<span id="cb5-52"><a href="back.html#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="back.html#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonDeserialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeDeserializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb5-54"><a href="back.html#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonSerialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeSerializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb5-55"><a href="back.html#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonFormat</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="op">)</span></span>
<span id="cb5-56"><a href="back.html#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime created<span class="op">;</span></span>
<span id="cb5-57"><a href="back.html#cb5-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-58"><a href="back.html#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonDeserialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeDeserializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb5-59"><a href="back.html#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonSerialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeSerializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb5-60"><a href="back.html#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonFormat</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="op">)</span></span>
<span id="cb5-61"><a href="back.html#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime lastLogin<span class="op">;</span></span>
<span id="cb5-62"><a href="back.html#cb5-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-63"><a href="back.html#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> role<span class="op">;</span></span>
<span id="cb5-64"><a href="back.html#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="back.html#cb5-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">@TableField</span><span class="op">(</span>exist <span class="op">=</span> <span class="kw">false</span><span class="op">)</span></span>
<span id="cb5-66"><a href="back.html#cb5-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> monitor<span class="op">;</span></span>
<span id="cb5-67"><a href="back.html#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="back.html#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="back.html#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">mapper</span><span class="op">;</span></span>
<span id="cb6-3"><a href="back.html#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="back.html#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb6-5"><a href="back.html#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">mapper</span><span class="op">.</span><span class="im">BaseMapper</span><span class="op">;</span></span>
<span id="cb6-6"><a href="back.html#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Service</span><span class="op">;</span></span>
<span id="cb6-7"><a href="back.html#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="back.html#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">List</span><span class="op">;</span></span>
<span id="cb6-9"><a href="back.html#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="back.html#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb6-11"><a href="back.html#cb6-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb6-12"><a href="back.html#cb6-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  Mapper <span class="co">接口</span></span>
<span id="cb6-13"><a href="back.html#cb6-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb6-14"><a href="back.html#cb6-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb6-15"><a href="back.html#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb6-16"><a href="back.html#cb6-16" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb6-17"><a href="back.html#cb6-17" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb6-18"><a href="back.html#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> BlogMapper <span class="kw">extends</span> BaseMapper<span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb6-19"><a href="back.html#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="back.html#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> <span class="fu">getYearCount</span><span class="op">(</span><span class="bu">Integer</span> year<span class="op">);</span></span>
<span id="cb6-21"><a href="back.html#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="back.html#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="fu">queryAllBlogs</span><span class="op">();</span></span>
<span id="cb6-23"><a href="back.html#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="back.html#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="fu">queryBlogs</span><span class="op">(</span><span class="bu">String</span> title<span class="op">);</span></span>
<span id="cb6-25"><a href="back.html#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="back.html#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">recover</span><span class="op">(</span>Blog blog<span class="op">);</span></span>
<span id="cb6-27"><a href="back.html#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="back.html#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="back.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">mapper</span><span class="op">;</span></span>
<span id="cb7-2"><a href="back.html#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="back.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb7-4"><a href="back.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">mapper</span><span class="op">.</span><span class="im">BaseMapper</span><span class="op">;</span></span>
<span id="cb7-5"><a href="back.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb7-6"><a href="back.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Service</span><span class="op">;</span></span>
<span id="cb7-7"><a href="back.html#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="back.html#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb7-9"><a href="back.html#cb7-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb7-10"><a href="back.html#cb7-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  Mapper <span class="co">接口</span></span>
<span id="cb7-11"><a href="back.html#cb7-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb7-12"><a href="back.html#cb7-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb7-13"><a href="back.html#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb7-14"><a href="back.html#cb7-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb7-15"><a href="back.html#cb7-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb7-16"><a href="back.html#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserMapper <span class="kw">extends</span> BaseMapper<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-17"><a href="back.html#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="back.html#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这种里面什么都没写的就是mybatis-plus的特色，因为没有太复杂的操作，所以就只用mybatis-plus提供的API了。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="back.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">impl</span><span class="op">;</span></span>
<span id="cb8-2"><a href="back.html#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="back.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb8-4"><a href="back.html#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">mapper</span><span class="op">.</span><span class="im">BlogMapper</span><span class="op">;</span></span>
<span id="cb8-5"><a href="back.html#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">BlogService</span><span class="op">;</span></span>
<span id="cb8-6"><a href="back.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">impl</span><span class="op">.</span><span class="im">ServiceImpl</span><span class="op">;</span></span>
<span id="cb8-7"><a href="back.html#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb8-8"><a href="back.html#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Service</span><span class="op">;</span></span>
<span id="cb8-9"><a href="back.html#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">transaction</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Transactional</span><span class="op">;</span></span>
<span id="cb8-10"><a href="back.html#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="back.html#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">ArrayList</span><span class="op">;</span></span>
<span id="cb8-12"><a href="back.html#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">List</span><span class="op">;</span></span>
<span id="cb8-13"><a href="back.html#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="back.html#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb8-15"><a href="back.html#cb8-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb8-16"><a href="back.html#cb8-16" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  <span class="co">服务实现类</span></span>
<span id="cb8-17"><a href="back.html#cb8-17" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb8-18"><a href="back.html#cb8-18" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb8-19"><a href="back.html#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb8-20"><a href="back.html#cb8-20" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb8-21"><a href="back.html#cb8-21" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb8-22"><a href="back.html#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb8-23"><a href="back.html#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> BlogServiceImpl <span class="kw">extends</span> ServiceImpl<span class="op">&lt;</span>BlogMapper<span class="op">,</span> Blog<span class="op">&gt;</span> <span class="kw">implements</span> BlogService <span class="op">{</span></span>
<span id="cb8-24"><a href="back.html#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="back.html#cb8-25" aria-hidden="true" tabindex="-1"></a>    BlogMapper blogMapper<span class="op">;</span></span>
<span id="cb8-26"><a href="back.html#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="back.html#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb8-28"><a href="back.html#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setBlogMapper</span><span class="op">(</span>BlogMapper blogMapper<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-29"><a href="back.html#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">blogMapper</span> <span class="op">=</span> blogMapper<span class="op">;</span></span>
<span id="cb8-30"><a href="back.html#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-31"><a href="back.html#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="back.html#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="back.html#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb8-34"><a href="back.html#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Integer</span> <span class="fu">getYearCount</span><span class="op">(</span><span class="bu">Integer</span> year<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-35"><a href="back.html#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> blogMapper<span class="op">.</span><span class="fu">getYearCount</span><span class="op">(</span>year<span class="op">);</span></span>
<span id="cb8-36"><a href="back.html#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-37"><a href="back.html#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="back.html#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb8-39"><a href="back.html#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="fu">queryAllBlogs</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-40"><a href="back.html#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> blogMapper<span class="op">.</span><span class="fu">queryAllBlogs</span><span class="op">();</span></span>
<span id="cb8-41"><a href="back.html#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-42"><a href="back.html#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="back.html#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb8-44"><a href="back.html#cb8-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="fu">queryBlogs</span><span class="op">(</span><span class="bu">String</span> title<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-45"><a href="back.html#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> blogMapper<span class="op">.</span><span class="fu">queryBlogs</span><span class="op">(</span>title<span class="op">);</span></span>
<span id="cb8-46"><a href="back.html#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-47"><a href="back.html#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="back.html#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb8-49"><a href="back.html#cb8-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">recover</span><span class="op">(</span>Blog blog<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-50"><a href="back.html#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> blogMapper<span class="op">.</span><span class="fu">recover</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb8-51"><a href="back.html#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-52"><a href="back.html#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-53"><a href="back.html#cb8-53" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="back.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">impl</span><span class="op">;</span></span>
<span id="cb9-2"><a href="back.html#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="back.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb9-4"><a href="back.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">mapper</span><span class="op">.</span><span class="im">UserMapper</span><span class="op">;</span></span>
<span id="cb9-5"><a href="back.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb9-6"><a href="back.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">impl</span><span class="op">.</span><span class="im">ServiceImpl</span><span class="op">;</span></span>
<span id="cb9-7"><a href="back.html#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Service</span><span class="op">;</span></span>
<span id="cb9-8"><a href="back.html#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="back.html#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb9-10"><a href="back.html#cb9-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb9-11"><a href="back.html#cb9-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  <span class="co">服务实现类</span></span>
<span id="cb9-12"><a href="back.html#cb9-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb9-13"><a href="back.html#cb9-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb9-14"><a href="back.html#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb9-15"><a href="back.html#cb9-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb9-16"><a href="back.html#cb9-16" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb9-17"><a href="back.html#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb9-18"><a href="back.html#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UserServiceImpl <span class="kw">extends</span> ServiceImpl<span class="op">&lt;</span>UserMapper<span class="op">,</span> User<span class="op">&gt;</span> <span class="kw">implements</span> UserService <span class="op">{</span></span>
<span id="cb9-19"><a href="back.html#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="back.html#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>ServiceImpl提供了许多封装好的方法。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="back.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">;</span></span>
<span id="cb10-2"><a href="back.html#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="back.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb10-4"><a href="back.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">IService</span><span class="op">;</span></span>
<span id="cb10-5"><a href="back.html#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="back.html#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb10-7"><a href="back.html#cb10-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb10-8"><a href="back.html#cb10-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  <span class="co">服务类</span></span>
<span id="cb10-9"><a href="back.html#cb10-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb10-10"><a href="back.html#cb10-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb10-11"><a href="back.html#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb10-12"><a href="back.html#cb10-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb10-13"><a href="back.html#cb10-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb10-14"><a href="back.html#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> UserService <span class="kw">extends</span> IService<span class="op">&lt;</span>User<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb10-15"><a href="back.html#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="back.html#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-17"><a href="back.html#cb10-17" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="back.html#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="back.html#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">;</span></span>
<span id="cb11-3"><a href="back.html#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="back.html#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb11-5"><a href="back.html#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">IService</span><span class="op">;</span></span>
<span id="cb11-6"><a href="back.html#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="back.html#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">ArrayList</span><span class="op">;</span></span>
<span id="cb11-8"><a href="back.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">List</span><span class="op">;</span></span>
<span id="cb11-9"><a href="back.html#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="back.html#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb11-11"><a href="back.html#cb11-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb11-12"><a href="back.html#cb11-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span>  <span class="co">服务类</span></span>
<span id="cb11-13"><a href="back.html#cb11-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb11-14"><a href="back.html#cb11-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb11-15"><a href="back.html#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author Li MingChiu</span>
<span id="cb11-16"><a href="back.html#cb11-16" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>since <span class="co">2021-10-27</span></span>
<span id="cb11-17"><a href="back.html#cb11-17" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb11-18"><a href="back.html#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> BlogService <span class="kw">extends</span> IService<span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb11-19"><a href="back.html#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="back.html#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="back.html#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> <span class="fu">getYearCount</span><span class="op">(</span><span class="bu">Integer</span> year<span class="op">);</span></span>
<span id="cb11-22"><a href="back.html#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="back.html#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="fu">queryAllBlogs</span><span class="op">();</span></span>
<span id="cb11-24"><a href="back.html#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="back.html#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> <span class="fu">queryBlogs</span><span class="op">(</span><span class="bu">String</span> title<span class="op">);</span></span>
<span id="cb11-26"><a href="back.html#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="back.html#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">boolean</span> <span class="fu">recover</span><span class="op">(</span>Blog blog<span class="op">);</span></span>
<span id="cb11-28"><a href="back.html#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="back.html#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb12-1"><a href="back.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb12-2"><a href="back.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot; <span class="dt">&gt;</span></span>
<span id="cb12-3"><a href="back.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;mapper</span><span class="ot"> namespace=</span><span class="st">&quot;com.markerhub.mapper.BlogMapper&quot;</span><span class="kw">&gt;</span></span>
<span id="cb12-4"><a href="back.html#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="back.html#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;insert</span><span class="ot"> id=</span><span class="st">&quot;recover&quot;</span><span class="ot"> parameterType=</span><span class="st">&quot;com.markerhub.entity.Blog&quot;</span><span class="kw">&gt;</span></span>
<span id="cb12-6"><a href="back.html#cb12-6" aria-hidden="true" tabindex="-1"></a>        insert into vueblog.m_blog(id, user_id, title, description, content, created, status) values (#{id}, #{userId}, #{title}, #{description}, #{content}, #{created}, #{status})</span>
<span id="cb12-7"><a href="back.html#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/insert&gt;</span></span>
<span id="cb12-8"><a href="back.html#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="back.html#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="back.html#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;select</span><span class="ot"> id=</span><span class="st">&quot;getYearCount&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;java.lang.Integer&quot;</span><span class="kw">&gt;</span></span>
<span id="cb12-11"><a href="back.html#cb12-11" aria-hidden="true" tabindex="-1"></a>        select count(*) from vueblog.m_blog where DATE_FORMAT(created, &#39;%Y&#39;) = #{year} group by DATE_FORMAT(created, &#39;%Y&#39;);</span>
<span id="cb12-12"><a href="back.html#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/select&gt;</span></span>
<span id="cb12-13"><a href="back.html#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="back.html#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="back.html#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;select</span><span class="ot"> id=</span><span class="st">&quot;queryAllBlogs&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;com.markerhub.entity.Blog&quot;</span><span class="kw">&gt;</span></span>
<span id="cb12-16"><a href="back.html#cb12-16" aria-hidden="true" tabindex="-1"></a>        select mb.id, username, title, description, content, mb.created, mb.status from vueblog.m_blog mb left join vueblog.m_user mu on mb.user_id = mu.id order by created desc ;</span>
<span id="cb12-17"><a href="back.html#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/select&gt;</span></span>
<span id="cb12-18"><a href="back.html#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="back.html#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="back.html#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;select</span><span class="ot"> id=</span><span class="st">&quot;queryBlogs&quot;</span><span class="ot"> resultType=</span><span class="st">&quot;com.markerhub.entity.Blog&quot;</span><span class="kw">&gt;</span></span>
<span id="cb12-21"><a href="back.html#cb12-21" aria-hidden="true" tabindex="-1"></a>        select mb.id, username, title, description, content, mb.created, mb.status from vueblog.m_blog mb left join vueblog.m_user mu on mb.user_id = mu.id where title like concat(&#39;%&#39;, #{title}, &#39;%&#39;) order by created desc;</span>
<span id="cb12-22"><a href="back.html#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/select&gt;</span></span>
<span id="cb12-23"><a href="back.html#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="back.html#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="back.html#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/mapper&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb13-1"><a href="back.html#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="back.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb13-3"><a href="back.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;<span class="dt">&gt;</span></span>
<span id="cb13-4"><a href="back.html#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;mapper</span><span class="ot"> namespace=</span><span class="st">&quot;com.markerhub.mapper.UserMapper&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-5"><a href="back.html#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="back.html#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/mapper&gt;</span></span>
<span id="cb13-7"><a href="back.html#cb13-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>没有新的方法，mybatis的xml也什么都不写。</p>
</div>
<div id="shiro" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Shiro</h2>
<p>因为是前后端分离的项目，所以权限用jwt去做。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb14-1"><a href="back.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb14-2"><a href="back.html#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="back.html#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="back.html#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">AccountRealm</span><span class="op">;</span></span>
<span id="cb14-5"><a href="back.html#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">JwtFilter</span><span class="op">;</span></span>
<span id="cb14-6"><a href="back.html#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb14-7"><a href="back.html#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">mgt</span><span class="op">.</span><span class="im">DefaultSessionStorageEvaluator</span><span class="op">;</span></span>
<span id="cb14-8"><a href="back.html#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">mgt</span><span class="op">.</span><span class="im">DefaultSubjectDAO</span><span class="op">;</span></span>
<span id="cb14-9"><a href="back.html#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">mgt</span><span class="op">.</span><span class="im">SecurityManager</span><span class="op">;</span></span>
<span id="cb14-10"><a href="back.html#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">spring</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">ShiroFilterFactoryBean</span><span class="op">;</span></span>
<span id="cb14-11"><a href="back.html#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">spring</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">DefaultShiroFilterChainDefinition</span><span class="op">;</span></span>
<span id="cb14-12"><a href="back.html#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">spring</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">ShiroFilterChainDefinition</span><span class="op">;</span></span>
<span id="cb14-13"><a href="back.html#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">mgt</span><span class="op">.</span><span class="im">DefaultWebSecurityManager</span><span class="op">;</span></span>
<span id="cb14-14"><a href="back.html#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">crazycake</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">RedisCacheManager</span><span class="op">;</span></span>
<span id="cb14-15"><a href="back.html#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">aop</span><span class="op">.</span><span class="im">framework</span><span class="op">.</span><span class="im">autoproxy</span><span class="op">.</span><span class="im">DefaultAdvisorAutoProxyCreator</span><span class="op">;</span></span>
<span id="cb14-16"><a href="back.html#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb14-17"><a href="back.html#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb14-18"><a href="back.html#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb14-19"><a href="back.html#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">serializer</span><span class="op">.</span><span class="im">Jackson2JsonRedisSerializer</span><span class="op">;</span></span>
<span id="cb14-20"><a href="back.html#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">serializer</span><span class="op">.</span><span class="im">StringRedisSerializer</span><span class="op">;</span></span>
<span id="cb14-21"><a href="back.html#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="back.html#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="back.html#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">Filter</span><span class="op">;</span></span>
<span id="cb14-24"><a href="back.html#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">HashMap</span><span class="op">;</span></span>
<span id="cb14-25"><a href="back.html#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">LinkedHashMap</span><span class="op">;</span></span>
<span id="cb14-26"><a href="back.html#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Map</span><span class="op">;</span></span>
<span id="cb14-27"><a href="back.html#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="back.html#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb14-29"><a href="back.html#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ShiroConfig <span class="op">{</span></span>
<span id="cb14-30"><a href="back.html#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="back.html#cb14-31" aria-hidden="true" tabindex="-1"></a>    JwtFilter jwtFilter<span class="op">;</span></span>
<span id="cb14-32"><a href="back.html#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="back.html#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb14-34"><a href="back.html#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtFilter jwtFilter<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-35"><a href="back.html#cb14-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtFilter</span> <span class="op">=</span> jwtFilter<span class="op">;</span></span>
<span id="cb14-36"><a href="back.html#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-37"><a href="back.html#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="back.html#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="back.html#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb14-40"><a href="back.html#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DefaultWebSecurityManager <span class="fu">securityManager</span><span class="op">(</span>AccountRealm accountRealm<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-41"><a href="back.html#cb14-41" aria-hidden="true" tabindex="-1"></a>        DefaultWebSecurityManager securityManager <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultWebSecurityManager</span><span class="op">(</span>accountRealm<span class="op">);</span></span>
<span id="cb14-42"><a href="back.html#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="back.html#cb14-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">/*</span></span>
<span id="cb14-44"><a href="back.html#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co">         * 关闭shiro自带的session，详情见文档</span></span>
<span id="cb14-45"><a href="back.html#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">         */</span></span>
<span id="cb14-46"><a href="back.html#cb14-46" aria-hidden="true" tabindex="-1"></a>        DefaultSubjectDAO subjectDAO <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultSubjectDAO</span><span class="op">();</span></span>
<span id="cb14-47"><a href="back.html#cb14-47" aria-hidden="true" tabindex="-1"></a>        DefaultSessionStorageEvaluator defaultSessionStorageEvaluator <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultSessionStorageEvaluator</span><span class="op">();</span></span>
<span id="cb14-48"><a href="back.html#cb14-48" aria-hidden="true" tabindex="-1"></a>        defaultSessionStorageEvaluator<span class="op">.</span><span class="fu">setSessionStorageEnabled</span><span class="op">(</span><span class="kw">false</span><span class="op">);</span></span>
<span id="cb14-49"><a href="back.html#cb14-49" aria-hidden="true" tabindex="-1"></a>        subjectDAO<span class="op">.</span><span class="fu">setSessionStorageEvaluator</span><span class="op">(</span>defaultSessionStorageEvaluator<span class="op">);</span></span>
<span id="cb14-50"><a href="back.html#cb14-50" aria-hidden="true" tabindex="-1"></a>        securityManager<span class="op">.</span><span class="fu">setSubjectDAO</span><span class="op">(</span>subjectDAO<span class="op">);</span></span>
<span id="cb14-51"><a href="back.html#cb14-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> securityManager<span class="op">;</span></span>
<span id="cb14-52"><a href="back.html#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-53"><a href="back.html#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb14-54"><a href="back.html#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ShiroFilterChainDefinition <span class="fu">shiroFilterChainDefinition</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-55"><a href="back.html#cb14-55" aria-hidden="true" tabindex="-1"></a>        DefaultShiroFilterChainDefinition chainDefinition <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultShiroFilterChainDefinition</span><span class="op">();</span></span>
<span id="cb14-56"><a href="back.html#cb14-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> filterMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">LinkedHashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb14-57"><a href="back.html#cb14-57" aria-hidden="true" tabindex="-1"></a>        filterMap<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;/**&quot;</span><span class="op">,</span> <span class="st">&quot;jwt&quot;</span><span class="op">);</span> <span class="co">// 主要通过注解方式校验权限</span></span>
<span id="cb14-58"><a href="back.html#cb14-58" aria-hidden="true" tabindex="-1"></a>        chainDefinition<span class="op">.</span><span class="fu">addPathDefinitions</span><span class="op">(</span>filterMap<span class="op">);</span></span>
<span id="cb14-59"><a href="back.html#cb14-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> chainDefinition<span class="op">;</span></span>
<span id="cb14-60"><a href="back.html#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-61"><a href="back.html#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span><span class="op">(</span><span class="st">&quot;shiroFilterFactoryBean&quot;</span><span class="op">)</span></span>
<span id="cb14-62"><a href="back.html#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ShiroFilterFactoryBean <span class="fu">shiroFilterFactoryBean</span><span class="op">(</span><span class="bu">SecurityManager</span> securityManager<span class="op">,</span></span>
<span id="cb14-63"><a href="back.html#cb14-63" aria-hidden="true" tabindex="-1"></a>                                                         ShiroFilterChainDefinition shiroFilterChainDefinition<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-64"><a href="back.html#cb14-64" aria-hidden="true" tabindex="-1"></a>        ShiroFilterFactoryBean shiroFilter <span class="op">=</span> <span class="kw">new</span> <span class="fu">ShiroFilterFactoryBean</span><span class="op">();</span></span>
<span id="cb14-65"><a href="back.html#cb14-65" aria-hidden="true" tabindex="-1"></a>        shiroFilter<span class="op">.</span><span class="fu">setSecurityManager</span><span class="op">(</span>securityManager<span class="op">);</span></span>
<span id="cb14-66"><a href="back.html#cb14-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Filter</span><span class="op">&gt;</span> filters <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb14-67"><a href="back.html#cb14-67" aria-hidden="true" tabindex="-1"></a>        filters<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;jwt&quot;</span><span class="op">,</span> jwtFilter<span class="op">);</span></span>
<span id="cb14-68"><a href="back.html#cb14-68" aria-hidden="true" tabindex="-1"></a>        shiroFilter<span class="op">.</span><span class="fu">setFilters</span><span class="op">(</span>filters<span class="op">);</span></span>
<span id="cb14-69"><a href="back.html#cb14-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> filterMap <span class="op">=</span> shiroFilterChainDefinition<span class="op">.</span><span class="fu">getFilterChainMap</span><span class="op">();</span></span>
<span id="cb14-70"><a href="back.html#cb14-70" aria-hidden="true" tabindex="-1"></a>        shiroFilter<span class="op">.</span><span class="fu">setFilterChainDefinitionMap</span><span class="op">(</span>filterMap<span class="op">);</span></span>
<span id="cb14-71"><a href="back.html#cb14-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shiroFilter<span class="op">;</span></span>
<span id="cb14-72"><a href="back.html#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-73"><a href="back.html#cb14-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-74"><a href="back.html#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 开启注解代理（默认好像已经开启，可以不要）</span></span>
<span id="cb14-75"><a href="back.html#cb14-75" aria-hidden="true" tabindex="-1"></a><span class="co">//    @Bean</span></span>
<span id="cb14-76"><a href="back.html#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="co">//    public AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor(SecurityManager securityManager){</span></span>
<span id="cb14-77"><a href="back.html#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="co">//        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = new AuthorizationAttributeSourceAdvisor();</span></span>
<span id="cb14-78"><a href="back.html#cb14-78" aria-hidden="true" tabindex="-1"></a><span class="co">//        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span></span>
<span id="cb14-79"><a href="back.html#cb14-79" aria-hidden="true" tabindex="-1"></a><span class="co">//        return authorizationAttributeSourceAdvisor;</span></span>
<span id="cb14-80"><a href="back.html#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="co">//    }</span></span>
<span id="cb14-81"><a href="back.html#cb14-81" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb14-82"><a href="back.html#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">//aop</span></span>
<span id="cb14-83"><a href="back.html#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb14-84"><a href="back.html#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DefaultAdvisorAutoProxyCreator <span class="fu">getDefaultAdvisorAutoProxyCreator</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb14-85"><a href="back.html#cb14-85" aria-hidden="true" tabindex="-1"></a>        DefaultAdvisorAutoProxyCreator creator <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultAdvisorAutoProxyCreator</span><span class="op">();</span></span>
<span id="cb14-86"><a href="back.html#cb14-86" aria-hidden="true" tabindex="-1"></a>        creator<span class="op">.</span><span class="fu">setProxyTargetClass</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span></span>
<span id="cb14-87"><a href="back.html#cb14-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> creator<span class="op">;</span></span>
<span id="cb14-88"><a href="back.html#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-89"><a href="back.html#cb14-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-90"><a href="back.html#cb14-90" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="back.html#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="back.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">;</span></span>
<span id="cb15-3"><a href="back.html#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="back.html#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">AccountProfile</span><span class="op">;</span></span>
<span id="cb15-5"><a href="back.html#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">SecurityUtils</span><span class="op">;</span></span>
<span id="cb15-6"><a href="back.html#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="back.html#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> ShiroUtil <span class="op">{</span></span>
<span id="cb15-8"><a href="back.html#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="back.html#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> AccountProfile <span class="fu">getProfile</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb15-10"><a href="back.html#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">(</span>AccountProfile<span class="op">)</span> SecurityUtils<span class="op">.</span><span class="fu">getSubject</span><span class="op">().</span><span class="fu">getPrincipal</span><span class="op">();</span></span>
<span id="cb15-11"><a href="back.html#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb15-12"><a href="back.html#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="back.html#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb16-1"><a href="back.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">;</span></span>
<span id="cb16-2"><a href="back.html#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="back.html#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb16-4"><a href="back.html#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Jwts</span><span class="op">;</span></span>
<span id="cb16-5"><a href="back.html#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">SignatureAlgorithm</span><span class="op">;</span></span>
<span id="cb16-6"><a href="back.html#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb16-7"><a href="back.html#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb16-8"><a href="back.html#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">boot</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">properties</span><span class="op">.</span><span class="im">ConfigurationProperties</span><span class="op">;</span></span>
<span id="cb16-9"><a href="back.html#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb16-10"><a href="back.html#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="back.html#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Date</span><span class="op">;</span></span>
<span id="cb16-12"><a href="back.html#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="back.html#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb16-14"><a href="back.html#cb16-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> jwt<span class="co">工具类</span></span>
<span id="cb16-15"><a href="back.html#cb16-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb16-16"><a href="back.html#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb16-17"><a href="back.html#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb16-18"><a href="back.html#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb16-19"><a href="back.html#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="at">@ConfigurationProperties</span><span class="op">(</span>prefix <span class="op">=</span> <span class="st">&quot;markerhub.jwt&quot;</span><span class="op">)</span></span>
<span id="cb16-20"><a href="back.html#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> JwtUtils <span class="op">{</span></span>
<span id="cb16-21"><a href="back.html#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="back.html#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> secret<span class="op">;</span></span>
<span id="cb16-23"><a href="back.html#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="back.html#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">long</span> expire<span class="op">;</span></span>
<span id="cb16-25"><a href="back.html#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="back.html#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> header<span class="op">;</span></span>
<span id="cb16-27"><a href="back.html#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="back.html#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb16-29"><a href="back.html#cb16-29" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">生成</span>jwt token</span>
<span id="cb16-30"><a href="back.html#cb16-30" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb16-31"><a href="back.html#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">generateToken</span><span class="op">(</span><span class="dt">long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-32"><a href="back.html#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Date</span> nowDate <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">();</span></span>
<span id="cb16-33"><a href="back.html#cb16-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">//过期时间</span></span>
<span id="cb16-34"><a href="back.html#cb16-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Date</span> expireDate <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span><span class="op">(</span>nowDate<span class="op">.</span><span class="fu">getTime</span><span class="op">()</span> <span class="op">+</span> expire <span class="op">*</span> <span class="dv">1000</span><span class="op">);</span></span>
<span id="cb16-35"><a href="back.html#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="back.html#cb16-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> Jwts<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb16-37"><a href="back.html#cb16-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setHeaderParam</span><span class="op">(</span><span class="st">&quot;typ&quot;</span><span class="op">,</span> <span class="st">&quot;JWT&quot;</span><span class="op">)</span></span>
<span id="cb16-38"><a href="back.html#cb16-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setSubject</span><span class="op">(</span>userId <span class="op">+</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb16-39"><a href="back.html#cb16-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setIssuedAt</span><span class="op">(</span>nowDate<span class="op">)</span></span>
<span id="cb16-40"><a href="back.html#cb16-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">setExpiration</span><span class="op">(</span>expireDate<span class="op">)</span></span>
<span id="cb16-41"><a href="back.html#cb16-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">signWith</span><span class="op">(</span>SignatureAlgorithm<span class="op">.</span><span class="fu">HS512</span><span class="op">,</span> secret<span class="op">)</span></span>
<span id="cb16-42"><a href="back.html#cb16-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">compact</span><span class="op">();</span></span>
<span id="cb16-43"><a href="back.html#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-44"><a href="back.html#cb16-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-45"><a href="back.html#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> Claims <span class="fu">getClaimByToken</span><span class="op">(</span><span class="bu">String</span> token<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-46"><a href="back.html#cb16-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb16-47"><a href="back.html#cb16-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> Jwts<span class="op">.</span><span class="fu">parser</span><span class="op">()</span></span>
<span id="cb16-48"><a href="back.html#cb16-48" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">setSigningKey</span><span class="op">(</span>secret<span class="op">)</span></span>
<span id="cb16-49"><a href="back.html#cb16-49" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">parseClaimsJws</span><span class="op">(</span>token<span class="op">)</span></span>
<span id="cb16-50"><a href="back.html#cb16-50" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">getBody</span><span class="op">();</span></span>
<span id="cb16-51"><a href="back.html#cb16-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">){</span></span>
<span id="cb16-52"><a href="back.html#cb16-52" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">debug</span><span class="op">(</span><span class="st">&quot;validate is token error &quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb16-53"><a href="back.html#cb16-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb16-54"><a href="back.html#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-55"><a href="back.html#cb16-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-56"><a href="back.html#cb16-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-57"><a href="back.html#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb16-58"><a href="back.html#cb16-58" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> token<span class="co">是否过期</span></span>
<span id="cb16-59"><a href="back.html#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>return  true<span class="co">：过期</span></span>
<span id="cb16-60"><a href="back.html#cb16-60" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb16-61"><a href="back.html#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">isTokenExpired</span><span class="op">(</span><span class="bu">Date</span> expiration<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-62"><a href="back.html#cb16-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> expiration<span class="op">.</span><span class="fu">before</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Date</span><span class="op">());</span></span>
<span id="cb16-63"><a href="back.html#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb16-64"><a href="back.html#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-65"><a href="back.html#cb16-65" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb17-1"><a href="back.html#cb17-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-2"><a href="back.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">;</span></span>
<span id="cb17-3"><a href="back.html#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="back.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">AuthenticationToken</span><span class="op">;</span></span>
<span id="cb17-5"><a href="back.html#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="back.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb17-7"><a href="back.html#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb17-8"><a href="back.html#cb17-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">8:04</span> PM</span>
<span id="cb17-9"><a href="back.html#cb17-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb17-10"><a href="back.html#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> JwtToken <span class="kw">implements</span> AuthenticationToken <span class="op">{</span></span>
<span id="cb17-11"><a href="back.html#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="back.html#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">String</span> token<span class="op">;</span></span>
<span id="cb17-13"><a href="back.html#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="back.html#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">JwtToken</span><span class="op">(</span><span class="bu">String</span> token<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-15"><a href="back.html#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">token</span> <span class="op">=</span> token<span class="op">;</span></span>
<span id="cb17-16"><a href="back.html#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-17"><a href="back.html#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="back.html#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb17-19"><a href="back.html#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">getPrincipal</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-20"><a href="back.html#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> token<span class="op">;</span></span>
<span id="cb17-21"><a href="back.html#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-22"><a href="back.html#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="back.html#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb17-24"><a href="back.html#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">getCredentials</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-25"><a href="back.html#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> token<span class="op">;</span></span>
<span id="cb17-26"><a href="back.html#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-27"><a href="back.html#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb18-1"><a href="back.html#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="back.html#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">;</span></span>
<span id="cb18-3"><a href="back.html#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="back.html#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">json</span><span class="op">.</span><span class="im">JSONUtil</span><span class="op">;</span></span>
<span id="cb18-5"><a href="back.html#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb18-6"><a href="back.html#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb18-7"><a href="back.html#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb18-8"><a href="back.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb18-9"><a href="back.html#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">AuthenticationException</span><span class="op">;</span></span>
<span id="cb18-10"><a href="back.html#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">AuthenticationToken</span><span class="op">;</span></span>
<span id="cb18-11"><a href="back.html#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">ExpiredCredentialsException</span><span class="op">;</span></span>
<span id="cb18-12"><a href="back.html#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">filter</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">AuthenticatingFilter</span><span class="op">;</span></span>
<span id="cb18-13"><a href="back.html#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">WebUtils</span><span class="op">;</span></span>
<span id="cb18-14"><a href="back.html#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb18-15"><a href="back.html#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb18-16"><a href="back.html#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">StringUtils</span><span class="op">;</span></span>
<span id="cb18-17"><a href="back.html#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequestMethod</span><span class="op">;</span></span>
<span id="cb18-18"><a href="back.html#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="back.html#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">ServletRequest</span><span class="op">;</span></span>
<span id="cb18-20"><a href="back.html#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">ServletResponse</span><span class="op">;</span></span>
<span id="cb18-21"><a href="back.html#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">http</span><span class="op">.</span><span class="im">HttpServletRequest</span><span class="op">;</span></span>
<span id="cb18-22"><a href="back.html#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">http</span><span class="op">.</span><span class="im">HttpServletResponse</span><span class="op">;</span></span>
<span id="cb18-23"><a href="back.html#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">IOException</span><span class="op">;</span></span>
<span id="cb18-24"><a href="back.html#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="back.html#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb18-26"><a href="back.html#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb18-27"><a href="back.html#cb18-27" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">5:58</span> PM</span>
<span id="cb18-28"><a href="back.html#cb18-28" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb18-29"><a href="back.html#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb18-30"><a href="back.html#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb18-31"><a href="back.html#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> JwtFilter <span class="kw">extends</span> AuthenticatingFilter <span class="op">{</span></span>
<span id="cb18-32"><a href="back.html#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="back.html#cb18-33" aria-hidden="true" tabindex="-1"></a>    JwtUtils jwtUtils<span class="op">;</span></span>
<span id="cb18-34"><a href="back.html#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="back.html#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb18-36"><a href="back.html#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtUtils jwtUtils<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-37"><a href="back.html#cb18-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtUtils</span> <span class="op">=</span> jwtUtils<span class="op">;</span></span>
<span id="cb18-38"><a href="back.html#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-39"><a href="back.html#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="back.html#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb18-41"><a href="back.html#cb18-41" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">执行</span>onAccessDenied<span class="co">时调用</span>executeLogin<span class="co">方法，完成登陆逻辑</span></span>
<span id="cb18-42"><a href="back.html#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param servletRequest</span>
<span id="cb18-43"><a href="back.html#cb18-43" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>param servletResponse</span>
<span id="cb18-44"><a href="back.html#cb18-44" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb18-45"><a href="back.html#cb18-45" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb18-46"><a href="back.html#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb18-47"><a href="back.html#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> AuthenticationToken <span class="fu">createToken</span><span class="op">(</span>ServletRequest servletRequest<span class="op">,</span> ServletResponse servletResponse<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-48"><a href="back.html#cb18-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 获取 token</span></span>
<span id="cb18-49"><a href="back.html#cb18-49" aria-hidden="true" tabindex="-1"></a>        HttpServletRequest request <span class="op">=</span> <span class="op">(</span>HttpServletRequest<span class="op">)</span> servletRequest<span class="op">;</span></span>
<span id="cb18-50"><a href="back.html#cb18-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> jwt <span class="op">=</span> request<span class="op">.</span><span class="fu">getHeader</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb18-51"><a href="back.html#cb18-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>StringUtils<span class="op">.</span><span class="fu">hasLength</span><span class="op">(</span>jwt<span class="op">))</span> <span class="op">{</span></span>
<span id="cb18-52"><a href="back.html#cb18-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb18-53"><a href="back.html#cb18-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb18-54"><a href="back.html#cb18-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">JwtToken</span><span class="op">(</span>jwt<span class="op">);</span></span>
<span id="cb18-55"><a href="back.html#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-56"><a href="back.html#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="back.html#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb18-58"><a href="back.html#cb18-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">boolean</span> <span class="fu">onAccessDenied</span><span class="op">(</span>ServletRequest servletRequest<span class="op">,</span> ServletResponse servletResponse<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb18-59"><a href="back.html#cb18-59" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入拦截器&quot;</span><span class="op">);</span></span>
<span id="cb18-60"><a href="back.html#cb18-60" aria-hidden="true" tabindex="-1"></a>        HttpServletRequest request <span class="op">=</span> <span class="op">(</span>HttpServletRequest<span class="op">)</span> servletRequest<span class="op">;</span></span>
<span id="cb18-61"><a href="back.html#cb18-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> token <span class="op">=</span> request<span class="op">.</span><span class="fu">getHeader</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb18-62"><a href="back.html#cb18-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>StringUtils<span class="op">.</span><span class="fu">hasLength</span><span class="op">(</span>token<span class="op">))</span> <span class="op">{</span></span>
<span id="cb18-63"><a href="back.html#cb18-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb18-64"><a href="back.html#cb18-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb18-65"><a href="back.html#cb18-65" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 教验jwt</span></span>
<span id="cb18-66"><a href="back.html#cb18-66" aria-hidden="true" tabindex="-1"></a>            Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb18-67"><a href="back.html#cb18-67" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 判断是否已过期</span></span>
<span id="cb18-68"><a href="back.html#cb18-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>claim <span class="op">==</span> <span class="kw">null</span> <span class="op">||</span> jwtUtils<span class="op">.</span><span class="fu">isTokenExpired</span><span class="op">(</span>claim<span class="op">.</span><span class="fu">getExpiration</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb18-69"><a href="back.html#cb18-69" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;token失效&quot;</span><span class="op">);</span></span>
<span id="cb18-70"><a href="back.html#cb18-70" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ExpiredCredentialsException</span><span class="op">(</span><span class="st">&quot;token expired&quot;</span><span class="op">);</span></span>
<span id="cb18-71"><a href="back.html#cb18-71" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb18-72"><a href="back.html#cb18-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb18-73"><a href="back.html#cb18-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 执行自动登录</span></span>
<span id="cb18-74"><a href="back.html#cb18-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">executeLogin</span><span class="op">(</span>servletRequest<span class="op">,</span> servletResponse<span class="op">);</span></span>
<span id="cb18-75"><a href="back.html#cb18-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-76"><a href="back.html#cb18-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb18-77"><a href="back.html#cb18-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">boolean</span> <span class="fu">onLoginFailure</span><span class="op">(</span>AuthenticationToken token<span class="op">,</span> <span class="bu">AuthenticationException</span> e<span class="op">,</span> ServletRequest request<span class="op">,</span> ServletResponse response<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-78"><a href="back.html#cb18-78" aria-hidden="true" tabindex="-1"></a>        HttpServletResponse httpResponse <span class="op">=</span> <span class="op">(</span>HttpServletResponse<span class="op">)</span> response<span class="op">;</span></span>
<span id="cb18-79"><a href="back.html#cb18-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb18-80"><a href="back.html#cb18-80" aria-hidden="true" tabindex="-1"></a>            <span class="co">//处理登录失败的异常</span></span>
<span id="cb18-81"><a href="back.html#cb18-81" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Throwable</span> throwable <span class="op">=</span> e<span class="op">.</span><span class="fu">getCause</span><span class="op">()</span> <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> e <span class="op">:</span> e<span class="op">.</span><span class="fu">getCause</span><span class="op">();</span></span>
<span id="cb18-82"><a href="back.html#cb18-82" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Result</span> r <span class="op">=</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span>throwable<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb18-83"><a href="back.html#cb18-83" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> json <span class="op">=</span> JSONUtil<span class="op">.</span><span class="fu">toJsonStr</span><span class="op">(</span>r<span class="op">);</span></span>
<span id="cb18-84"><a href="back.html#cb18-84" aria-hidden="true" tabindex="-1"></a>            httpResponse<span class="op">.</span><span class="fu">getWriter</span><span class="op">().</span><span class="fu">print</span><span class="op">(</span>json<span class="op">);</span></span>
<span id="cb18-85"><a href="back.html#cb18-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> ignored<span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-86"><a href="back.html#cb18-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb18-87"><a href="back.html#cb18-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb18-88"><a href="back.html#cb18-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-89"><a href="back.html#cb18-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb18-90"><a href="back.html#cb18-90" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">对跨域提供支持</span></span>
<span id="cb18-91"><a href="back.html#cb18-91" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb18-92"><a href="back.html#cb18-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb18-93"><a href="back.html#cb18-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">boolean</span> <span class="fu">preHandle</span><span class="op">(</span>ServletRequest request<span class="op">,</span> ServletResponse response<span class="op">)</span> <span class="kw">throws</span> <span class="bu">Exception</span> <span class="op">{</span></span>
<span id="cb18-94"><a href="back.html#cb18-94" aria-hidden="true" tabindex="-1"></a>        HttpServletRequest httpServletRequest <span class="op">=</span> WebUtils<span class="op">.</span><span class="fu">toHttp</span><span class="op">(</span>request<span class="op">);</span></span>
<span id="cb18-95"><a href="back.html#cb18-95" aria-hidden="true" tabindex="-1"></a>        HttpServletResponse httpServletResponse <span class="op">=</span> WebUtils<span class="op">.</span><span class="fu">toHttp</span><span class="op">(</span>response<span class="op">);</span></span>
<span id="cb18-96"><a href="back.html#cb18-96" aria-hidden="true" tabindex="-1"></a>        httpServletResponse<span class="op">.</span><span class="fu">setHeader</span><span class="op">(</span><span class="st">&quot;Access-control-Allow-Origin&quot;</span><span class="op">,</span> httpServletRequest<span class="op">.</span><span class="fu">getHeader</span><span class="op">(</span><span class="st">&quot;Origin&quot;</span><span class="op">));</span></span>
<span id="cb18-97"><a href="back.html#cb18-97" aria-hidden="true" tabindex="-1"></a>        httpServletResponse<span class="op">.</span><span class="fu">setHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Allow-Methods&quot;</span><span class="op">,</span> <span class="st">&quot;GET,POST,OPTIONS,PUT,DELETE&quot;</span><span class="op">);</span></span>
<span id="cb18-98"><a href="back.html#cb18-98" aria-hidden="true" tabindex="-1"></a>        httpServletResponse<span class="op">.</span><span class="fu">setHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Allow-Headers&quot;</span><span class="op">,</span> httpServletRequest<span class="op">.</span><span class="fu">getHeader</span><span class="op">(</span><span class="st">&quot;Access-Control-Request-Headers&quot;</span><span class="op">));</span></span>
<span id="cb18-99"><a href="back.html#cb18-99" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 跨域时会首先发送一个OPTIONS请求，这里我们给OPTIONS请求直接返回正常状态</span></span>
<span id="cb18-100"><a href="back.html#cb18-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>httpServletRequest<span class="op">.</span><span class="fu">getMethod</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span>RequestMethod<span class="op">.</span><span class="fu">OPTIONS</span><span class="op">.</span><span class="fu">name</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb18-101"><a href="back.html#cb18-101" aria-hidden="true" tabindex="-1"></a>            httpServletResponse<span class="op">.</span><span class="fu">setStatus</span><span class="op">(</span>org<span class="op">.</span><span class="fu">springframework</span><span class="op">.</span><span class="fu">http</span><span class="op">.</span><span class="fu">HttpStatus</span><span class="op">.</span><span class="fu">OK</span><span class="op">.</span><span class="fu">value</span><span class="op">());</span></span>
<span id="cb18-102"><a href="back.html#cb18-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb18-103"><a href="back.html#cb18-103" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb18-104"><a href="back.html#cb18-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">super</span><span class="op">.</span><span class="fu">preHandle</span><span class="op">(</span>request<span class="op">,</span> response<span class="op">);</span></span>
<span id="cb18-105"><a href="back.html#cb18-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-106"><a href="back.html#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb19-1"><a href="back.html#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="back.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">;</span></span>
<span id="cb19-3"><a href="back.html#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="back.html#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb19-5"><a href="back.html#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="back.html#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb19-7"><a href="back.html#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="back.html#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb19-9"><a href="back.html#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb19-10"><a href="back.html#cb19-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">9:16</span> PM</span>
<span id="cb19-11"><a href="back.html#cb19-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb19-12"><a href="back.html#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb19-13"><a href="back.html#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AccountProfile <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb19-14"><a href="back.html#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="back.html#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">long</span> serialVersionUID <span class="op">=</span> <span class="op">-</span><span class="dv">3207880482640325843L</span><span class="op">;</span></span>
<span id="cb19-16"><a href="back.html#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="back.html#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb19-18"><a href="back.html#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="back.html#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> username<span class="op">;</span></span>
<span id="cb19-20"><a href="back.html#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="back.html#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> avatar<span class="op">;</span></span>
<span id="cb19-22"><a href="back.html#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="back.html#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> email<span class="op">;</span></span>
<span id="cb19-24"><a href="back.html#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="back.html#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-26"><a href="back.html#cb19-26" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>核心是Realm:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb20-1"><a href="back.html#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="back.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">;</span></span>
<span id="cb20-3"><a href="back.html#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="back.html#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">bean</span><span class="op">.</span><span class="im">BeanUtil</span><span class="op">;</span></span>
<span id="cb20-5"><a href="back.html#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryWrapper</span><span class="op">;</span></span>
<span id="cb20-6"><a href="back.html#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">ObjectMapper</span><span class="op">;</span></span>
<span id="cb20-7"><a href="back.html#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Const</span><span class="op">;</span></span>
<span id="cb20-8"><a href="back.html#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb20-9"><a href="back.html#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb20-10"><a href="back.html#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb20-11"><a href="back.html#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">MyUtils</span><span class="op">;</span></span>
<span id="cb20-12"><a href="back.html#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb20-13"><a href="back.html#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb20-14"><a href="back.html#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.*;</span></span>
<span id="cb20-15"><a href="back.html#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">AuthorizationInfo</span><span class="op">;</span></span>
<span id="cb20-16"><a href="back.html#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">SimpleAuthorizationInfo</span><span class="op">;</span></span>
<span id="cb20-17"><a href="back.html#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">realm</span><span class="op">.</span><span class="im">AuthorizingRealm</span><span class="op">;</span></span>
<span id="cb20-18"><a href="back.html#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">subject</span><span class="op">.</span><span class="im">PrincipalCollection</span><span class="op">;</span></span>
<span id="cb20-19"><a href="back.html#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb20-20"><a href="back.html#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb20-21"><a href="back.html#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb20-22"><a href="back.html#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="back.html#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">HashMap</span><span class="op">;</span></span>
<span id="cb20-24"><a href="back.html#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">LinkedHashMap</span><span class="op">;</span></span>
<span id="cb20-25"><a href="back.html#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">TimeUnit</span><span class="op">;</span></span>
<span id="cb20-26"><a href="back.html#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="back.html#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="back.html#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="back.html#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb20-30"><a href="back.html#cb20-30" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb20-31"><a href="back.html#cb20-31" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">5:44</span> PM</span>
<span id="cb20-32"><a href="back.html#cb20-32" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb20-33"><a href="back.html#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb20-34"><a href="back.html#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb20-35"><a href="back.html#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AccountRealm <span class="kw">extends</span> AuthorizingRealm <span class="op">{</span></span>
<span id="cb20-36"><a href="back.html#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="back.html#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="back.html#cb20-38" aria-hidden="true" tabindex="-1"></a>    UserService userService<span class="op">;</span></span>
<span id="cb20-39"><a href="back.html#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="back.html#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb20-41"><a href="back.html#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setUserServiceImpl</span><span class="op">(</span>UserService userService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-42"><a href="back.html#cb20-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userService</span> <span class="op">=</span> userService<span class="op">;</span></span>
<span id="cb20-43"><a href="back.html#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-44"><a href="back.html#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="back.html#cb20-45" aria-hidden="true" tabindex="-1"></a>    RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb20-46"><a href="back.html#cb20-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-47"><a href="back.html#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb20-48"><a href="back.html#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setRedisTemplateImpl</span><span class="op">(</span>RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-49"><a href="back.html#cb20-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">redisTemplate</span> <span class="op">=</span> redisTemplate<span class="op">;</span></span>
<span id="cb20-50"><a href="back.html#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-51"><a href="back.html#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="back.html#cb20-52" aria-hidden="true" tabindex="-1"></a>    JwtUtils jwtUtils<span class="op">;</span></span>
<span id="cb20-53"><a href="back.html#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="back.html#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb20-55"><a href="back.html#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtUtils jwtUtils<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-56"><a href="back.html#cb20-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtUtils</span> <span class="op">=</span> jwtUtils<span class="op">;</span></span>
<span id="cb20-57"><a href="back.html#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-58"><a href="back.html#cb20-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-59"><a href="back.html#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb20-60"><a href="back.html#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">supports</span><span class="op">(</span>AuthenticationToken token<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-61"><a href="back.html#cb20-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> token <span class="kw">instanceof</span> JwtToken<span class="op">;</span></span>
<span id="cb20-62"><a href="back.html#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-63"><a href="back.html#cb20-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-64"><a href="back.html#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb20-65"><a href="back.html#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> AuthorizationInfo <span class="fu">doGetAuthorizationInfo</span><span class="op">(</span>PrincipalCollection principals<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-66"><a href="back.html#cb20-66" aria-hidden="true" tabindex="-1"></a>        AccountProfile accountProfile <span class="op">=</span> <span class="op">(</span>AccountProfile<span class="op">)</span>principals<span class="op">.</span><span class="fu">getPrimaryPrincipal</span><span class="op">();</span></span>
<span id="cb20-67"><a href="back.html#cb20-67" aria-hidden="true" tabindex="-1"></a>        SimpleAuthorizationInfo info <span class="op">=</span> <span class="kw">new</span> <span class="fu">SimpleAuthorizationInfo</span><span class="op">();</span></span>
<span id="cb20-68"><a href="back.html#cb20-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Long</span> id <span class="op">=</span> accountProfile<span class="op">.</span><span class="fu">getId</span><span class="op">();</span></span>
<span id="cb20-69"><a href="back.html#cb20-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-70"><a href="back.html#cb20-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-71"><a href="back.html#cb20-71" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;开始授权&quot;</span><span class="op">);</span></span>
<span id="cb20-72"><a href="back.html#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="back.html#cb20-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> role<span class="op">;</span></span>
<span id="cb20-74"><a href="back.html#cb20-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="bu">Boolean</span><span class="op">.</span><span class="fu">TRUE</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">hasKey</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">ROLE_PREFIX</span> <span class="op">+</span> id<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb20-75"><a href="back.html#cb20-75" aria-hidden="true" tabindex="-1"></a>            role <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">ROLE_PREFIX</span> <span class="op">+</span> id<span class="op">);</span></span>
<span id="cb20-76"><a href="back.html#cb20-76" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb20-77"><a href="back.html#cb20-77" aria-hidden="true" tabindex="-1"></a>            role <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> userService<span class="op">.</span><span class="fu">getBaseMapper</span><span class="op">().</span><span class="fu">selectObjs</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">).</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">)).</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb20-78"><a href="back.html#cb20-78" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">ROLE_PREFIX</span> <span class="op">+</span> id<span class="op">,</span> role<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">MINUTES</span><span class="op">);</span></span>
<span id="cb20-79"><a href="back.html#cb20-79" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb20-80"><a href="back.html#cb20-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-81"><a href="back.html#cb20-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>role <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-82"><a href="back.html#cb20-82" aria-hidden="true" tabindex="-1"></a>            info<span class="op">.</span><span class="fu">addRole</span><span class="op">(</span>role<span class="op">);</span></span>
<span id="cb20-83"><a href="back.html#cb20-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb20-84"><a href="back.html#cb20-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-85"><a href="back.html#cb20-85" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;结束授权&quot;</span><span class="op">);</span></span>
<span id="cb20-86"><a href="back.html#cb20-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-87"><a href="back.html#cb20-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> info<span class="op">;</span></span>
<span id="cb20-88"><a href="back.html#cb20-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-89"><a href="back.html#cb20-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-90"><a href="back.html#cb20-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb20-91"><a href="back.html#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> AuthenticationInfo <span class="fu">doGetAuthenticationInfo</span><span class="op">(</span>AuthenticationToken token<span class="op">)</span> <span class="kw">throws</span> <span class="bu">AuthenticationException</span> <span class="op">{</span></span>
<span id="cb20-92"><a href="back.html#cb20-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-93"><a href="back.html#cb20-93" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入realm&quot;</span><span class="op">);</span></span>
<span id="cb20-94"><a href="back.html#cb20-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-95"><a href="back.html#cb20-95" aria-hidden="true" tabindex="-1"></a>        JwtToken jwtToken <span class="op">=</span> <span class="op">(</span>JwtToken<span class="op">)</span> token<span class="op">;</span></span>
<span id="cb20-96"><a href="back.html#cb20-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-97"><a href="back.html#cb20-97" aria-hidden="true" tabindex="-1"></a>        Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> jwtToken<span class="op">.</span><span class="fu">getCredentials</span><span class="op">());</span></span>
<span id="cb20-98"><a href="back.html#cb20-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> userId <span class="op">=</span> claim<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb20-99"><a href="back.html#cb20-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-100"><a href="back.html#cb20-100" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> originToken<span class="op">;</span></span>
<span id="cb20-101"><a href="back.html#cb20-101" aria-hidden="true" tabindex="-1"></a>        User myUser<span class="op">;</span></span>
<span id="cb20-102"><a href="back.html#cb20-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-103"><a href="back.html#cb20-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">//监控用户登录状态，误差时间10分钟</span></span>
<span id="cb20-104"><a href="back.html#cb20-104" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;即将进入redis&quot;</span><span class="op">);</span></span>
<span id="cb20-105"><a href="back.html#cb20-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="bu">Boolean</span><span class="op">.</span><span class="fu">FALSE</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">hasKey</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">)))</span> <span class="op">{</span><span class="co">//如果缓存里的信息过期，就重新往里写</span></span>
<span id="cb20-106"><a href="back.html#cb20-106" aria-hidden="true" tabindex="-1"></a>            User user <span class="op">=</span> userService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>userId<span class="op">);</span></span>
<span id="cb20-107"><a href="back.html#cb20-107" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> myToken <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> jwtToken<span class="op">.</span><span class="fu">getCredentials</span><span class="op">();</span></span>
<span id="cb20-108"><a href="back.html#cb20-108" aria-hidden="true" tabindex="-1"></a>            <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb20-109"><a href="back.html#cb20-109" aria-hidden="true" tabindex="-1"></a>            map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_OBJECT</span><span class="op">,</span> user<span class="op">);</span></span>
<span id="cb20-110"><a href="back.html#cb20-110" aria-hidden="true" tabindex="-1"></a>            map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">TOKEN</span><span class="op">,</span> myToken<span class="op">);</span></span>
<span id="cb20-111"><a href="back.html#cb20-111" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">putAll</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">,</span> map<span class="op">);</span></span>
<span id="cb20-112"><a href="back.html#cb20-112" aria-hidden="true" tabindex="-1"></a>            <span class="co">//续10分钟</span></span>
<span id="cb20-113"><a href="back.html#cb20-113" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">,</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">60</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">);</span></span>
<span id="cb20-114"><a href="back.html#cb20-114" aria-hidden="true" tabindex="-1"></a>            originToken <span class="op">=</span> myToken<span class="op">;</span></span>
<span id="cb20-115"><a href="back.html#cb20-115" aria-hidden="true" tabindex="-1"></a>            myUser <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb20-116"><a href="back.html#cb20-116" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span><span class="co">//如果缓存里的信息没有过期，就续10分钟，然后读取缓存中的user判断，此时包含用户被踢下线的情况</span></span>
<span id="cb20-117"><a href="back.html#cb20-117" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">,</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">60</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">);</span></span>
<span id="cb20-118"><a href="back.html#cb20-118" aria-hidden="true" tabindex="-1"></a>            <span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> userInfo <span class="op">=</span> <span class="op">(</span><span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;)</span> redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">,</span> Const<span class="op">.</span><span class="fu">USER_OBJECT</span><span class="op">);</span></span>
<span id="cb20-119"><a href="back.html#cb20-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-120"><a href="back.html#cb20-120" aria-hidden="true" tabindex="-1"></a>            ObjectMapper objectMapper <span class="op">=</span> <span class="kw">new</span> <span class="fu">ObjectMapper</span><span class="op">();</span></span>
<span id="cb20-121"><a href="back.html#cb20-121" aria-hidden="true" tabindex="-1"></a>            User user <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">convertValue</span><span class="op">(</span>userInfo<span class="op">,</span> User<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb20-122"><a href="back.html#cb20-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-123"><a href="back.html#cb20-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>user <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-124"><a href="back.html#cb20-124" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">UnknownAccountException</span><span class="op">(</span><span class="st">&quot;account not exist&quot;</span><span class="op">);</span></span>
<span id="cb20-125"><a href="back.html#cb20-125" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb20-126"><a href="back.html#cb20-126" aria-hidden="true" tabindex="-1"></a>            originToken <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">,</span> Const<span class="op">.</span><span class="fu">TOKEN</span><span class="op">);</span></span>
<span id="cb20-127"><a href="back.html#cb20-127" aria-hidden="true" tabindex="-1"></a>            myUser <span class="op">=</span> user<span class="op">;</span></span>
<span id="cb20-128"><a href="back.html#cb20-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb20-129"><a href="back.html#cb20-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-130"><a href="back.html#cb20-130" aria-hidden="true" tabindex="-1"></a>        AccountProfile profile <span class="op">=</span> <span class="kw">new</span> <span class="fu">AccountProfile</span><span class="op">();</span></span>
<span id="cb20-131"><a href="back.html#cb20-131" aria-hidden="true" tabindex="-1"></a>        BeanUtil<span class="op">.</span><span class="fu">copyProperties</span><span class="op">(</span>myUser<span class="op">,</span> profile<span class="op">);</span></span>
<span id="cb20-132"><a href="back.html#cb20-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-133"><a href="back.html#cb20-133" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;成功执行redis&quot;</span><span class="op">);</span></span>
<span id="cb20-134"><a href="back.html#cb20-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-135"><a href="back.html#cb20-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">SimpleAuthenticationInfo</span><span class="op">(</span>profile<span class="op">,</span> originToken<span class="op">,</span> <span class="fu">getName</span><span class="op">());</span></span>
<span id="cb20-136"><a href="back.html#cb20-136" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-137"><a href="back.html#cb20-137" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-138"><a href="back.html#cb20-138" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>我这里还做了一个踢人的功能。初步想法是，jwt是无状态的，所以服务器没有session，于是就无法对登录的用户进行统一管理。就算服务器宕机了，重启以后之前的登录状态仍然是有效的。我把用户的token放到缓存里了，一方面过过滤器的时候可以快一些，另一方面就是可以对用户登录状态进行管理了。</p>
</div>
<div id="controller" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> controller</h2>
<div class="sourceCode" id="cb21"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb21-1"><a href="back.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb21-2"><a href="back.html#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="back.html#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">UUID</span><span class="op">;</span></span>
<span id="cb21-4"><a href="back.html#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">map</span><span class="op">.</span><span class="im">MapUtil</span><span class="op">;</span></span>
<span id="cb21-5"><a href="back.html#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">crypto</span><span class="op">.</span><span class="im">SecureUtil</span><span class="op">;</span></span>
<span id="cb21-6"><a href="back.html#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryWrapper</span><span class="op">;</span></span>
<span id="cb21-7"><a href="back.html#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">update</span><span class="op">.</span><span class="im">UpdateWrapper</span><span class="op">;</span></span>
<span id="cb21-8"><a href="back.html#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">toolkit</span><span class="op">.</span><span class="im">StringUtils</span><span class="op">;</span></span>
<span id="cb21-9"><a href="back.html#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">google</span><span class="op">.</span><span class="im">code</span><span class="op">.</span><span class="im">kaptcha</span><span class="op">.</span><span class="im">Producer</span><span class="op">;</span></span>
<span id="cb21-10"><a href="back.html#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">dto</span><span class="op">.</span><span class="im">LoginDto</span><span class="op">;</span></span>
<span id="cb21-11"><a href="back.html#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Const</span><span class="op">;</span></span>
<span id="cb21-12"><a href="back.html#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb21-13"><a href="back.html#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb21-14"><a href="back.html#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb21-15"><a href="back.html#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb21-16"><a href="back.html#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb21-17"><a href="back.html#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb21-18"><a href="back.html#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">SecurityUtils</span><span class="op">;</span></span>
<span id="cb21-19"><a href="back.html#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresAuthentication</span><span class="op">;</span></span>
<span id="cb21-20"><a href="back.html#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb21-21"><a href="back.html#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb21-22"><a href="back.html#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Assert</span><span class="op">;</span></span>
<span id="cb21-23"><a href="back.html#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Validated</span><span class="op">;</span></span>
<span id="cb21-24"><a href="back.html#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">GetMapping</span><span class="op">;</span></span>
<span id="cb21-25"><a href="back.html#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">PostMapping</span><span class="op">;</span></span>
<span id="cb21-26"><a href="back.html#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequestBody</span><span class="op">;</span></span>
<span id="cb21-27"><a href="back.html#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RestController</span><span class="op">;</span></span>
<span id="cb21-28"><a href="back.html#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="back.html#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">imageio</span><span class="op">.</span><span class="im">ImageIO</span><span class="op">;</span></span>
<span id="cb21-30"><a href="back.html#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">ServletRequest</span><span class="op">;</span></span>
<span id="cb21-31"><a href="back.html#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">http</span><span class="op">.</span><span class="im">HttpServletRequest</span><span class="op">;</span></span>
<span id="cb21-32"><a href="back.html#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">http</span><span class="op">.</span><span class="im">HttpServletResponse</span><span class="op">;</span></span>
<span id="cb21-33"><a href="back.html#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">awt</span><span class="op">.</span><span class="im">image</span><span class="op">.</span><span class="im">BufferedImage</span><span class="op">;</span></span>
<span id="cb21-34"><a href="back.html#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">ByteArrayOutputStream</span><span class="op">;</span></span>
<span id="cb21-35"><a href="back.html#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">IOException</span><span class="op">;</span></span>
<span id="cb21-36"><a href="back.html#cb21-36" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">LocalDateTime</span><span class="op">;</span></span>
<span id="cb21-37"><a href="back.html#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Base64</span><span class="op">;</span></span>
<span id="cb21-38"><a href="back.html#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">HashMap</span><span class="op">;</span></span>
<span id="cb21-39"><a href="back.html#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">TimeUnit</span><span class="op">;</span></span>
<span id="cb21-40"><a href="back.html#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="back.html#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb21-42"><a href="back.html#cb21-42" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">登录相关</span></span>
<span id="cb21-43"><a href="back.html#cb21-43" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb21-44"><a href="back.html#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb21-45"><a href="back.html#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb21-46"><a href="back.html#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AccountController <span class="op">{</span></span>
<span id="cb21-47"><a href="back.html#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="back.html#cb21-48" aria-hidden="true" tabindex="-1"></a>    Producer producer<span class="op">;</span></span>
<span id="cb21-49"><a href="back.html#cb21-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-50"><a href="back.html#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb21-51"><a href="back.html#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setProducer</span><span class="op">(</span>Producer producer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-52"><a href="back.html#cb21-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">producer</span> <span class="op">=</span> producer<span class="op">;</span></span>
<span id="cb21-53"><a href="back.html#cb21-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-54"><a href="back.html#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="back.html#cb21-55" aria-hidden="true" tabindex="-1"></a>    UserService userService<span class="op">;</span></span>
<span id="cb21-56"><a href="back.html#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="back.html#cb21-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb21-58"><a href="back.html#cb21-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setUserServiceImpl</span><span class="op">(</span>UserService userService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-59"><a href="back.html#cb21-59" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userService</span> <span class="op">=</span> userService<span class="op">;</span></span>
<span id="cb21-60"><a href="back.html#cb21-60" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-61"><a href="back.html#cb21-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-62"><a href="back.html#cb21-62" aria-hidden="true" tabindex="-1"></a>    JwtUtils jwtUtils<span class="op">;</span></span>
<span id="cb21-63"><a href="back.html#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="back.html#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb21-65"><a href="back.html#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtUtils jwtUtils<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-66"><a href="back.html#cb21-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtUtils</span> <span class="op">=</span> jwtUtils<span class="op">;</span></span>
<span id="cb21-67"><a href="back.html#cb21-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-68"><a href="back.html#cb21-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-69"><a href="back.html#cb21-69" aria-hidden="true" tabindex="-1"></a>    RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb21-70"><a href="back.html#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="back.html#cb21-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb21-72"><a href="back.html#cb21-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setRedisTemplateImpl</span><span class="op">(</span>RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-73"><a href="back.html#cb21-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">redisTemplate</span> <span class="op">=</span> redisTemplate<span class="op">;</span></span>
<span id="cb21-74"><a href="back.html#cb21-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-75"><a href="back.html#cb21-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-76"><a href="back.html#cb21-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/login&quot;</span><span class="op">)</span></span>
<span id="cb21-77"><a href="back.html#cb21-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">login</span><span class="op">(</span><span class="at">@Validated</span> <span class="at">@RequestBody</span> LoginDto loginDto<span class="op">,</span> HttpServletResponse response<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-78"><a href="back.html#cb21-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-79"><a href="back.html#cb21-79" aria-hidden="true" tabindex="-1"></a>       <span class="bu">String</span> code <span class="op">=</span> loginDto<span class="op">.</span><span class="fu">getCode</span><span class="op">();</span></span>
<span id="cb21-80"><a href="back.html#cb21-80" aria-hidden="true" tabindex="-1"></a>       <span class="bu">String</span> key <span class="op">=</span> loginDto<span class="op">.</span><span class="fu">getToken</span><span class="op">();</span></span>
<span id="cb21-81"><a href="back.html#cb21-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-82"><a href="back.html#cb21-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>StringUtils<span class="op">.</span><span class="fu">isBlank</span><span class="op">(</span>code<span class="op">)</span> <span class="op">||</span> StringUtils<span class="op">.</span><span class="fu">isBlank</span><span class="op">(</span>key<span class="op">))</span> <span class="op">{</span></span>
<span id="cb21-83"><a href="back.html#cb21-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;验证码无效&quot;</span><span class="op">);</span></span>
<span id="cb21-84"><a href="back.html#cb21-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-85"><a href="back.html#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="back.html#cb21-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>code<span class="op">.</span><span class="fu">equals</span><span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">CAPTCHA_KEY</span> <span class="op">+</span> <span class="st">&quot;:&quot;</span> <span class="op">+</span> key<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb21-87"><a href="back.html#cb21-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;验证码错误&quot;</span><span class="op">);</span></span>
<span id="cb21-88"><a href="back.html#cb21-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-89"><a href="back.html#cb21-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-90"><a href="back.html#cb21-90" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">CAPTCHA_KEY</span> <span class="op">+</span> key<span class="op">);</span></span>
<span id="cb21-91"><a href="back.html#cb21-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-92"><a href="back.html#cb21-92" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userService<span class="op">.</span><span class="fu">getOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">,</span> loginDto<span class="op">.</span><span class="fu">getUsername</span><span class="op">()));</span></span>
<span id="cb21-93"><a href="back.html#cb21-93" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">notNull</span><span class="op">(</span>user<span class="op">,</span> <span class="st">&quot;用户不存在&quot;</span><span class="op">);</span></span>
<span id="cb21-94"><a href="back.html#cb21-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-95"><a href="back.html#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="back.html#cb21-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>user<span class="op">.</span><span class="fu">getStatus</span><span class="op">()</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-97"><a href="back.html#cb21-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;账号已停用&quot;</span><span class="op">);</span></span>
<span id="cb21-98"><a href="back.html#cb21-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-99"><a href="back.html#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-100"><a href="back.html#cb21-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(!</span>user<span class="op">.</span><span class="fu">getPassword</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span>SecureUtil<span class="op">.</span><span class="fu">md5</span><span class="op">(</span>loginDto<span class="op">.</span><span class="fu">getPassword</span><span class="op">()))){</span></span>
<span id="cb21-101"><a href="back.html#cb21-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;密码不正确&quot;</span><span class="op">);</span></span>
<span id="cb21-102"><a href="back.html#cb21-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-103"><a href="back.html#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="back.html#cb21-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> jwt <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">generateToken</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb21-105"><a href="back.html#cb21-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-106"><a href="back.html#cb21-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="bu">Boolean</span><span class="op">.</span><span class="fu">TRUE</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">hasKey</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">()))</span> <span class="op">&amp;&amp;</span> user<span class="op">.</span><span class="fu">getStatus</span><span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-107"><a href="back.html#cb21-107" aria-hidden="true" tabindex="-1"></a>             <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;用户已登录&quot;</span><span class="op">);</span></span>
<span id="cb21-108"><a href="back.html#cb21-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb21-109"><a href="back.html#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="back.html#cb21-110" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">setHeader</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">,</span> jwt<span class="op">);</span></span>
<span id="cb21-111"><a href="back.html#cb21-111" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">setHeader</span><span class="op">(</span><span class="st">&quot;Access-control-Expose-Headers&quot;</span><span class="op">,</span> <span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb21-112"><a href="back.html#cb21-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-113"><a href="back.html#cb21-113" aria-hidden="true" tabindex="-1"></a>        <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb21-114"><a href="back.html#cb21-114" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_OBJECT</span><span class="op">,</span> user<span class="op">);</span></span>
<span id="cb21-115"><a href="back.html#cb21-115" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">TOKEN</span><span class="op">,</span> jwt<span class="op">);</span></span>
<span id="cb21-116"><a href="back.html#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="back.html#cb21-117" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">putAll</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">().</span><span class="fu">toString</span><span class="op">(),</span> map<span class="op">);</span></span>
<span id="cb21-118"><a href="back.html#cb21-118" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">().</span><span class="fu">toString</span><span class="op">(),</span> <span class="dv">15</span> <span class="op">*</span> <span class="dv">60</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">);</span></span>
<span id="cb21-119"><a href="back.html#cb21-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-120"><a href="back.html#cb21-120" aria-hidden="true" tabindex="-1"></a>        userService<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="kw">new</span> UpdateWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;last_login&quot;</span><span class="op">,</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">()).</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">()));</span></span>
<span id="cb21-121"><a href="back.html#cb21-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-122"><a href="back.html#cb21-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>MapUtil<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb21-123"><a href="back.html#cb21-123" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb21-124"><a href="back.html#cb21-124" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getUsername</span><span class="op">())</span></span>
<span id="cb21-125"><a href="back.html#cb21-125" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;avatar&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getAvatar</span><span class="op">())</span></span>
<span id="cb21-126"><a href="back.html#cb21-126" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;email&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getEmail</span><span class="op">())</span></span>
<span id="cb21-127"><a href="back.html#cb21-127" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span><span class="op">()</span></span>
<span id="cb21-128"><a href="back.html#cb21-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb21-129"><a href="back.html#cb21-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-130"><a href="back.html#cb21-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-131"><a href="back.html#cb21-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb21-132"><a href="back.html#cb21-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/logout&quot;</span><span class="op">)</span></span>
<span id="cb21-133"><a href="back.html#cb21-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">logout</span><span class="op">(</span>ServletRequest servletRequest<span class="op">)</span> <span class="op">{</span></span>
<span id="cb21-134"><a href="back.html#cb21-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-135"><a href="back.html#cb21-135" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入退出登录方法&quot;</span><span class="op">);</span></span>
<span id="cb21-136"><a href="back.html#cb21-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-137"><a href="back.html#cb21-137" aria-hidden="true" tabindex="-1"></a>        HttpServletRequest request <span class="op">=</span> <span class="op">(</span>HttpServletRequest<span class="op">)</span> servletRequest<span class="op">;</span></span>
<span id="cb21-138"><a href="back.html#cb21-138" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> token <span class="op">=</span> request<span class="op">.</span><span class="fu">getHeader</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb21-139"><a href="back.html#cb21-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-140"><a href="back.html#cb21-140" aria-hidden="true" tabindex="-1"></a>        Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb21-141"><a href="back.html#cb21-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> userId <span class="op">=</span> claim<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb21-142"><a href="back.html#cb21-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-143"><a href="back.html#cb21-143" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Boolean</span> delete <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> userId<span class="op">);</span></span>
<span id="cb21-144"><a href="back.html#cb21-144" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span><span class="bu">Boolean</span><span class="op">.</span><span class="fu">TRUE</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>delete<span class="op">),</span> <span class="st">&quot;退出登录失败&quot;</span><span class="op">);</span></span>
<span id="cb21-145"><a href="back.html#cb21-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-146"><a href="back.html#cb21-146" aria-hidden="true" tabindex="-1"></a>        SecurityUtils<span class="op">.</span><span class="fu">getSubject</span><span class="op">().</span><span class="fu">logout</span><span class="op">();</span></span>
<span id="cb21-147"><a href="back.html#cb21-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb21-148"><a href="back.html#cb21-148" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-149"><a href="back.html#cb21-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-150"><a href="back.html#cb21-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/captcha&quot;</span><span class="op">)</span></span>
<span id="cb21-151"><a href="back.html#cb21-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">captcha</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb21-152"><a href="back.html#cb21-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-153"><a href="back.html#cb21-153" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> key <span class="op">=</span> <span class="bu">UUID</span><span class="op">.</span><span class="fu">randomUUID</span><span class="op">().</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb21-154"><a href="back.html#cb21-154" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> code <span class="op">=</span> producer<span class="op">.</span><span class="fu">createText</span><span class="op">();</span></span>
<span id="cb21-155"><a href="back.html#cb21-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-156"><a href="back.html#cb21-156" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BufferedImage</span> image <span class="op">=</span> producer<span class="op">.</span><span class="fu">createImage</span><span class="op">(</span>code<span class="op">);</span></span>
<span id="cb21-157"><a href="back.html#cb21-157" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ByteArrayOutputStream</span> outputStream <span class="op">=</span> <span class="kw">new</span> <span class="bu">ByteArrayOutputStream</span><span class="op">();</span></span>
<span id="cb21-158"><a href="back.html#cb21-158" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ImageIO</span><span class="op">.</span><span class="fu">write</span><span class="op">(</span>image<span class="op">,</span> <span class="st">&quot;jpg&quot;</span><span class="op">,</span> outputStream<span class="op">);</span></span>
<span id="cb21-159"><a href="back.html#cb21-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-160"><a href="back.html#cb21-160" aria-hidden="true" tabindex="-1"></a>        Base64<span class="op">.</span><span class="fu">Encoder</span> encoder <span class="op">=</span> Base64<span class="op">.</span><span class="fu">getEncoder</span><span class="op">();</span></span>
<span id="cb21-161"><a href="back.html#cb21-161" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> str <span class="op">=</span> <span class="st">&quot;data:image/jpeg;base64,&quot;</span><span class="op">;</span></span>
<span id="cb21-162"><a href="back.html#cb21-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-163"><a href="back.html#cb21-163" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> base64Img <span class="op">=</span> str <span class="op">+</span> encoder<span class="op">.</span><span class="fu">encodeToString</span><span class="op">(</span>outputStream<span class="op">.</span><span class="fu">toByteArray</span><span class="op">());</span></span>
<span id="cb21-164"><a href="back.html#cb21-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-165"><a href="back.html#cb21-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-166"><a href="back.html#cb21-166" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">CAPTCHA_KEY</span> <span class="op">+</span> <span class="st">&quot;:&quot;</span> <span class="op">+</span> key<span class="op">,</span> code<span class="op">,</span> <span class="dv">120</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">);</span></span>
<span id="cb21-167"><a href="back.html#cb21-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-168"><a href="back.html#cb21-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span></span>
<span id="cb21-169"><a href="back.html#cb21-169" aria-hidden="true" tabindex="-1"></a>                MapUtil<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb21-170"><a href="back.html#cb21-170" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">TOKEN</span><span class="op">,</span> key<span class="op">)</span></span>
<span id="cb21-171"><a href="back.html#cb21-171" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;captchaImg&quot;</span><span class="op">,</span> base64Img<span class="op">)</span></span>
<span id="cb21-172"><a href="back.html#cb21-172" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb21-173"><a href="back.html#cb21-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-174"><a href="back.html#cb21-174" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb21-175"><a href="back.html#cb21-175" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-176"><a href="back.html#cb21-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-177"><a href="back.html#cb21-177" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-178"><a href="back.html#cb21-178" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb22-1"><a href="back.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb22-2"><a href="back.html#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="back.html#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">bean</span><span class="op">.</span><span class="im">BeanUtil</span><span class="op">;</span></span>
<span id="cb22-4"><a href="back.html#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">crypto</span><span class="op">.</span><span class="im">SecureUtil</span><span class="op">;</span></span>
<span id="cb22-5"><a href="back.html#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryWrapper</span><span class="op">;</span></span>
<span id="cb22-6"><a href="back.html#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">update</span><span class="op">.</span><span class="im">UpdateWrapper</span><span class="op">;</span></span>
<span id="cb22-7"><a href="back.html#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">plugins</span><span class="op">.</span><span class="im">pagination</span><span class="op">.</span><span class="im">Page</span><span class="op">;</span></span>
<span id="cb22-8"><a href="back.html#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">dto</span><span class="op">.</span><span class="im">PasswordDto</span><span class="op">;</span></span>
<span id="cb22-9"><a href="back.html#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Const</span><span class="op">;</span></span>
<span id="cb22-10"><a href="back.html#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb22-11"><a href="back.html#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">RabbitConfig</span><span class="op">;</span></span>
<span id="cb22-12"><a href="back.html#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb22-13"><a href="back.html#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb22-14"><a href="back.html#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">.</span><span class="im">mq</span><span class="op">.</span><span class="im">PostMQIndexMessage</span><span class="op">;</span></span>
<span id="cb22-15"><a href="back.html#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">BlogService</span><span class="op">;</span></span>
<span id="cb22-16"><a href="back.html#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb22-17"><a href="back.html#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb22-18"><a href="back.html#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">MyUtils</span><span class="op">;</span></span>
<span id="cb22-19"><a href="back.html#cb22-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">ShiroUtil</span><span class="op">;</span></span>
<span id="cb22-20"><a href="back.html#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb22-21"><a href="back.html#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresAuthentication</span><span class="op">;</span></span>
<span id="cb22-22"><a href="back.html#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresRoles</span><span class="op">;</span></span>
<span id="cb22-23"><a href="back.html#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">AmqpTemplate</span><span class="op">;</span></span>
<span id="cb22-24"><a href="back.html#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb22-25"><a href="back.html#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Value</span><span class="op">;</span></span>
<span id="cb22-26"><a href="back.html#cb22-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb22-27"><a href="back.html#cb22-27" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Assert</span><span class="op">;</span></span>
<span id="cb22-28"><a href="back.html#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Validated</span><span class="op">;</span></span>
<span id="cb22-29"><a href="back.html#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.*;</span></span>
<span id="cb22-30"><a href="back.html#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="back.html#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">File</span><span class="op">;</span></span>
<span id="cb22-32"><a href="back.html#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">LocalDateTime</span><span class="op">;</span></span>
<span id="cb22-33"><a href="back.html#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.*;</span></span>
<span id="cb22-34"><a href="back.html#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">TimeUnit</span><span class="op">;</span></span>
<span id="cb22-35"><a href="back.html#cb22-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-36"><a href="back.html#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb22-37"><a href="back.html#cb22-37" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">后台功能</span></span>
<span id="cb22-38"><a href="back.html#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb22-39"><a href="back.html#cb22-39" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-06</span> <span class="co">8:10</span> PM</span>
<span id="cb22-40"><a href="back.html#cb22-40" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb22-41"><a href="back.html#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb22-42"><a href="back.html#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb22-43"><a href="back.html#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> BackStageController <span class="op">{</span></span>
<span id="cb22-44"><a href="back.html#cb22-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-45"><a href="back.html#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${uploadPath}&quot;</span><span class="op">)</span></span>
<span id="cb22-46"><a href="back.html#cb22-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> baseFolderPath<span class="op">;</span></span>
<span id="cb22-47"><a href="back.html#cb22-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-48"><a href="back.html#cb22-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${imgFoldName}&quot;</span><span class="op">)</span></span>
<span id="cb22-49"><a href="back.html#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> img<span class="op">;</span></span>
<span id="cb22-50"><a href="back.html#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="back.html#cb22-51" aria-hidden="true" tabindex="-1"></a>    BlogService blogService<span class="op">;</span></span>
<span id="cb22-52"><a href="back.html#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="back.html#cb22-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb22-54"><a href="back.html#cb22-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setBlogServiceImpl</span><span class="op">(</span>BlogService blogService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-55"><a href="back.html#cb22-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">blogService</span> <span class="op">=</span> blogService<span class="op">;</span></span>
<span id="cb22-56"><a href="back.html#cb22-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-57"><a href="back.html#cb22-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-58"><a href="back.html#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="back.html#cb22-59" aria-hidden="true" tabindex="-1"></a>    UserService userService<span class="op">;</span></span>
<span id="cb22-60"><a href="back.html#cb22-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-61"><a href="back.html#cb22-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb22-62"><a href="back.html#cb22-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setUserServiceImpl</span><span class="op">(</span>UserService userService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-63"><a href="back.html#cb22-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userService</span> <span class="op">=</span> userService<span class="op">;</span></span>
<span id="cb22-64"><a href="back.html#cb22-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-65"><a href="back.html#cb22-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-66"><a href="back.html#cb22-66" aria-hidden="true" tabindex="-1"></a>    RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb22-67"><a href="back.html#cb22-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-68"><a href="back.html#cb22-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb22-69"><a href="back.html#cb22-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setRedisTemplateImpl</span><span class="op">(</span>RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-70"><a href="back.html#cb22-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">redisTemplate</span> <span class="op">=</span> redisTemplate<span class="op">;</span></span>
<span id="cb22-71"><a href="back.html#cb22-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-72"><a href="back.html#cb22-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-73"><a href="back.html#cb22-73" aria-hidden="true" tabindex="-1"></a>    JwtUtils jwtUtils<span class="op">;</span></span>
<span id="cb22-74"><a href="back.html#cb22-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-75"><a href="back.html#cb22-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb22-76"><a href="back.html#cb22-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtUtils jwtUtils<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-77"><a href="back.html#cb22-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtUtils</span> <span class="op">=</span> jwtUtils<span class="op">;</span></span>
<span id="cb22-78"><a href="back.html#cb22-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-79"><a href="back.html#cb22-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-80"><a href="back.html#cb22-80" aria-hidden="true" tabindex="-1"></a>    AmqpTemplate amqpTemplate<span class="op">;</span></span>
<span id="cb22-81"><a href="back.html#cb22-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-82"><a href="back.html#cb22-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb22-83"><a href="back.html#cb22-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setAmqpTemplate</span><span class="op">(</span>AmqpTemplate amqpTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-84"><a href="back.html#cb22-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">amqpTemplate</span> <span class="op">=</span> amqpTemplate<span class="op">;</span></span>
<span id="cb22-85"><a href="back.html#cb22-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-86"><a href="back.html#cb22-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-87"><a href="back.html#cb22-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-88"><a href="back.html#cb22-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-89"><a href="back.html#cb22-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-90"><a href="back.html#cb22-90" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">新增和修改博客</span></span>
<span id="cb22-91"><a href="back.html#cb22-91" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param blog</span>
<span id="cb22-92"><a href="back.html#cb22-92" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-93"><a href="back.html#cb22-93" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-94"><a href="back.html#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="co">//    @Transactional</span></span>
<span id="cb22-95"><a href="back.html#cb22-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-96"><a href="back.html#cb22-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-97"><a href="back.html#cb22-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/blog/edit&quot;</span><span class="op">)</span></span>
<span id="cb22-98"><a href="back.html#cb22-98" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">edit</span><span class="op">(</span><span class="at">@Validated</span> <span class="at">@RequestBody</span> Blog blog<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-99"><a href="back.html#cb22-99" aria-hidden="true" tabindex="-1"></a>        Blog temp<span class="op">;</span></span>
<span id="cb22-100"><a href="back.html#cb22-100" aria-hidden="true" tabindex="-1"></a>        <span class="co">//都是更新，之前初始化过了</span></span>
<span id="cb22-101"><a href="back.html#cb22-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getId</span><span class="op">()</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-102"><a href="back.html#cb22-102" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb22-103"><a href="back.html#cb22-103" aria-hidden="true" tabindex="-1"></a>            <span class="co">// 只能编辑自己的文章</span></span>
<span id="cb22-104"><a href="back.html#cb22-104" aria-hidden="true" tabindex="-1"></a>            Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>temp<span class="op">.</span><span class="fu">getUserId</span><span class="op">().</span><span class="fu">longValue</span><span class="op">()</span> <span class="op">==</span> ShiroUtil<span class="op">.</span><span class="fu">getProfile</span><span class="op">().</span><span class="fu">getId</span><span class="op">().</span><span class="fu">longValue</span><span class="op">(),</span> <span class="st">&quot;没有权限编辑&quot;</span><span class="op">);</span></span>
<span id="cb22-105"><a href="back.html#cb22-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-106"><a href="back.html#cb22-106" aria-hidden="true" tabindex="-1"></a>            temp <span class="op">=</span> <span class="kw">new</span> <span class="fu">Blog</span><span class="op">();</span></span>
<span id="cb22-107"><a href="back.html#cb22-107" aria-hidden="true" tabindex="-1"></a>            temp<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>ShiroUtil<span class="op">.</span><span class="fu">getProfile</span><span class="op">().</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb22-108"><a href="back.html#cb22-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-109"><a href="back.html#cb22-109" aria-hidden="true" tabindex="-1"></a>            temp<span class="op">.</span><span class="fu">setCreated</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb22-110"><a href="back.html#cb22-110" aria-hidden="true" tabindex="-1"></a>            temp<span class="op">.</span><span class="fu">setStatus</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb22-111"><a href="back.html#cb22-111" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-112"><a href="back.html#cb22-112" aria-hidden="true" tabindex="-1"></a>        BeanUtil<span class="op">.</span><span class="fu">copyProperties</span><span class="op">(</span>blog<span class="op">,</span> temp<span class="op">,</span> <span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;userId&quot;</span><span class="op">,</span> <span class="st">&quot;created&quot;</span><span class="op">,</span> <span class="st">&quot;status&quot;</span><span class="op">);</span></span>
<span id="cb22-113"><a href="back.html#cb22-113" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> update <span class="op">=</span> blogService<span class="op">.</span><span class="fu">saveOrUpdate</span><span class="op">(</span>temp<span class="op">);</span></span>
<span id="cb22-114"><a href="back.html#cb22-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-115"><a href="back.html#cb22-115" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;出现错误&quot;</span><span class="op">);</span></span>
<span id="cb22-116"><a href="back.html#cb22-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-117"><a href="back.html#cb22-117" aria-hidden="true" tabindex="-1"></a>        <span class="co">//通知消息给mq,更新</span></span>
<span id="cb22-118"><a href="back.html#cb22-118" aria-hidden="true" tabindex="-1"></a>        amqpTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span></span>
<span id="cb22-119"><a href="back.html#cb22-119" aria-hidden="true" tabindex="-1"></a>                RabbitConfig<span class="op">.</span><span class="fu">ES_EXCHANGE</span><span class="op">,</span></span>
<span id="cb22-120"><a href="back.html#cb22-120" aria-hidden="true" tabindex="-1"></a>                RabbitConfig<span class="op">.</span><span class="fu">ES_BINDING_KEY</span><span class="op">,</span></span>
<span id="cb22-121"><a href="back.html#cb22-121" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> <span class="fu">PostMQIndexMessage</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> PostMQIndexMessage<span class="op">.</span><span class="fu">UPDATE</span><span class="op">));</span></span>
<span id="cb22-122"><a href="back.html#cb22-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-123"><a href="back.html#cb22-123" aria-hidden="true" tabindex="-1"></a>        <span class="co">//删除缓存热点</span></span>
<span id="cb22-124"><a href="back.html#cb22-124" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> prefix <span class="op">=</span> Const<span class="op">.</span><span class="fu">HOT_PREFIX</span><span class="op">;</span></span>
<span id="cb22-125"><a href="back.html#cb22-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> keys <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">keys</span><span class="op">(</span>prefix <span class="op">+</span> <span class="st">&quot;*&quot;</span><span class="op">);</span></span>
<span id="cb22-126"><a href="back.html#cb22-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>keys <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-127"><a href="back.html#cb22-127" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>keys<span class="op">);</span></span>
<span id="cb22-128"><a href="back.html#cb22-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-129"><a href="back.html#cb22-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-130"><a href="back.html#cb22-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-131"><a href="back.html#cb22-131" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-132"><a href="back.html#cb22-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-133"><a href="back.html#cb22-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-134"><a href="back.html#cb22-134" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">初始化文章，目的是拿到创建时间，从而让每篇文章的上传图片位于每一个文件夹中</span></span>
<span id="cb22-135"><a href="back.html#cb22-135" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>return</span>
<span id="cb22-136"><a href="back.html#cb22-136" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-137"><a href="back.html#cb22-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-138"><a href="back.html#cb22-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-139"><a href="back.html#cb22-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/addNewBlog&quot;</span><span class="op">)</span></span>
<span id="cb22-140"><a href="back.html#cb22-140" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">addNewBlog</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb22-141"><a href="back.html#cb22-141" aria-hidden="true" tabindex="-1"></a>        Blog blog <span class="op">=</span> <span class="kw">new</span> <span class="fu">Blog</span><span class="op">();</span></span>
<span id="cb22-142"><a href="back.html#cb22-142" aria-hidden="true" tabindex="-1"></a>        blog<span class="op">.</span><span class="fu">setUserId</span><span class="op">(</span>ShiroUtil<span class="op">.</span><span class="fu">getProfile</span><span class="op">().</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb22-143"><a href="back.html#cb22-143" aria-hidden="true" tabindex="-1"></a>        blog<span class="op">.</span><span class="fu">setCreated</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb22-144"><a href="back.html#cb22-144" aria-hidden="true" tabindex="-1"></a>        blog<span class="op">.</span><span class="fu">setStatus</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb22-145"><a href="back.html#cb22-145" aria-hidden="true" tabindex="-1"></a>        blog<span class="op">.</span><span class="fu">setTitle</span><span class="op">(</span><span class="st">&quot;每天都有好心情&quot;</span><span class="op">);</span></span>
<span id="cb22-146"><a href="back.html#cb22-146" aria-hidden="true" tabindex="-1"></a>        blog<span class="op">.</span><span class="fu">setDescription</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb22-147"><a href="back.html#cb22-147" aria-hidden="true" tabindex="-1"></a>        blog<span class="op">.</span><span class="fu">setContent</span><span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb22-148"><a href="back.html#cb22-148" aria-hidden="true" tabindex="-1"></a>        blogService<span class="op">.</span><span class="fu">saveOrUpdate</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb22-149"><a href="back.html#cb22-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-150"><a href="back.html#cb22-150" aria-hidden="true" tabindex="-1"></a>        <span class="co">//通知消息给mq</span></span>
<span id="cb22-151"><a href="back.html#cb22-151" aria-hidden="true" tabindex="-1"></a>        amqpTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span></span>
<span id="cb22-152"><a href="back.html#cb22-152" aria-hidden="true" tabindex="-1"></a>                RabbitConfig<span class="op">.</span><span class="fu">ES_EXCHANGE</span><span class="op">,</span></span>
<span id="cb22-153"><a href="back.html#cb22-153" aria-hidden="true" tabindex="-1"></a>                RabbitConfig<span class="op">.</span><span class="fu">ES_BINDING_KEY</span><span class="op">,</span></span>
<span id="cb22-154"><a href="back.html#cb22-154" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> <span class="fu">PostMQIndexMessage</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> PostMQIndexMessage<span class="op">.</span><span class="fu">CREATE</span><span class="op">));</span></span>
<span id="cb22-155"><a href="back.html#cb22-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-156"><a href="back.html#cb22-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb22-157"><a href="back.html#cb22-157" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-158"><a href="back.html#cb22-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-159"><a href="back.html#cb22-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-160"><a href="back.html#cb22-160" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-161"><a href="back.html#cb22-161" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">查看已经删除的博客</span></span>
<span id="cb22-162"><a href="back.html#cb22-162" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param currentPage</span>
<span id="cb22-163"><a href="back.html#cb22-163" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-164"><a href="back.html#cb22-164" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-165"><a href="back.html#cb22-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-166"><a href="back.html#cb22-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-167"><a href="back.html#cb22-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/queryDeletedBlogs&quot;</span><span class="op">)</span></span>
<span id="cb22-168"><a href="back.html#cb22-168" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">listDeleted</span><span class="op">(</span><span class="at">@RequestParam</span> <span class="bu">String</span> title<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Integer</span> currentPage<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Integer</span> size<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-169"><a href="back.html#cb22-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-170"><a href="back.html#cb22-170" aria-hidden="true" tabindex="-1"></a>        User one <span class="op">=</span> userService<span class="op">.</span><span class="fu">getOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> userId<span class="op">).</span><span class="fu">last</span><span class="op">(</span><span class="st">&quot;LIMIT 1&quot;</span><span class="op">));</span></span>
<span id="cb22-171"><a href="back.html#cb22-171" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> username <span class="op">=</span> one<span class="op">.</span><span class="fu">getUsername</span><span class="op">();</span></span>
<span id="cb22-172"><a href="back.html#cb22-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-173"><a href="back.html#cb22-173" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> prefix <span class="op">=</span> userId <span class="op">+</span> <span class="st">&quot;:blog:*&quot;</span><span class="op">;</span></span>
<span id="cb22-174"><a href="back.html#cb22-174" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> keys <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">keys</span><span class="op">(</span>prefix<span class="op">);</span></span>
<span id="cb22-175"><a href="back.html#cb22-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-176"><a href="back.html#cb22-176" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>keys <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-177"><a href="back.html#cb22-177" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> rawAllDeleted <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">multiGet</span><span class="op">(</span>keys<span class="op">);</span></span>
<span id="cb22-178"><a href="back.html#cb22-178" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>rawAllDeleted <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-179"><a href="back.html#cb22-179" aria-hidden="true" tabindex="-1"></a>                <span class="bu">ArrayList</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> allDeleted <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb22-180"><a href="back.html#cb22-180" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span> value <span class="op">:</span> rawAllDeleted<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-181"><a href="back.html#cb22-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-182"><a href="back.html#cb22-182" aria-hidden="true" tabindex="-1"></a>                    Blog blog <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">jsonToObj</span><span class="op">(</span>value<span class="op">,</span> Blog<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb22-183"><a href="back.html#cb22-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-184"><a href="back.html#cb22-184" aria-hidden="true" tabindex="-1"></a>                    allDeleted<span class="op">.</span><span class="fu">add</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb22-185"><a href="back.html#cb22-185" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb22-186"><a href="back.html#cb22-186" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>title<span class="op">))</span> <span class="op">{</span></span>
<span id="cb22-187"><a href="back.html#cb22-187" aria-hidden="true" tabindex="-1"></a>                    <span class="co">//以创建时间排序，由晚到早</span></span>
<span id="cb22-188"><a href="back.html#cb22-188" aria-hidden="true" tabindex="-1"></a>                    allDeleted<span class="op">.</span><span class="fu">sort</span><span class="op">((</span>o1<span class="op">,</span> o2<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">-</span>o1<span class="op">.</span><span class="fu">getCreated</span><span class="op">().</span><span class="fu">compareTo</span><span class="op">(</span>o2<span class="op">.</span><span class="fu">getCreated</span><span class="op">()));</span></span>
<span id="cb22-189"><a href="back.html#cb22-189" aria-hidden="true" tabindex="-1"></a>                    Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">listToPage</span><span class="op">(</span>allDeleted<span class="op">,</span> currentPage<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb22-190"><a href="back.html#cb22-190" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> records <span class="op">=</span> page<span class="op">.</span><span class="fu">getRecords</span><span class="op">();</span></span>
<span id="cb22-191"><a href="back.html#cb22-191" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span>Blog record <span class="op">:</span> records<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-192"><a href="back.html#cb22-192" aria-hidden="true" tabindex="-1"></a>                        record<span class="op">.</span><span class="fu">setUsername</span><span class="op">(</span>username<span class="op">);</span></span>
<span id="cb22-193"><a href="back.html#cb22-193" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb22-194"><a href="back.html#cb22-194" aria-hidden="true" tabindex="-1"></a>                    page<span class="op">.</span><span class="fu">setRecords</span><span class="op">(</span>records<span class="op">);</span></span>
<span id="cb22-195"><a href="back.html#cb22-195" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb22-196"><a href="back.html#cb22-196" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-197"><a href="back.html#cb22-197" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">ArrayList</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> blogs <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb22-198"><a href="back.html#cb22-198" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span>Blog blog <span class="op">:</span> allDeleted<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-199"><a href="back.html#cb22-199" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>blog<span class="op">.</span><span class="fu">getTitle</span><span class="op">().</span><span class="fu">contains</span><span class="op">(</span>title<span class="op">))</span> <span class="op">{</span></span>
<span id="cb22-200"><a href="back.html#cb22-200" aria-hidden="true" tabindex="-1"></a>                            blogs<span class="op">.</span><span class="fu">add</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb22-201"><a href="back.html#cb22-201" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb22-202"><a href="back.html#cb22-202" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb22-203"><a href="back.html#cb22-203" aria-hidden="true" tabindex="-1"></a>                    blogs<span class="op">.</span><span class="fu">sort</span><span class="op">((</span>o1<span class="op">,</span> o2<span class="op">)</span> <span class="op">-&gt;</span> <span class="op">-</span>o1<span class="op">.</span><span class="fu">getCreated</span><span class="op">().</span><span class="fu">compareTo</span><span class="op">(</span>o2<span class="op">.</span><span class="fu">getCreated</span><span class="op">()));</span></span>
<span id="cb22-204"><a href="back.html#cb22-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-205"><a href="back.html#cb22-205" aria-hidden="true" tabindex="-1"></a>                    Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">listToPage</span><span class="op">(</span>blogs<span class="op">,</span> currentPage<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb22-206"><a href="back.html#cb22-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-207"><a href="back.html#cb22-207" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> records <span class="op">=</span> page<span class="op">.</span><span class="fu">getRecords</span><span class="op">();</span></span>
<span id="cb22-208"><a href="back.html#cb22-208" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> <span class="op">(</span>Blog record <span class="op">:</span> records<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-209"><a href="back.html#cb22-209" aria-hidden="true" tabindex="-1"></a>                        record<span class="op">.</span><span class="fu">setUsername</span><span class="op">(</span>username<span class="op">);</span></span>
<span id="cb22-210"><a href="back.html#cb22-210" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb22-211"><a href="back.html#cb22-211" aria-hidden="true" tabindex="-1"></a>                    page<span class="op">.</span><span class="fu">setRecords</span><span class="op">(</span>records<span class="op">);</span></span>
<span id="cb22-212"><a href="back.html#cb22-212" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb22-213"><a href="back.html#cb22-213" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb22-214"><a href="back.html#cb22-214" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb22-215"><a href="back.html#cb22-215" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-216"><a href="back.html#cb22-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;读取失败&quot;</span><span class="op">);</span></span>
<span id="cb22-217"><a href="back.html#cb22-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-218"><a href="back.html#cb22-218" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-219"><a href="back.html#cb22-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-220"><a href="back.html#cb22-220" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-221"><a href="back.html#cb22-221" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">恢复删除的博客</span></span>
<span id="cb22-222"><a href="back.html#cb22-222" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param id</span>
<span id="cb22-223"><a href="back.html#cb22-223" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-224"><a href="back.html#cb22-224" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-225"><a href="back.html#cb22-225" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-226"><a href="back.html#cb22-226" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-227"><a href="back.html#cb22-227" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/recoverBlogs/{id}/{userId}&quot;</span><span class="op">)</span></span>
<span id="cb22-228"><a href="back.html#cb22-228" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">recoverBlog</span><span class="op">(</span><span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="bu">Long</span> id<span class="op">,</span> <span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;userId&quot;</span><span class="op">)</span> <span class="bu">Long</span> userId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-229"><a href="back.html#cb22-229" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> key <span class="op">=</span> userId <span class="op">+</span> <span class="st">&quot;:blog:&quot;</span> <span class="op">+</span> id<span class="op">;</span></span>
<span id="cb22-230"><a href="back.html#cb22-230" aria-hidden="true" tabindex="-1"></a>        <span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;)</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb22-231"><a href="back.html#cb22-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-232"><a href="back.html#cb22-232" aria-hidden="true" tabindex="-1"></a>        Blog blog <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">jsonToObj</span><span class="op">(</span>value<span class="op">,</span> Blog<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb22-233"><a href="back.html#cb22-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-234"><a href="back.html#cb22-234" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">notNull</span><span class="op">(</span>blog<span class="op">,</span> <span class="st">&quot;恢复异常&quot;</span><span class="op">);</span></span>
<span id="cb22-235"><a href="back.html#cb22-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-236"><a href="back.html#cb22-236" aria-hidden="true" tabindex="-1"></a>        <span class="co">//用saveOrUpdate(blog)会导致id自增，这里要恢复原来的id</span></span>
<span id="cb22-237"><a href="back.html#cb22-237" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> recover <span class="op">=</span> blogService<span class="op">.</span><span class="fu">recover</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb22-238"><a href="back.html#cb22-238" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>recover<span class="op">,</span> <span class="st">&quot;恢复失败&quot;</span><span class="op">);</span></span>
<span id="cb22-239"><a href="back.html#cb22-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-240"><a href="back.html#cb22-240" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>key<span class="op">);</span></span>
<span id="cb22-241"><a href="back.html#cb22-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-242"><a href="back.html#cb22-242" aria-hidden="true" tabindex="-1"></a>        <span class="co">//通知消息给mq</span></span>
<span id="cb22-243"><a href="back.html#cb22-243" aria-hidden="true" tabindex="-1"></a>        amqpTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span></span>
<span id="cb22-244"><a href="back.html#cb22-244" aria-hidden="true" tabindex="-1"></a>                RabbitConfig<span class="op">.</span><span class="fu">ES_EXCHANGE</span><span class="op">,</span></span>
<span id="cb22-245"><a href="back.html#cb22-245" aria-hidden="true" tabindex="-1"></a>                RabbitConfig<span class="op">.</span><span class="fu">ES_BINDING_KEY</span><span class="op">,</span></span>
<span id="cb22-246"><a href="back.html#cb22-246" aria-hidden="true" tabindex="-1"></a>                <span class="kw">new</span> <span class="fu">PostMQIndexMessage</span><span class="op">(</span>id<span class="op">,</span> PostMQIndexMessage<span class="op">.</span><span class="fu">CREATE</span><span class="op">));</span></span>
<span id="cb22-247"><a href="back.html#cb22-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-248"><a href="back.html#cb22-248" aria-hidden="true" tabindex="-1"></a>        <span class="co">//删除缓存热点</span></span>
<span id="cb22-249"><a href="back.html#cb22-249" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> prefix <span class="op">=</span> Const<span class="op">.</span><span class="fu">HOT_PREFIX</span><span class="op">;</span></span>
<span id="cb22-250"><a href="back.html#cb22-250" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> keys <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">keys</span><span class="op">(</span>prefix <span class="op">+</span> <span class="st">&quot;*&quot;</span><span class="op">);</span></span>
<span id="cb22-251"><a href="back.html#cb22-251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>keys <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-252"><a href="back.html#cb22-252" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>keys<span class="op">);</span></span>
<span id="cb22-253"><a href="back.html#cb22-253" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-254"><a href="back.html#cb22-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-255"><a href="back.html#cb22-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-256"><a href="back.html#cb22-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-257"><a href="back.html#cb22-257" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-258"><a href="back.html#cb22-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-259"><a href="back.html#cb22-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-260"><a href="back.html#cb22-260" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-261"><a href="back.html#cb22-261" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">更改账户状态，0可以正常使用，1禁用</span></span>
<span id="cb22-262"><a href="back.html#cb22-262" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-263"><a href="back.html#cb22-263" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-264"><a href="back.html#cb22-264" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-265"><a href="back.html#cb22-265" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/modifyUser/{id}/{status}&quot;</span><span class="op">)</span></span>
<span id="cb22-266"><a href="back.html#cb22-266" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">modifyUser</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Integer</span> id<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">Integer</span> status<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-267"><a href="back.html#cb22-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-268"><a href="back.html#cb22-268" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> update <span class="op">=</span> userService<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="kw">new</span> UpdateWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">).</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;status&quot;</span><span class="op">,</span> status<span class="op">));</span></span>
<span id="cb22-269"><a href="back.html#cb22-269" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;删除失败&quot;</span><span class="op">);</span></span>
<span id="cb22-270"><a href="back.html#cb22-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-271"><a href="back.html#cb22-271" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-272"><a href="back.html#cb22-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-273"><a href="back.html#cb22-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-274"><a href="back.html#cb22-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-275"><a href="back.html#cb22-275" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-276"><a href="back.html#cb22-276" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">更改文章状态，0为公开，1为登录后可阅读</span></span>
<span id="cb22-277"><a href="back.html#cb22-277" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-278"><a href="back.html#cb22-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-279"><a href="back.html#cb22-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-280"><a href="back.html#cb22-280" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/modifyBlogStatus/{id}/{status}&quot;</span><span class="op">)</span></span>
<span id="cb22-281"><a href="back.html#cb22-281" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">modifyBlogStatus</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Integer</span> id<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">Integer</span> status<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-282"><a href="back.html#cb22-282" aria-hidden="true" tabindex="-1"></a>        LocalDateTime created <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>id<span class="op">).</span><span class="fu">getCreated</span><span class="op">();</span></span>
<span id="cb22-283"><a href="back.html#cb22-283" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> update <span class="op">=</span> blogService<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="kw">new</span> UpdateWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">).</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;status&quot;</span><span class="op">,</span> status<span class="op">).</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">,</span> created<span class="op">));</span></span>
<span id="cb22-284"><a href="back.html#cb22-284" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;修改失败&quot;</span><span class="op">);</span></span>
<span id="cb22-285"><a href="back.html#cb22-285" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-286"><a href="back.html#cb22-286" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-287"><a href="back.html#cb22-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-288"><a href="back.html#cb22-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-289"><a href="back.html#cb22-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-290"><a href="back.html#cb22-290" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-291"><a href="back.html#cb22-291" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">查询全部博客记录，包含总阅读数和最近7日阅读数</span></span>
<span id="cb22-292"><a href="back.html#cb22-292" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param currentPage</span>
<span id="cb22-293"><a href="back.html#cb22-293" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-294"><a href="back.html#cb22-294" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-295"><a href="back.html#cb22-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-296"><a href="back.html#cb22-296" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/queryBlogs&quot;</span><span class="op">)</span></span>
<span id="cb22-297"><a href="back.html#cb22-297" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">queryAllBlogs</span><span class="op">(</span><span class="at">@RequestParam</span> <span class="bu">String</span> title<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Integer</span> currentPage<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Integer</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-298"><a href="back.html#cb22-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-299"><a href="back.html#cb22-299" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了全部博客记录&quot;</span><span class="op">);</span></span>
<span id="cb22-300"><a href="back.html#cb22-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-301"><a href="back.html#cb22-301" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> blogsList<span class="op">;</span></span>
<span id="cb22-302"><a href="back.html#cb22-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-303"><a href="back.html#cb22-303" aria-hidden="true" tabindex="-1"></a>        <span class="co">//查询相关数据</span></span>
<span id="cb22-304"><a href="back.html#cb22-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>title<span class="op">))</span> <span class="op">{</span></span>
<span id="cb22-305"><a href="back.html#cb22-305" aria-hidden="true" tabindex="-1"></a>            blogsList <span class="op">=</span> blogService<span class="op">.</span><span class="fu">queryAllBlogs</span><span class="op">();</span></span>
<span id="cb22-306"><a href="back.html#cb22-306" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-307"><a href="back.html#cb22-307" aria-hidden="true" tabindex="-1"></a>            blogsList <span class="op">=</span> blogService<span class="op">.</span><span class="fu">queryBlogs</span><span class="op">(</span>title<span class="op">);</span></span>
<span id="cb22-308"><a href="back.html#cb22-308" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-309"><a href="back.html#cb22-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-310"><a href="back.html#cb22-310" aria-hidden="true" tabindex="-1"></a>        <span class="co">//将相关数据封装Page对象</span></span>
<span id="cb22-311"><a href="back.html#cb22-311" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">listToPage</span><span class="op">(</span>blogsList<span class="op">,</span> currentPage<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb22-312"><a href="back.html#cb22-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-313"><a href="back.html#cb22-313" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> blogs <span class="op">=</span> page<span class="op">.</span><span class="fu">getRecords</span><span class="op">();</span></span>
<span id="cb22-314"><a href="back.html#cb22-314" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> ids <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb22-315"><a href="back.html#cb22-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-316"><a href="back.html#cb22-316" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span>Blog blog <span class="op">:</span> blogs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-317"><a href="back.html#cb22-317" aria-hidden="true" tabindex="-1"></a>            ids<span class="op">.</span><span class="fu">add</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getId</span><span class="op">().</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb22-318"><a href="back.html#cb22-318" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-319"><a href="back.html#cb22-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-320"><a href="back.html#cb22-320" aria-hidden="true" tabindex="-1"></a>        <span class="co">//为数据设置7日阅读和总阅读数</span></span>
<span id="cb22-321"><a href="back.html#cb22-321" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> listSum <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">multiGet</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_SUM</span><span class="op">,</span> ids<span class="op">);</span></span>
<span id="cb22-322"><a href="back.html#cb22-322" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> blogs<span class="op">.</span><span class="fu">size</span><span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb22-323"><a href="back.html#cb22-323" aria-hidden="true" tabindex="-1"></a>            Blog blog <span class="op">=</span> blogs<span class="op">.</span><span class="fu">get</span><span class="op">(</span>i<span class="op">);</span></span>
<span id="cb22-324"><a href="back.html#cb22-324" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>listSum<span class="op">.</span><span class="fu">get</span><span class="op">(</span>i<span class="op">)</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-325"><a href="back.html#cb22-325" aria-hidden="true" tabindex="-1"></a>                blog<span class="op">.</span><span class="fu">setReadSum</span><span class="op">((</span><span class="bu">Integer</span><span class="op">)</span> listSum<span class="op">.</span><span class="fu">get</span><span class="op">(</span>i<span class="op">));</span></span>
<span id="cb22-326"><a href="back.html#cb22-326" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Integer</span> recentNum <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> blog<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb22-327"><a href="back.html#cb22-327" aria-hidden="true" tabindex="-1"></a>                blog<span class="op">.</span><span class="fu">setReadRecent</span><span class="op">(</span>Objects<span class="op">.</span><span class="fu">requireNonNullElse</span><span class="op">(</span>recentNum<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb22-328"><a href="back.html#cb22-328" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-329"><a href="back.html#cb22-329" aria-hidden="true" tabindex="-1"></a>                blog<span class="op">.</span><span class="fu">setReadSum</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb22-330"><a href="back.html#cb22-330" aria-hidden="true" tabindex="-1"></a>                blog<span class="op">.</span><span class="fu">setReadRecent</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb22-331"><a href="back.html#cb22-331" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb22-332"><a href="back.html#cb22-332" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-333"><a href="back.html#cb22-333" aria-hidden="true" tabindex="-1"></a>        page<span class="op">.</span><span class="fu">setRecords</span><span class="op">(</span>blogs<span class="op">);</span></span>
<span id="cb22-334"><a href="back.html#cb22-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-335"><a href="back.html#cb22-335" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb22-336"><a href="back.html#cb22-336" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-337"><a href="back.html#cb22-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-338"><a href="back.html#cb22-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-339"><a href="back.html#cb22-339" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-340"><a href="back.html#cb22-340" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">查询账号</span></span>
<span id="cb22-341"><a href="back.html#cb22-341" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-342"><a href="back.html#cb22-342" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-343"><a href="back.html#cb22-343" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/queryUsers&quot;</span><span class="op">)</span></span>
<span id="cb22-344"><a href="back.html#cb22-344" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">queryUsers</span><span class="op">(</span><span class="at">@RequestParam</span> <span class="bu">String</span> role<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Integer</span> currentPage<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">Integer</span> size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-345"><a href="back.html#cb22-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-346"><a href="back.html#cb22-346" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了查询账号&quot;</span><span class="op">);</span></span>
<span id="cb22-347"><a href="back.html#cb22-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-348"><a href="back.html#cb22-348" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>User<span class="op">&gt;</span> userPage <span class="op">=</span> <span class="kw">new</span> Page<span class="op">&lt;&gt;(</span>currentPage<span class="op">,</span> size<span class="op">);</span></span>
<span id="cb22-349"><a href="back.html#cb22-349" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>User<span class="op">&gt;</span> page<span class="op">;</span></span>
<span id="cb22-350"><a href="back.html#cb22-350" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span><span class="st">&quot;&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>role<span class="op">))</span> <span class="op">{</span><span class="co">//搜索</span></span>
<span id="cb22-351"><a href="back.html#cb22-351" aria-hidden="true" tabindex="-1"></a>            page <span class="op">=</span> userService<span class="op">.</span><span class="fu">page</span><span class="op">(</span>userPage<span class="op">,</span> <span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;role&quot;</span><span class="op">,</span> role<span class="op">));</span></span>
<span id="cb22-352"><a href="back.html#cb22-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-353"><a href="back.html#cb22-353" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span><span class="co">//不是搜索</span></span>
<span id="cb22-354"><a href="back.html#cb22-354" aria-hidden="true" tabindex="-1"></a>            page <span class="op">=</span> userService<span class="op">.</span><span class="fu">page</span><span class="op">(</span>userPage<span class="op">,</span> <span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;username&quot;</span><span class="op">,</span> <span class="st">&quot;avatar&quot;</span><span class="op">,</span> <span class="st">&quot;email&quot;</span><span class="op">,</span> <span class="st">&quot;status&quot;</span><span class="op">,</span> <span class="st">&quot;created&quot;</span><span class="op">,</span> <span class="st">&quot;last_login&quot;</span><span class="op">,</span> <span class="st">&quot;role&quot;</span><span class="op">).</span><span class="fu">orderByAsc</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">));</span></span>
<span id="cb22-355"><a href="back.html#cb22-355" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-356"><a href="back.html#cb22-356" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>User<span class="op">&gt;</span> records <span class="op">=</span> page<span class="op">.</span><span class="fu">getRecords</span><span class="op">();</span></span>
<span id="cb22-357"><a href="back.html#cb22-357" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>User record <span class="op">:</span> records<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-358"><a href="back.html#cb22-358" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span><span class="bu">Boolean</span><span class="op">.</span><span class="fu">TRUE</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">hasKey</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> record<span class="op">.</span><span class="fu">getId</span><span class="op">()))</span> <span class="op">&amp;&amp;</span> record<span class="op">.</span><span class="fu">getStatus</span><span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-359"><a href="back.html#cb22-359" aria-hidden="true" tabindex="-1"></a>                record<span class="op">.</span><span class="fu">setMonitor</span><span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb22-360"><a href="back.html#cb22-360" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb22-361"><a href="back.html#cb22-361" aria-hidden="true" tabindex="-1"></a>                record<span class="op">.</span><span class="fu">setMonitor</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb22-362"><a href="back.html#cb22-362" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb22-363"><a href="back.html#cb22-363" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-364"><a href="back.html#cb22-364" aria-hidden="true" tabindex="-1"></a>        page<span class="op">.</span><span class="fu">setRecords</span><span class="op">(</span>records<span class="op">);</span></span>
<span id="cb22-365"><a href="back.html#cb22-365" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb22-366"><a href="back.html#cb22-366" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-367"><a href="back.html#cb22-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-368"><a href="back.html#cb22-368" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-369"><a href="back.html#cb22-369" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">新增账号，修改信息</span></span>
<span id="cb22-370"><a href="back.html#cb22-370" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-371"><a href="back.html#cb22-371" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-372"><a href="back.html#cb22-372" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-373"><a href="back.html#cb22-373" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/addUser&quot;</span><span class="op">)</span></span>
<span id="cb22-374"><a href="back.html#cb22-374" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">addUser</span><span class="op">(</span><span class="at">@Validated</span> <span class="at">@RequestBody</span> User user<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-375"><a href="back.html#cb22-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-376"><a href="back.html#cb22-376" aria-hidden="true" tabindex="-1"></a>        User userExist <span class="op">=</span> userService<span class="op">.</span><span class="fu">getBaseMapper</span><span class="op">().</span><span class="fu">selectOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">()));</span></span>
<span id="cb22-377"><a href="back.html#cb22-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-378"><a href="back.html#cb22-378" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>userExist <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span><span class="co">//添加</span></span>
<span id="cb22-379"><a href="back.html#cb22-379" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">setPassword</span><span class="op">(</span>SecureUtil<span class="op">.</span><span class="fu">md5</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getPassword</span><span class="op">()));</span></span>
<span id="cb22-380"><a href="back.html#cb22-380" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">setCreated</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb22-381"><a href="back.html#cb22-381" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">setLastLogin</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb22-382"><a href="back.html#cb22-382" aria-hidden="true" tabindex="-1"></a>            <span class="dt">boolean</span> update <span class="op">=</span> userService<span class="op">.</span><span class="fu">saveOrUpdate</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb22-383"><a href="back.html#cb22-383" aria-hidden="true" tabindex="-1"></a>            Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;添加失败&quot;</span><span class="op">);</span></span>
<span id="cb22-384"><a href="back.html#cb22-384" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span><span class="co">//修改</span></span>
<span id="cb22-385"><a href="back.html#cb22-385" aria-hidden="true" tabindex="-1"></a>            userExist<span class="op">.</span><span class="fu">setStatus</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getStatus</span><span class="op">());</span></span>
<span id="cb22-386"><a href="back.html#cb22-386" aria-hidden="true" tabindex="-1"></a>            userExist<span class="op">.</span><span class="fu">setAvatar</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getAvatar</span><span class="op">());</span></span>
<span id="cb22-387"><a href="back.html#cb22-387" aria-hidden="true" tabindex="-1"></a>            userExist<span class="op">.</span><span class="fu">setEmail</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getEmail</span><span class="op">());</span></span>
<span id="cb22-388"><a href="back.html#cb22-388" aria-hidden="true" tabindex="-1"></a>            userExist<span class="op">.</span><span class="fu">setRole</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getRole</span><span class="op">());</span></span>
<span id="cb22-389"><a href="back.html#cb22-389" aria-hidden="true" tabindex="-1"></a>            <span class="dt">boolean</span> update <span class="op">=</span> userService<span class="op">.</span><span class="fu">saveOrUpdate</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb22-390"><a href="back.html#cb22-390" aria-hidden="true" tabindex="-1"></a>            Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;修改失败&quot;</span><span class="op">);</span></span>
<span id="cb22-391"><a href="back.html#cb22-391" aria-hidden="true" tabindex="-1"></a>            <span class="co">//删除缓存角色授权信息</span></span>
<span id="cb22-392"><a href="back.html#cb22-392" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">ROLE_PREFIX</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getId</span><span class="op">());</span></span>
<span id="cb22-393"><a href="back.html#cb22-393" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-394"><a href="back.html#cb22-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-395"><a href="back.html#cb22-395" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-396"><a href="back.html#cb22-396" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-397"><a href="back.html#cb22-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-398"><a href="back.html#cb22-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-399"><a href="back.html#cb22-399" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-400"><a href="back.html#cb22-400" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">删除博客</span></span>
<span id="cb22-401"><a href="back.html#cb22-401" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param ids</span>
<span id="cb22-402"><a href="back.html#cb22-402" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-403"><a href="back.html#cb22-403" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-404"><a href="back.html#cb22-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-405"><a href="back.html#cb22-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-406"><a href="back.html#cb22-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/deleteBlogs&quot;</span><span class="op">)</span></span>
<span id="cb22-407"><a href="back.html#cb22-407" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">deleteBlogs</span><span class="op">(</span><span class="at">@RequestBody</span> <span class="bu">Long</span><span class="op">[]</span> ids<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-408"><a href="back.html#cb22-408" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">Long</span><span class="op">&gt;</span> idList <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span><span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span>ids<span class="op">));</span></span>
<span id="cb22-409"><a href="back.html#cb22-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-410"><a href="back.html#cb22-410" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">Long</span> id <span class="op">:</span> idList<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-411"><a href="back.html#cb22-411" aria-hidden="true" tabindex="-1"></a>            Blog blog <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb22-412"><a href="back.html#cb22-412" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">delete</span><span class="op">(</span><span class="st">&quot;blogsReadSum&quot;</span><span class="op">,</span> id<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb22-413"><a href="back.html#cb22-413" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span>blog<span class="op">.</span><span class="fu">getUserId</span><span class="op">()</span> <span class="op">+</span> <span class="st">&quot;:blog:&quot;</span> <span class="op">+</span> id<span class="op">,</span> blog<span class="op">,</span> <span class="dv">7</span> <span class="op">*</span> <span class="dv">24</span> <span class="op">*</span> <span class="dv">60</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">MINUTES</span><span class="op">);</span></span>
<span id="cb22-414"><a href="back.html#cb22-414" aria-hidden="true" tabindex="-1"></a>            <span class="co">/*</span></span>
<span id="cb22-415"><a href="back.html#cb22-415" aria-hidden="true" tabindex="-1"></a><span class="co">             * 直接删除对应的文件夹，提高效率</span></span>
<span id="cb22-416"><a href="back.html#cb22-416" aria-hidden="true" tabindex="-1"></a><span class="co">             */</span></span>
<span id="cb22-417"><a href="back.html#cb22-417" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> createdTime <span class="op">=</span> blog<span class="op">.</span><span class="fu">getCreated</span><span class="op">().</span><span class="fu">toString</span><span class="op">();</span></span>
<span id="cb22-418"><a href="back.html#cb22-418" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> created <span class="op">=</span> createdTime</span>
<span id="cb22-419"><a href="back.html#cb22-419" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot;-&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb22-420"><a href="back.html#cb22-420" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot;T&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb22-421"><a href="back.html#cb22-421" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot;:&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb22-422"><a href="back.html#cb22-422" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> finalDest <span class="op">=</span> baseFolderPath <span class="op">+</span> img <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> created<span class="op">;</span></span>
<span id="cb22-423"><a href="back.html#cb22-423" aria-hidden="true" tabindex="-1"></a>            <span class="bu">File</span> file <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>finalDest<span class="op">);</span></span>
<span id="cb22-424"><a href="back.html#cb22-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-425"><a href="back.html#cb22-425" aria-hidden="true" tabindex="-1"></a>            MyUtils<span class="op">.</span><span class="fu">deleteAllImg</span><span class="op">(</span>file<span class="op">);</span></span>
<span id="cb22-426"><a href="back.html#cb22-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-427"><a href="back.html#cb22-427" aria-hidden="true" tabindex="-1"></a>            <span class="dt">boolean</span> update <span class="op">=</span> blogService<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="kw">new</span> UpdateWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;().</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">,</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">()).</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">));</span></span>
<span id="cb22-428"><a href="back.html#cb22-428" aria-hidden="true" tabindex="-1"></a>            Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;设置删除时间失败&quot;</span><span class="op">);</span></span>
<span id="cb22-429"><a href="back.html#cb22-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-430"><a href="back.html#cb22-430" aria-hidden="true" tabindex="-1"></a>            <span class="co">//删除文章</span></span>
<span id="cb22-431"><a href="back.html#cb22-431" aria-hidden="true" tabindex="-1"></a>            <span class="dt">boolean</span> remove <span class="op">=</span> blogService<span class="op">.</span><span class="fu">removeById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb22-432"><a href="back.html#cb22-432" aria-hidden="true" tabindex="-1"></a>            Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>remove<span class="op">,</span> <span class="st">&quot;删除失败&quot;</span><span class="op">);</span></span>
<span id="cb22-433"><a href="back.html#cb22-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-434"><a href="back.html#cb22-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-435"><a href="back.html#cb22-435" aria-hidden="true" tabindex="-1"></a>            <span class="co">//通知消息给mq</span></span>
<span id="cb22-436"><a href="back.html#cb22-436" aria-hidden="true" tabindex="-1"></a>            amqpTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span></span>
<span id="cb22-437"><a href="back.html#cb22-437" aria-hidden="true" tabindex="-1"></a>                    RabbitConfig<span class="op">.</span><span class="fu">ES_EXCHANGE</span><span class="op">,</span></span>
<span id="cb22-438"><a href="back.html#cb22-438" aria-hidden="true" tabindex="-1"></a>                    RabbitConfig<span class="op">.</span><span class="fu">ES_BINDING_KEY</span><span class="op">,</span></span>
<span id="cb22-439"><a href="back.html#cb22-439" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">new</span> <span class="fu">PostMQIndexMessage</span><span class="op">(</span>id<span class="op">,</span> PostMQIndexMessage<span class="op">.</span><span class="fu">REMOVE</span><span class="op">));</span></span>
<span id="cb22-440"><a href="back.html#cb22-440" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-441"><a href="back.html#cb22-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-442"><a href="back.html#cb22-442" aria-hidden="true" tabindex="-1"></a>        <span class="co">//删除缓存热点</span></span>
<span id="cb22-443"><a href="back.html#cb22-443" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> prefix <span class="op">=</span> Const<span class="op">.</span><span class="fu">HOT_PREFIX</span><span class="op">;</span></span>
<span id="cb22-444"><a href="back.html#cb22-444" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Set</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> keys <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">keys</span><span class="op">(</span>prefix <span class="op">+</span> <span class="st">&quot;*&quot;</span><span class="op">);</span></span>
<span id="cb22-445"><a href="back.html#cb22-445" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>keys <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-446"><a href="back.html#cb22-446" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>keys<span class="op">);</span></span>
<span id="cb22-447"><a href="back.html#cb22-447" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb22-448"><a href="back.html#cb22-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-449"><a href="back.html#cb22-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-450"><a href="back.html#cb22-450" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="st">&quot;删除成功&quot;</span><span class="op">);</span></span>
<span id="cb22-451"><a href="back.html#cb22-451" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-452"><a href="back.html#cb22-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-453"><a href="back.html#cb22-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-454"><a href="back.html#cb22-454" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-455"><a href="back.html#cb22-455" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">删除账号，批量</span></span>
<span id="cb22-456"><a href="back.html#cb22-456" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param ids</span>
<span id="cb22-457"><a href="back.html#cb22-457" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-458"><a href="back.html#cb22-458" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-459"><a href="back.html#cb22-459" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-460"><a href="back.html#cb22-460" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-461"><a href="back.html#cb22-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/deleteUsers&quot;</span><span class="op">)</span></span>
<span id="cb22-462"><a href="back.html#cb22-462" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">deleteUsers</span><span class="op">(</span><span class="at">@RequestBody</span> <span class="bu">Long</span><span class="op">[]</span> ids<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-463"><a href="back.html#cb22-463" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ArrayList</span><span class="op">&lt;</span><span class="bu">Long</span><span class="op">&gt;</span> idList <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;(</span><span class="bu">List</span><span class="op">.</span><span class="fu">of</span><span class="op">(</span>ids<span class="op">));</span></span>
<span id="cb22-464"><a href="back.html#cb22-464" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> remove <span class="op">=</span> userService<span class="op">.</span><span class="fu">removeByIds</span><span class="op">(</span>idList<span class="op">);</span></span>
<span id="cb22-465"><a href="back.html#cb22-465" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>remove<span class="op">,</span> <span class="st">&quot;删除失败&quot;</span><span class="op">);</span></span>
<span id="cb22-466"><a href="back.html#cb22-466" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-467"><a href="back.html#cb22-467" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-468"><a href="back.html#cb22-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-469"><a href="back.html#cb22-469" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-470"><a href="back.html#cb22-470" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">回显信息</span></span>
<span id="cb22-471"><a href="back.html#cb22-471" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param id</span>
<span id="cb22-472"><a href="back.html#cb22-472" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-473"><a href="back.html#cb22-473" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-474"><a href="back.html#cb22-474" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-475"><a href="back.html#cb22-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/getInfoById/{id}&quot;</span><span class="op">)</span></span>
<span id="cb22-476"><a href="back.html#cb22-476" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">getRoleId</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Long</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-477"><a href="back.html#cb22-477" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userService<span class="op">.</span><span class="fu">getBaseMapper</span><span class="op">().</span><span class="fu">selectOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">).</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;username&quot;</span><span class="op">,</span> <span class="st">&quot;email&quot;</span><span class="op">,</span> <span class="st">&quot;role&quot;</span><span class="op">,</span> <span class="st">&quot;avatar&quot;</span><span class="op">,</span> <span class="st">&quot;status&quot;</span><span class="op">));</span></span>
<span id="cb22-478"><a href="back.html#cb22-478" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb22-479"><a href="back.html#cb22-479" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-480"><a href="back.html#cb22-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-481"><a href="back.html#cb22-481" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-482"><a href="back.html#cb22-482" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">踢人下线</span></span>
<span id="cb22-483"><a href="back.html#cb22-483" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param id</span>
<span id="cb22-484"><a href="back.html#cb22-484" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-485"><a href="back.html#cb22-485" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-486"><a href="back.html#cb22-486" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-487"><a href="back.html#cb22-487" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-488"><a href="back.html#cb22-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/roleKick/{id}&quot;</span><span class="op">)</span></span>
<span id="cb22-489"><a href="back.html#cb22-489" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">roleKick</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Long</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-490"><a href="back.html#cb22-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-491"><a href="back.html#cb22-491" aria-hidden="true" tabindex="-1"></a>        <span class="co">//先进行锁定</span></span>
<span id="cb22-492"><a href="back.html#cb22-492" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> update <span class="op">=</span> userService<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="kw">new</span> UpdateWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">).</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;status&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb22-493"><a href="back.html#cb22-493" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;锁定失败&quot;</span><span class="op">);</span></span>
<span id="cb22-494"><a href="back.html#cb22-494" aria-hidden="true" tabindex="-1"></a>        <span class="co">//再对缓存进行更新赋值操作</span></span>
<span id="cb22-495"><a href="back.html#cb22-495" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb22-496"><a href="back.html#cb22-496" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> jwt <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">generateToken</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb22-497"><a href="back.html#cb22-497" aria-hidden="true" tabindex="-1"></a>        <span class="bu">HashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb22-498"><a href="back.html#cb22-498" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_OBJECT</span><span class="op">,</span> user<span class="op">);</span></span>
<span id="cb22-499"><a href="back.html#cb22-499" aria-hidden="true" tabindex="-1"></a>        map<span class="op">.</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">TOKEN</span><span class="op">,</span> jwt<span class="op">);</span></span>
<span id="cb22-500"><a href="back.html#cb22-500" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">putAll</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> id<span class="op">,</span> map<span class="op">);</span></span>
<span id="cb22-501"><a href="back.html#cb22-501" aria-hidden="true" tabindex="-1"></a>        <span class="co">//强制锁6小时</span></span>
<span id="cb22-502"><a href="back.html#cb22-502" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">USER_PREFIX</span> <span class="op">+</span> id<span class="op">,</span> <span class="dv">6</span> <span class="op">*</span> <span class="dv">10</span> <span class="op">*</span> <span class="dv">60</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">SECONDS</span><span class="op">);</span></span>
<span id="cb22-503"><a href="back.html#cb22-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-504"><a href="back.html#cb22-504" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-505"><a href="back.html#cb22-505" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-506"><a href="back.html#cb22-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-507"><a href="back.html#cb22-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-508"><a href="back.html#cb22-508" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb22-509"><a href="back.html#cb22-509" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">密码修改</span></span>
<span id="cb22-510"><a href="back.html#cb22-510" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param passwordDto</span>
<span id="cb22-511"><a href="back.html#cb22-511" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb22-512"><a href="back.html#cb22-512" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb22-513"><a href="back.html#cb22-513" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb22-514"><a href="back.html#cb22-514" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb22-515"><a href="back.html#cb22-515" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/modifyPassword&quot;</span><span class="op">)</span></span>
<span id="cb22-516"><a href="back.html#cb22-516" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">getPassword</span><span class="op">(</span><span class="at">@Validated</span> <span class="at">@RequestBody</span> PasswordDto passwordDto<span class="op">)</span> <span class="op">{</span></span>
<span id="cb22-517"><a href="back.html#cb22-517" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> update <span class="op">=</span> userService<span class="op">.</span><span class="fu">update</span><span class="op">(</span><span class="kw">new</span> UpdateWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">,</span> passwordDto<span class="op">.</span><span class="fu">getUsername</span><span class="op">()).</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;password&quot;</span><span class="op">,</span> SecureUtil<span class="op">.</span><span class="fu">md5</span><span class="op">(</span>passwordDto<span class="op">.</span><span class="fu">getPassword</span><span class="op">())));</span></span>
<span id="cb22-518"><a href="back.html#cb22-518" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">isTrue</span><span class="op">(</span>update<span class="op">,</span> <span class="st">&quot;修改密码失败&quot;</span><span class="op">);</span></span>
<span id="cb22-519"><a href="back.html#cb22-519" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb22-520"><a href="back.html#cb22-520" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb22-521"><a href="back.html#cb22-521" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-522"><a href="back.html#cb22-522" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb23-1"><a href="back.html#cb23-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2"><a href="back.html#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb23-3"><a href="back.html#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="back.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryWrapper</span><span class="op">;</span></span>
<span id="cb23-5"><a href="back.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">metadata</span><span class="op">.</span><span class="im">IPage</span><span class="op">;</span></span>
<span id="cb23-6"><a href="back.html#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">plugins</span><span class="op">.</span><span class="im">pagination</span><span class="op">.</span><span class="im">Page</span><span class="op">;</span></span>
<span id="cb23-7"><a href="back.html#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">cache</span><span class="op">.</span><span class="im">Cache</span><span class="op">;</span></span>
<span id="cb23-8"><a href="back.html#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Const</span><span class="op">;</span></span>
<span id="cb23-9"><a href="back.html#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb23-10"><a href="back.html#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb23-11"><a href="back.html#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">.</span><span class="im">BlogPostDocument</span><span class="op">;</span></span>
<span id="cb23-12"><a href="back.html#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">BlogService</span><span class="op">;</span></span>
<span id="cb23-13"><a href="back.html#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb23-14"><a href="back.html#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">MyUtils</span><span class="op">;</span></span>
<span id="cb23-15"><a href="back.html#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb23-16"><a href="back.html#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">AuthenticationException</span><span class="op">;</span></span>
<span id="cb23-17"><a href="back.html#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Logical</span><span class="op">;</span></span>
<span id="cb23-18"><a href="back.html#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresAuthentication</span><span class="op">;</span></span>
<span id="cb23-19"><a href="back.html#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresRoles</span><span class="op">;</span></span>
<span id="cb23-20"><a href="back.html#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">ResourceNotFoundException</span><span class="op">;</span></span>
<span id="cb23-21"><a href="back.html#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">index</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">MultiMatchQueryBuilder</span><span class="op">;</span></span>
<span id="cb23-22"><a href="back.html#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">index</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryBuilders</span><span class="op">;</span></span>
<span id="cb23-23"><a href="back.html#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">sort</span><span class="op">.</span><span class="im">SortBuilders</span><span class="op">;</span></span>
<span id="cb23-24"><a href="back.html#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">sort</span><span class="op">.</span><span class="im">SortOrder</span><span class="op">;</span></span>
<span id="cb23-25"><a href="back.html#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">AmqpTemplate</span><span class="op">;</span></span>
<span id="cb23-26"><a href="back.html#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb23-27"><a href="back.html#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">ElasticsearchRestTemplate</span><span class="op">;</span></span>
<span id="cb23-28"><a href="back.html#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">SearchHit</span><span class="op">;</span></span>
<span id="cb23-29"><a href="back.html#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">SearchHits</span><span class="op">;</span></span>
<span id="cb23-30"><a href="back.html#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">NativeSearchQuery</span><span class="op">;</span></span>
<span id="cb23-31"><a href="back.html#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">NativeSearchQueryBuilder</span><span class="op">;</span></span>
<span id="cb23-32"><a href="back.html#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb23-33"><a href="back.html#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Assert</span><span class="op">;</span></span>
<span id="cb23-34"><a href="back.html#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.*;</span></span>
<span id="cb23-35"><a href="back.html#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">LocalDateTime</span><span class="op">;</span></span>
<span id="cb23-36"><a href="back.html#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">ArrayList</span><span class="op">;</span></span>
<span id="cb23-37"><a href="back.html#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">TimeUnit</span><span class="op">;</span></span>
<span id="cb23-38"><a href="back.html#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="back.html#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb23-40"><a href="back.html#cb23-40" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;p&gt;</span></span>
<span id="cb23-41"><a href="back.html#cb23-41" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">前台博客操作</span></span>
<span id="cb23-42"><a href="back.html#cb23-42" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="kw">&lt;/p&gt;</span></span>
<span id="cb23-43"><a href="back.html#cb23-43" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb23-44"><a href="back.html#cb23-44" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>since <span class="co">2020-05-25</span></span>
<span id="cb23-45"><a href="back.html#cb23-45" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb23-46"><a href="back.html#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb23-47"><a href="back.html#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb23-48"><a href="back.html#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> BlogController <span class="op">{</span></span>
<span id="cb23-49"><a href="back.html#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="back.html#cb23-50" aria-hidden="true" tabindex="-1"></a>    BlogService blogService<span class="op">;</span></span>
<span id="cb23-51"><a href="back.html#cb23-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-52"><a href="back.html#cb23-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb23-53"><a href="back.html#cb23-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setBlogServiceImpl</span><span class="op">(</span>BlogService blogService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-54"><a href="back.html#cb23-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">blogService</span> <span class="op">=</span> blogService<span class="op">;</span></span>
<span id="cb23-55"><a href="back.html#cb23-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-56"><a href="back.html#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="back.html#cb23-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-58"><a href="back.html#cb23-58" aria-hidden="true" tabindex="-1"></a>    UserService userService<span class="op">;</span></span>
<span id="cb23-59"><a href="back.html#cb23-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-60"><a href="back.html#cb23-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb23-61"><a href="back.html#cb23-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setUserServiceImpl</span><span class="op">(</span>UserService userService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-62"><a href="back.html#cb23-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userService</span> <span class="op">=</span> userService<span class="op">;</span></span>
<span id="cb23-63"><a href="back.html#cb23-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-64"><a href="back.html#cb23-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-65"><a href="back.html#cb23-65" aria-hidden="true" tabindex="-1"></a>    RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb23-66"><a href="back.html#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="back.html#cb23-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb23-68"><a href="back.html#cb23-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setRedisTemplateImpl</span><span class="op">(</span>RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-69"><a href="back.html#cb23-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">redisTemplate</span> <span class="op">=</span> redisTemplate<span class="op">;</span></span>
<span id="cb23-70"><a href="back.html#cb23-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-71"><a href="back.html#cb23-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-72"><a href="back.html#cb23-72" aria-hidden="true" tabindex="-1"></a>    ElasticsearchRestTemplate elasticsearchRestTemplate<span class="op">;</span></span>
<span id="cb23-73"><a href="back.html#cb23-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-74"><a href="back.html#cb23-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb23-75"><a href="back.html#cb23-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setElasticsearchRestTemplate</span><span class="op">(</span>ElasticsearchRestTemplate elasticsearchRestTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-76"><a href="back.html#cb23-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">elasticsearchRestTemplate</span> <span class="op">=</span> elasticsearchRestTemplate<span class="op">;</span></span>
<span id="cb23-77"><a href="back.html#cb23-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-78"><a href="back.html#cb23-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-79"><a href="back.html#cb23-79" aria-hidden="true" tabindex="-1"></a>    AmqpTemplate amqpTemplate<span class="op">;</span></span>
<span id="cb23-80"><a href="back.html#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="back.html#cb23-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb23-82"><a href="back.html#cb23-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setAmqpTemplate</span><span class="op">(</span>AmqpTemplate amqpTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-83"><a href="back.html#cb23-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">amqpTemplate</span> <span class="op">=</span> amqpTemplate<span class="op">;</span></span>
<span id="cb23-84"><a href="back.html#cb23-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-85"><a href="back.html#cb23-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-86"><a href="back.html#cb23-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb23-87"><a href="back.html#cb23-87" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">按照年份给出博客内容</span></span>
<span id="cb23-88"><a href="back.html#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param currentPage</span>
<span id="cb23-89"><a href="back.html#cb23-89" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>param year</span>
<span id="cb23-90"><a href="back.html#cb23-90" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb23-91"><a href="back.html#cb23-91" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb23-92"><a href="back.html#cb23-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-93"><a href="back.html#cb23-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/blogsByYear/{year}/{currentPage}&quot;</span><span class="op">)</span></span>
<span id="cb23-94"><a href="back.html#cb23-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">listByYear</span><span class="op">(</span><span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;currentPage&quot;</span><span class="op">)</span> <span class="bu">Integer</span> currentPage<span class="op">,</span> <span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;year&quot;</span><span class="op">)</span> <span class="bu">Integer</span> year<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-95"><a href="back.html#cb23-95" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了检索方法&quot;</span><span class="op">);</span></span>
<span id="cb23-96"><a href="back.html#cb23-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-97"><a href="back.html#cb23-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-98"><a href="back.html#cb23-98" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> <span class="kw">new</span> Page<span class="op">&lt;&gt;(</span>currentPage<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb23-99"><a href="back.html#cb23-99" aria-hidden="true" tabindex="-1"></a>        QueryWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;</span> queryWrapper <span class="op">=</span> <span class="kw">new</span> QueryWrapper<span class="op">&lt;&gt;();</span></span>
<span id="cb23-100"><a href="back.html#cb23-100" aria-hidden="true" tabindex="-1"></a>        LocalDateTime start <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span>year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb23-101"><a href="back.html#cb23-101" aria-hidden="true" tabindex="-1"></a>        LocalDateTime end <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span>year<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span><span class="op">,</span> <span class="dv">23</span><span class="op">,</span> <span class="dv">59</span><span class="op">,</span> <span class="dv">59</span><span class="op">);</span></span>
<span id="cb23-102"><a href="back.html#cb23-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-103"><a href="back.html#cb23-103" aria-hidden="true" tabindex="-1"></a>        QueryWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;</span> wrapper <span class="op">=</span> queryWrapper<span class="op">.</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">,</span> <span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">between</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">,</span> start<span class="op">,</span> end<span class="op">).</span><span class="fu">orderByAsc</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">);</span></span>
<span id="cb23-104"><a href="back.html#cb23-104" aria-hidden="true" tabindex="-1"></a>        IPage<span class="op">&lt;</span>Blog<span class="op">&gt;</span> pageData <span class="op">=</span> blogService<span class="op">.</span><span class="fu">page</span><span class="op">(</span>page<span class="op">,</span> wrapper<span class="op">);</span></span>
<span id="cb23-105"><a href="back.html#cb23-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-106"><a href="back.html#cb23-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>pageData<span class="op">);</span></span>
<span id="cb23-107"><a href="back.html#cb23-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-108"><a href="back.html#cb23-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-109"><a href="back.html#cb23-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/getCountByYear/{year}&quot;</span><span class="op">)</span></span>
<span id="cb23-110"><a href="back.html#cb23-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">getCountByYear</span><span class="op">(</span><span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;year&quot;</span><span class="op">)</span> <span class="bu">Integer</span> year<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-111"><a href="back.html#cb23-111" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Integer</span> count <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getYearCount</span><span class="op">(</span>year<span class="op">);</span></span>
<span id="cb23-112"><a href="back.html#cb23-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>count<span class="op">);</span></span>
<span id="cb23-113"><a href="back.html#cb23-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-114"><a href="back.html#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="back.html#cb23-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb23-116"><a href="back.html#cb23-116" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">所有博客内容</span></span>
<span id="cb23-117"><a href="back.html#cb23-117" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param currentPage</span>
<span id="cb23-118"><a href="back.html#cb23-118" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb23-119"><a href="back.html#cb23-119" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb23-120"><a href="back.html#cb23-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Cache</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;hot_blogs&quot;</span><span class="op">)</span><span class="co">//缓存页面信息一分钟</span></span>
<span id="cb23-121"><a href="back.html#cb23-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/blogs/{currentPage}&quot;</span><span class="op">)</span></span>
<span id="cb23-122"><a href="back.html#cb23-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">list</span><span class="op">(</span><span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;currentPage&quot;</span><span class="op">)</span> <span class="bu">Integer</span> currentPage<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-123"><a href="back.html#cb23-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-124"><a href="back.html#cb23-124" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了检索方法&quot;</span><span class="op">);</span></span>
<span id="cb23-125"><a href="back.html#cb23-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-126"><a href="back.html#cb23-126" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> totalPage <span class="op">=</span> blogService<span class="op">.</span><span class="fu">count</span><span class="op">()</span> <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> blogService<span class="op">.</span><span class="fu">count</span><span class="op">()</span> <span class="op">/</span> <span class="dv">5</span> <span class="op">:</span> blogService<span class="op">.</span><span class="fu">count</span><span class="op">()</span> <span class="op">/</span> <span class="dv">5</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb23-127"><a href="back.html#cb23-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-128"><a href="back.html#cb23-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>currentPage <span class="op">&gt;</span> totalPage<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-129"><a href="back.html#cb23-129" aria-hidden="true" tabindex="-1"></a>            Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> <span class="kw">new</span> Page<span class="op">&lt;&gt;(</span>totalPage<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb23-130"><a href="back.html#cb23-130" aria-hidden="true" tabindex="-1"></a>            IPage<span class="op">&lt;</span>Blog<span class="op">&gt;</span> pageData <span class="op">=</span> blogService<span class="op">.</span><span class="fu">page</span><span class="op">(</span>page<span class="op">,</span> <span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;().</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">,</span> <span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">orderByDesc</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">));</span></span>
<span id="cb23-131"><a href="back.html#cb23-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>pageData<span class="op">);</span></span>
<span id="cb23-132"><a href="back.html#cb23-132" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-133"><a href="back.html#cb23-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-134"><a href="back.html#cb23-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>totalPage <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-135"><a href="back.html#cb23-135" aria-hidden="true" tabindex="-1"></a>            Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> <span class="kw">new</span> Page<span class="op">&lt;&gt;(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb23-136"><a href="back.html#cb23-136" aria-hidden="true" tabindex="-1"></a>            IPage<span class="op">&lt;</span>Blog<span class="op">&gt;</span> pageData <span class="op">=</span> blogService<span class="op">.</span><span class="fu">page</span><span class="op">(</span>page<span class="op">,</span> <span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;().</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">,</span> <span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">orderByDesc</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">));</span></span>
<span id="cb23-137"><a href="back.html#cb23-137" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>pageData<span class="op">);</span></span>
<span id="cb23-138"><a href="back.html#cb23-138" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-139"><a href="back.html#cb23-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-140"><a href="back.html#cb23-140" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>Blog<span class="op">&gt;</span> page <span class="op">=</span> <span class="kw">new</span> Page<span class="op">&lt;&gt;(</span>currentPage<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb23-141"><a href="back.html#cb23-141" aria-hidden="true" tabindex="-1"></a>        IPage<span class="op">&lt;</span>Blog<span class="op">&gt;</span> pageData <span class="op">=</span> blogService<span class="op">.</span><span class="fu">page</span><span class="op">(</span>page<span class="op">,</span> <span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;().</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">,</span> <span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">orderByDesc</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">));</span></span>
<span id="cb23-142"><a href="back.html#cb23-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-143"><a href="back.html#cb23-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>pageData<span class="op">);</span></span>
<span id="cb23-144"><a href="back.html#cb23-144" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-145"><a href="back.html#cb23-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-146"><a href="back.html#cb23-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-147"><a href="back.html#cb23-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb23-148"><a href="back.html#cb23-148" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">博客详情</span></span>
<span id="cb23-149"><a href="back.html#cb23-149" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param id</span>
<span id="cb23-150"><a href="back.html#cb23-150" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">@</span>return</span>
<span id="cb23-151"><a href="back.html#cb23-151" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb23-152"><a href="back.html#cb23-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-153"><a href="back.html#cb23-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/blog/{id}&quot;</span><span class="op">)</span></span>
<span id="cb23-154"><a href="back.html#cb23-154" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">detail</span><span class="op">(</span><span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="bu">Long</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-155"><a href="back.html#cb23-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-156"><a href="back.html#cb23-156" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了博客详情方法&quot;</span><span class="op">);</span></span>
<span id="cb23-157"><a href="back.html#cb23-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-158"><a href="back.html#cb23-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>id<span class="op">).</span><span class="fu">getStatus</span><span class="op">()</span> <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-159"><a href="back.html#cb23-159" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">AuthenticationException</span><span class="op">(</span><span class="st">&quot;没有访问权限&quot;</span><span class="op">);</span></span>
<span id="cb23-160"><a href="back.html#cb23-160" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-161"><a href="back.html#cb23-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-162"><a href="back.html#cb23-162" aria-hidden="true" tabindex="-1"></a>        Blog blog <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getBaseMapper</span><span class="op">().</span><span class="fu">selectOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>Blog<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;status&quot;</span><span class="op">,</span> <span class="dv">0</span><span class="op">).</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> id<span class="op">));</span></span>
<span id="cb23-163"><a href="back.html#cb23-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-164"><a href="back.html#cb23-164" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">notNull</span><span class="op">(</span>blog<span class="op">,</span> <span class="st">&quot;该博客不存在&quot;</span><span class="op">);</span></span>
<span id="cb23-165"><a href="back.html#cb23-165" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">increment</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_SUM</span><span class="op">,</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> id <span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb23-166"><a href="back.html#cb23-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> id<span class="op">)</span> <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-167"><a href="back.html#cb23-167" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> id<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">DAYS</span><span class="op">);</span></span>
<span id="cb23-168"><a href="back.html#cb23-168" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb23-169"><a href="back.html#cb23-169" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">increment</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> id<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb23-170"><a href="back.html#cb23-170" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-171"><a href="back.html#cb23-171" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb23-172"><a href="back.html#cb23-172" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-173"><a href="back.html#cb23-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-174"><a href="back.html#cb23-174" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/blogAuthorized/{id}&quot;</span><span class="op">)</span></span>
<span id="cb23-175"><a href="back.html#cb23-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb23-176"><a href="back.html#cb23-176" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span>value <span class="op">=</span> <span class="op">{</span><span class="st">&quot;admin&quot;</span><span class="op">,</span> <span class="st">&quot;guest&quot;</span><span class="op">},</span> logical <span class="op">=</span> Logical<span class="op">.</span><span class="fu">OR</span><span class="op">)</span></span>
<span id="cb23-177"><a href="back.html#cb23-177" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">detailAuthorized</span><span class="op">(</span><span class="at">@PathVariable</span><span class="op">(</span>name <span class="op">=</span> <span class="st">&quot;id&quot;</span><span class="op">)</span> <span class="bu">Long</span> id<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-178"><a href="back.html#cb23-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-179"><a href="back.html#cb23-179" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了博客详情的授权方法&quot;</span><span class="op">);</span></span>
<span id="cb23-180"><a href="back.html#cb23-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-181"><a href="back.html#cb23-181" aria-hidden="true" tabindex="-1"></a>        Blog blog <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb23-182"><a href="back.html#cb23-182" aria-hidden="true" tabindex="-1"></a>        Assert<span class="op">.</span><span class="fu">notNull</span><span class="op">(</span>blog<span class="op">,</span> <span class="st">&quot;该博客不存在&quot;</span><span class="op">);</span></span>
<span id="cb23-183"><a href="back.html#cb23-183" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">increment</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_SUM</span><span class="op">,</span> <span class="st">&quot;&quot;</span> <span class="op">+</span> id <span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb23-184"><a href="back.html#cb23-184" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> id<span class="op">)</span> <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-185"><a href="back.html#cb23-185" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> id<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">DAYS</span><span class="op">);</span></span>
<span id="cb23-186"><a href="back.html#cb23-186" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb23-187"><a href="back.html#cb23-187" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">increment</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">READ_RECENT</span> <span class="op">+</span> id<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb23-188"><a href="back.html#cb23-188" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-189"><a href="back.html#cb23-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb23-190"><a href="back.html#cb23-190" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-191"><a href="back.html#cb23-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-192"><a href="back.html#cb23-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-193"><a href="back.html#cb23-193" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb23-194"><a href="back.html#cb23-194" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">搜索功能，从</span>es<span class="co">搜索</span></span>
<span id="cb23-195"><a href="back.html#cb23-195" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb23-196"><a href="back.html#cb23-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/search/{currentPage}&quot;</span><span class="op">)</span></span>
<span id="cb23-197"><a href="back.html#cb23-197" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">search</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Integer</span> currentPage<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">String</span> keyword<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-198"><a href="back.html#cb23-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-199"><a href="back.html#cb23-199" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了搜索方法&quot;</span><span class="op">);</span></span>
<span id="cb23-200"><a href="back.html#cb23-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-201"><a href="back.html#cb23-201" aria-hidden="true" tabindex="-1"></a>        MultiMatchQueryBuilder multiMatchQueryBuilder <span class="op">=</span> QueryBuilders<span class="op">.</span><span class="fu">multiMatchQuery</span><span class="op">(</span>keyword<span class="op">,</span> <span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">,</span> <span class="st">&quot;content&quot;</span><span class="op">);</span></span>
<span id="cb23-202"><a href="back.html#cb23-202" aria-hidden="true" tabindex="-1"></a>        NativeSearchQuery nativeSearchQuery <span class="op">=</span> <span class="kw">new</span> <span class="fu">NativeSearchQueryBuilder</span><span class="op">()</span></span>
<span id="cb23-203"><a href="back.html#cb23-203" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withQuery</span><span class="op">(</span>multiMatchQueryBuilder<span class="op">)</span></span>
<span id="cb23-204"><a href="back.html#cb23-204" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withSort</span><span class="op">(</span>SortBuilders<span class="op">.</span><span class="fu">fieldSort</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">order</span><span class="op">(</span><span class="bu">SortOrder</span><span class="op">.</span><span class="fu">DESC</span><span class="op">))</span></span>
<span id="cb23-205"><a href="back.html#cb23-205" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb23-206"><a href="back.html#cb23-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-207"><a href="back.html#cb23-207" aria-hidden="true" tabindex="-1"></a>        SearchHits<span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> search <span class="op">=</span> elasticsearchRestTemplate<span class="op">.</span><span class="fu">search</span><span class="op">(</span>nativeSearchQuery<span class="op">,</span> BlogPostDocument<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb23-208"><a href="back.html#cb23-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-209"><a href="back.html#cb23-209" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>search<span class="op">.</span><span class="fu">getTotalHits</span><span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-210"><a href="back.html#cb23-210" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ResourceNotFoundException</span><span class="op">(</span><span class="st">&quot;没有相关记录&quot;</span><span class="op">);</span></span>
<span id="cb23-211"><a href="back.html#cb23-211" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-212"><a href="back.html#cb23-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-213"><a href="back.html#cb23-213" aria-hidden="true" tabindex="-1"></a><span class="co">//        List&lt;SearchHit&lt;BlogPostDocument&gt;&gt; list = search.getSearchHits();</span></span>
<span id="cb23-214"><a href="back.html#cb23-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-215"><a href="back.html#cb23-215" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ArrayList</span><span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb23-216"><a href="back.html#cb23-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-217"><a href="back.html#cb23-217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>SearchHit<span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> hit <span class="op">:</span> search<span class="op">.</span><span class="fu">getSearchHits</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb23-218"><a href="back.html#cb23-218" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">add</span><span class="op">(</span>hit<span class="op">.</span><span class="fu">getContent</span><span class="op">());</span></span>
<span id="cb23-219"><a href="back.html#cb23-219" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-220"><a href="back.html#cb23-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-221"><a href="back.html#cb23-221" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> page <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">listToPage</span><span class="op">(</span>list<span class="op">,</span> currentPage<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb23-222"><a href="back.html#cb23-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-223"><a href="back.html#cb23-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb23-224"><a href="back.html#cb23-224" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-225"><a href="back.html#cb23-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-226"><a href="back.html#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-227"><a href="back.html#cb23-227" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/searchByYear/{currentPage}/{year}&quot;</span><span class="op">)</span></span>
<span id="cb23-228"><a href="back.html#cb23-228" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">searchByYear</span><span class="op">(</span><span class="at">@PathVariable</span> <span class="bu">Integer</span> currentPage<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">String</span> keyword<span class="op">,</span> <span class="at">@PathVariable</span> <span class="bu">Integer</span> year<span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-229"><a href="back.html#cb23-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-230"><a href="back.html#cb23-230" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;进入了搜索方法&quot;</span><span class="op">);</span></span>
<span id="cb23-231"><a href="back.html#cb23-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-232"><a href="back.html#cb23-232" aria-hidden="true" tabindex="-1"></a>        MultiMatchQueryBuilder multiMatchQueryBuilder <span class="op">=</span> QueryBuilders<span class="op">.</span><span class="fu">multiMatchQuery</span><span class="op">(</span>keyword<span class="op">,</span> <span class="st">&quot;title&quot;</span><span class="op">,</span> <span class="st">&quot;description&quot;</span><span class="op">,</span> <span class="st">&quot;content&quot;</span><span class="op">);</span></span>
<span id="cb23-233"><a href="back.html#cb23-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-234"><a href="back.html#cb23-234" aria-hidden="true" tabindex="-1"></a>        NativeSearchQuery nativeSearchQuery <span class="op">=</span> <span class="kw">new</span> <span class="fu">NativeSearchQueryBuilder</span><span class="op">()</span></span>
<span id="cb23-235"><a href="back.html#cb23-235" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withQuery</span><span class="op">(</span>QueryBuilders<span class="op">.</span><span class="fu">boolQuery</span><span class="op">()</span></span>
<span id="cb23-236"><a href="back.html#cb23-236" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">must</span><span class="op">(</span>QueryBuilders<span class="op">.</span><span class="fu">rangeQuery</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">gte</span><span class="op">(</span>year <span class="op">+</span> <span class="st">&quot;-01-01T00:00:00&quot;</span><span class="op">).</span><span class="fu">lte</span><span class="op">(</span>year <span class="op">+</span> <span class="st">&quot;-12-31T23:59:59&quot;</span><span class="op">)</span></span>
<span id="cb23-237"><a href="back.html#cb23-237" aria-hidden="true" tabindex="-1"></a>                                <span class="op">.</span><span class="fu">includeUpper</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb23-238"><a href="back.html#cb23-238" aria-hidden="true" tabindex="-1"></a>                                <span class="op">.</span><span class="fu">includeLower</span><span class="op">(</span><span class="kw">true</span><span class="op">))</span></span>
<span id="cb23-239"><a href="back.html#cb23-239" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">must</span><span class="op">(</span>multiMatchQueryBuilder<span class="op">))</span></span>
<span id="cb23-240"><a href="back.html#cb23-240" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">withSort</span><span class="op">(</span>SortBuilders<span class="op">.</span><span class="fu">fieldSort</span><span class="op">(</span><span class="st">&quot;created&quot;</span><span class="op">).</span><span class="fu">order</span><span class="op">(</span><span class="bu">SortOrder</span><span class="op">.</span><span class="fu">DESC</span><span class="op">))</span></span>
<span id="cb23-241"><a href="back.html#cb23-241" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb23-242"><a href="back.html#cb23-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-243"><a href="back.html#cb23-243" aria-hidden="true" tabindex="-1"></a>        SearchHits<span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> search <span class="op">=</span> elasticsearchRestTemplate<span class="op">.</span><span class="fu">search</span><span class="op">(</span>nativeSearchQuery<span class="op">,</span> BlogPostDocument<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb23-244"><a href="back.html#cb23-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-245"><a href="back.html#cb23-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>search<span class="op">.</span><span class="fu">getTotalHits</span><span class="op">()</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb23-246"><a href="back.html#cb23-246" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ResourceNotFoundException</span><span class="op">(</span><span class="st">&quot;没有相关记录&quot;</span><span class="op">);</span></span>
<span id="cb23-247"><a href="back.html#cb23-247" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-248"><a href="back.html#cb23-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-249"><a href="back.html#cb23-249" aria-hidden="true" tabindex="-1"></a>        <span class="bu">ArrayList</span><span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> list <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb23-250"><a href="back.html#cb23-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-251"><a href="back.html#cb23-251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>SearchHit<span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> hit <span class="op">:</span> search<span class="op">.</span><span class="fu">getSearchHits</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb23-252"><a href="back.html#cb23-252" aria-hidden="true" tabindex="-1"></a>            list<span class="op">.</span><span class="fu">add</span><span class="op">(</span>hit<span class="op">.</span><span class="fu">getContent</span><span class="op">());</span></span>
<span id="cb23-253"><a href="back.html#cb23-253" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb23-254"><a href="back.html#cb23-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-255"><a href="back.html#cb23-255" aria-hidden="true" tabindex="-1"></a>        Page<span class="op">&lt;</span>BlogPostDocument<span class="op">&gt;</span> page <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">listToPage</span><span class="op">(</span>list<span class="op">,</span> currentPage<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb23-256"><a href="back.html#cb23-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-257"><a href="back.html#cb23-257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>page<span class="op">);</span></span>
<span id="cb23-258"><a href="back.html#cb23-258" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb23-259"><a href="back.html#cb23-259" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb24-1"><a href="back.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb24-2"><a href="back.html#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="back.html#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb24-4"><a href="back.html#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb24-5"><a href="back.html#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">.</span><span class="im">BlogPostDocument</span><span class="op">;</span></span>
<span id="cb24-6"><a href="back.html#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">BlogService</span><span class="op">;</span></span>
<span id="cb24-7"><a href="back.html#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">MyUtils</span><span class="op">;</span></span>
<span id="cb24-8"><a href="back.html#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb24-9"><a href="back.html#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresAuthentication</span><span class="op">;</span></span>
<span id="cb24-10"><a href="back.html#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresRoles</span><span class="op">;</span></span>
<span id="cb24-11"><a href="back.html#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb24-12"><a href="back.html#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">ElasticsearchRestTemplate</span><span class="op">;</span></span>
<span id="cb24-13"><a href="back.html#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Controller</span><span class="op">;</span></span>
<span id="cb24-14"><a href="back.html#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">GetMapping</span><span class="op">;</span></span>
<span id="cb24-15"><a href="back.html#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">List</span><span class="op">;</span></span>
<span id="cb24-16"><a href="back.html#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="back.html#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb24-18"><a href="back.html#cb24-18" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">用于将原来的日志同步到</span>es<span class="co">中，要求最高权限才能执行</span></span>
<span id="cb24-19"><a href="back.html#cb24-19" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">用</span>postman<span class="co">发请求执行，前端不做按钮</span></span>
<span id="cb24-20"><a href="back.html#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb24-21"><a href="back.html#cb24-21" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-14</span> <span class="co">12:14</span> AM</span>
<span id="cb24-22"><a href="back.html#cb24-22" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb24-23"><a href="back.html#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb24-24"><a href="back.html#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb24-25"><a href="back.html#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SyncController <span class="op">{</span></span>
<span id="cb24-26"><a href="back.html#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="back.html#cb24-27" aria-hidden="true" tabindex="-1"></a>    BlogService blogService<span class="op">;</span></span>
<span id="cb24-28"><a href="back.html#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="back.html#cb24-29" aria-hidden="true" tabindex="-1"></a>    ElasticsearchRestTemplate elasticsearchRestTemplate<span class="op">;</span></span>
<span id="cb24-30"><a href="back.html#cb24-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-31"><a href="back.html#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb24-32"><a href="back.html#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setBlogService</span><span class="op">(</span>BlogService blogService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-33"><a href="back.html#cb24-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">blogService</span> <span class="op">=</span> blogService<span class="op">;</span></span>
<span id="cb24-34"><a href="back.html#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-35"><a href="back.html#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="back.html#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb24-37"><a href="back.html#cb24-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setElasticsearchRestTemplate</span><span class="op">(</span>ElasticsearchRestTemplate elasticsearchRestTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-38"><a href="back.html#cb24-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">elasticsearchRestTemplate</span> <span class="op">=</span> elasticsearchRestTemplate<span class="op">;</span></span>
<span id="cb24-39"><a href="back.html#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-40"><a href="back.html#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="back.html#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/sync&quot;</span><span class="op">)</span></span>
<span id="cb24-42"><a href="back.html#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb24-43"><a href="back.html#cb24-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresRoles</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">)</span></span>
<span id="cb24-44"><a href="back.html#cb24-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">sync</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb24-45"><a href="back.html#cb24-45" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;开始同步&quot;</span><span class="op">);</span></span>
<span id="cb24-46"><a href="back.html#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="back.html#cb24-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span>Blog<span class="op">&gt;</span> blogs <span class="op">=</span> blogService<span class="op">.</span><span class="fu">list</span><span class="op">();</span></span>
<span id="cb24-48"><a href="back.html#cb24-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Blog blog <span class="op">:</span> blogs<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-49"><a href="back.html#cb24-49" aria-hidden="true" tabindex="-1"></a>            BlogPostDocument document <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">blogToDocument</span><span class="op">(</span>blog<span class="op">);</span></span>
<span id="cb24-50"><a href="back.html#cb24-50" aria-hidden="true" tabindex="-1"></a>            elasticsearchRestTemplate<span class="op">.</span><span class="fu">save</span><span class="op">(</span>document<span class="op">);</span></span>
<span id="cb24-51"><a href="back.html#cb24-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb24-52"><a href="back.html#cb24-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb24-53"><a href="back.html#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-54"><a href="back.html#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-55"><a href="back.html#cb24-55" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb25-1"><a href="back.html#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb25-2"><a href="back.html#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="back.html#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Const</span><span class="op">;</span></span>
<span id="cb25-4"><a href="back.html#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb25-5"><a href="back.html#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">BlogService</span><span class="op">;</span></span>
<span id="cb25-6"><a href="back.html#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authz</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RequiresAuthentication</span><span class="op">;</span></span>
<span id="cb25-7"><a href="back.html#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">ResourceNotFoundException</span><span class="op">;</span></span>
<span id="cb25-8"><a href="back.html#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb25-9"><a href="back.html#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Value</span><span class="op">;</span></span>
<span id="cb25-10"><a href="back.html#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">FileCopyUtils</span><span class="op">;</span></span>
<span id="cb25-11"><a href="back.html#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.*;</span></span>
<span id="cb25-12"><a href="back.html#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">multipart</span><span class="op">.</span><span class="im">MultipartFile</span><span class="op">;</span></span>
<span id="cb25-13"><a href="back.html#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">http</span><span class="op">.</span><span class="im">HttpServletRequest</span><span class="op">;</span></span>
<span id="cb25-14"><a href="back.html#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">File</span><span class="op">;</span></span>
<span id="cb25-15"><a href="back.html#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">IOException</span><span class="op">;</span></span>
<span id="cb25-16"><a href="back.html#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">UUID</span><span class="op">;</span></span>
<span id="cb25-17"><a href="back.html#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="back.html#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb25-19"><a href="back.html#cb25-19" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">图片上传到</span>img<span class="co">文件夹和删除</span></span>
<span id="cb25-20"><a href="back.html#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb25-21"><a href="back.html#cb25-21" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-11-05</span> <span class="co">5:02</span> PM</span>
<span id="cb25-22"><a href="back.html#cb25-22" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb25-23"><a href="back.html#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb25-24"><a href="back.html#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> UploadController <span class="op">{</span></span>
<span id="cb25-25"><a href="back.html#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="back.html#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${uploadPath}&quot;</span><span class="op">)</span></span>
<span id="cb25-27"><a href="back.html#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> baseFolderPath<span class="op">;</span></span>
<span id="cb25-28"><a href="back.html#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="back.html#cb25-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Value</span><span class="op">(</span><span class="st">&quot;${imgFoldName}&quot;</span><span class="op">)</span></span>
<span id="cb25-30"><a href="back.html#cb25-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> img<span class="op">;</span></span>
<span id="cb25-31"><a href="back.html#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="back.html#cb25-32" aria-hidden="true" tabindex="-1"></a>    BlogService blogService<span class="op">;</span></span>
<span id="cb25-33"><a href="back.html#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="back.html#cb25-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb25-35"><a href="back.html#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setBlogServiceImpl</span><span class="op">(</span>BlogService blogService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-36"><a href="back.html#cb25-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">blogService</span> <span class="op">=</span> blogService<span class="op">;</span></span>
<span id="cb25-37"><a href="back.html#cb25-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-38"><a href="back.html#cb25-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-39"><a href="back.html#cb25-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb25-40"><a href="back.html#cb25-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@PostMapping</span><span class="op">(</span><span class="st">&quot;/upload&quot;</span><span class="op">)</span></span>
<span id="cb25-41"><a href="back.html#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">upload</span><span class="op">(</span><span class="at">@RequestParam</span> MultipartFile image<span class="op">,</span> HttpServletRequest request<span class="op">,</span> <span class="at">@RequestParam</span> <span class="bu">String</span> created<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-42"><a href="back.html#cb25-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>image <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-43"><a href="back.html#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="back.html#cb25-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> filePath<span class="op">;</span></span>
<span id="cb25-45"><a href="back.html#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="back.html#cb25-46" aria-hidden="true" tabindex="-1"></a>            filePath <span class="op">=</span> created<span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot;-&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb25-47"><a href="back.html#cb25-47" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb25-48"><a href="back.html#cb25-48" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot;:&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb25-49"><a href="back.html#cb25-49" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot;T&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb25-50"><a href="back.html#cb25-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-51"><a href="back.html#cb25-51" aria-hidden="true" tabindex="-1"></a>            <span class="bu">File</span> baseFolder <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>baseFolderPath <span class="op">+</span> img <span class="op">+</span> <span class="st">&quot;/&quot;</span> <span class="op">+</span> filePath<span class="op">);</span></span>
<span id="cb25-52"><a href="back.html#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="back.html#cb25-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>baseFolder<span class="op">.</span><span class="fu">exists</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb25-54"><a href="back.html#cb25-54" aria-hidden="true" tabindex="-1"></a>                <span class="dt">boolean</span> b<span class="op">=</span> baseFolder<span class="op">.</span><span class="fu">mkdirs</span><span class="op">();</span></span>
<span id="cb25-55"><a href="back.html#cb25-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-56"><a href="back.html#cb25-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-57"><a href="back.html#cb25-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">StringBuilder</span> url <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">();</span></span>
<span id="cb25-58"><a href="back.html#cb25-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> filename <span class="op">=</span> image<span class="op">.</span><span class="fu">getOriginalFilename</span><span class="op">();</span></span>
<span id="cb25-59"><a href="back.html#cb25-59" aria-hidden="true" tabindex="-1"></a>            <span class="co">//https://blog.csdn.net/Cheguangquan/article/details/104121923</span></span>
<span id="cb25-60"><a href="back.html#cb25-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-61"><a href="back.html#cb25-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>filename <span class="op">==</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-62"><a href="back.html#cb25-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">throw</span> <span class="kw">new</span> <span class="fu">ResourceNotFoundException</span><span class="op">(</span><span class="st">&quot;图片上传出错&quot;</span><span class="op">);</span></span>
<span id="cb25-63"><a href="back.html#cb25-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-64"><a href="back.html#cb25-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-65"><a href="back.html#cb25-65" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> imgName <span class="op">=</span> <span class="bu">UUID</span><span class="op">.</span><span class="fu">randomUUID</span><span class="op">().</span><span class="fu">toString</span><span class="op">()</span></span>
<span id="cb25-66"><a href="back.html#cb25-66" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replace</span><span class="op">(</span><span class="st">&quot;_&quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">)</span></span>
<span id="cb25-67"><a href="back.html#cb25-67" aria-hidden="true" tabindex="-1"></a>                    <span class="op">+</span> <span class="st">&quot;_&quot;</span></span>
<span id="cb25-68"><a href="back.html#cb25-68" aria-hidden="true" tabindex="-1"></a>                    <span class="op">+</span> filename</span>
<span id="cb25-69"><a href="back.html#cb25-69" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">replaceAll</span><span class="op">(</span><span class="st">&quot; &quot;</span><span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb25-70"><a href="back.html#cb25-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-71"><a href="back.html#cb25-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-72"><a href="back.html#cb25-72" aria-hidden="true" tabindex="-1"></a>            url<span class="op">.</span><span class="fu">append</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getScheme</span><span class="op">())</span></span>
<span id="cb25-73"><a href="back.html#cb25-73" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;://&quot;</span><span class="op">)</span></span>
<span id="cb25-74"><a href="back.html#cb25-74" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getServerName</span><span class="op">())</span></span>
<span id="cb25-75"><a href="back.html#cb25-75" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;:&quot;</span><span class="op">)</span></span>
<span id="cb25-76"><a href="back.html#cb25-76" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getServerPort</span><span class="op">())</span></span>
<span id="cb25-77"><a href="back.html#cb25-77" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span>request<span class="op">.</span><span class="fu">getContextPath</span><span class="op">())</span></span>
<span id="cb25-78"><a href="back.html#cb25-78" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">UPLOAD_IMG_PATH</span><span class="op">)</span></span>
<span id="cb25-79"><a href="back.html#cb25-79" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span>filePath<span class="op">)</span></span>
<span id="cb25-80"><a href="back.html#cb25-80" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">)</span></span>
<span id="cb25-81"><a href="back.html#cb25-81" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span><span class="fu">append</span><span class="op">(</span>imgName<span class="op">);</span></span>
<span id="cb25-82"><a href="back.html#cb25-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb25-83"><a href="back.html#cb25-83" aria-hidden="true" tabindex="-1"></a>                <span class="bu">File</span> dest <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>baseFolder<span class="op">,</span> imgName<span class="op">);</span></span>
<span id="cb25-84"><a href="back.html#cb25-84" aria-hidden="true" tabindex="-1"></a>                FileCopyUtils<span class="op">.</span><span class="fu">copy</span><span class="op">(</span>image<span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> dest<span class="op">);</span></span>
<span id="cb25-85"><a href="back.html#cb25-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">IOException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-86"><a href="back.html#cb25-86" aria-hidden="true" tabindex="-1"></a>                e<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb25-87"><a href="back.html#cb25-87" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;上传失败&quot;</span><span class="op">);</span></span>
<span id="cb25-88"><a href="back.html#cb25-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb25-89"><a href="back.html#cb25-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span>url<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb25-90"><a href="back.html#cb25-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-91"><a href="back.html#cb25-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;上传失败&quot;</span><span class="op">);</span></span>
<span id="cb25-92"><a href="back.html#cb25-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-93"><a href="back.html#cb25-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-94"><a href="back.html#cb25-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-95"><a href="back.html#cb25-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RequiresAuthentication</span></span>
<span id="cb25-96"><a href="back.html#cb25-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">@DeleteMapping</span><span class="op">(</span><span class="st">&quot;/delfile&quot;</span><span class="op">)</span></span>
<span id="cb25-97"><a href="back.html#cb25-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">deleteFile</span><span class="op">(</span><span class="at">@RequestParam</span> <span class="bu">String</span> url<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-98"><a href="back.html#cb25-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">//常量是有关url的</span></span>
<span id="cb25-99"><a href="back.html#cb25-99" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> index <span class="op">=</span> url<span class="op">.</span><span class="fu">indexOf</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">UPLOAD_IMG_PATH</span><span class="op">)</span> <span class="op">+</span> Const<span class="op">.</span><span class="fu">UPLOAD_IMG_PATH</span><span class="op">.</span><span class="fu">length</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb25-100"><a href="back.html#cb25-100" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> dest <span class="op">=</span> url<span class="op">.</span><span class="fu">substring</span><span class="op">(</span>index<span class="op">);</span></span>
<span id="cb25-101"><a href="back.html#cb25-101" aria-hidden="true" tabindex="-1"></a>        <span class="co">//配置文件里的是上传服务器的路径</span></span>
<span id="cb25-102"><a href="back.html#cb25-102" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> finalDest <span class="op">=</span> baseFolderPath <span class="op">+</span> img <span class="op">+</span> dest<span class="op">;</span></span>
<span id="cb25-103"><a href="back.html#cb25-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">File</span> file <span class="op">=</span> <span class="kw">new</span> <span class="bu">File</span><span class="op">(</span>finalDest<span class="op">);</span></span>
<span id="cb25-104"><a href="back.html#cb25-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>file<span class="op">.</span><span class="fu">exists</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb25-105"><a href="back.html#cb25-105" aria-hidden="true" tabindex="-1"></a>            <span class="dt">boolean</span> b <span class="op">=</span> file<span class="op">.</span><span class="fu">delete</span><span class="op">();</span></span>
<span id="cb25-106"><a href="back.html#cb25-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">succ</span><span class="op">(</span><span class="st">&quot;删除结果：&quot;</span> <span class="op">+</span> b<span class="op">);</span></span>
<span id="cb25-107"><a href="back.html#cb25-107" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb25-108"><a href="back.html#cb25-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="st">&quot;文件不存在&quot;</span><span class="op">);</span></span>
<span id="cb25-109"><a href="back.html#cb25-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb25-110"><a href="back.html#cb25-110" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-111"><a href="back.html#cb25-111" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>这里关联了mavon-editor的上传和上传删除。</p>
</div>
<div id="redis" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Redis</h2>
<p>主要写配置类</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb26-1"><a href="back.html#cb26-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-2"><a href="back.html#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb26-3"><a href="back.html#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="back.html#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb26-5"><a href="back.html#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb26-6"><a href="back.html#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">connection</span><span class="op">.</span><span class="im">RedisConnectionFactory</span><span class="op">;</span></span>
<span id="cb26-7"><a href="back.html#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb26-8"><a href="back.html#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">serializer</span><span class="op">.</span><span class="im">Jackson2JsonRedisSerializer</span><span class="op">;</span></span>
<span id="cb26-9"><a href="back.html#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">serializer</span><span class="op">.</span><span class="im">StringRedisSerializer</span><span class="op">;</span></span>
<span id="cb26-10"><a href="back.html#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="back.html#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb26-12"><a href="back.html#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb26-13"><a href="back.html#cb26-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-11-20</span> <span class="co">10:03</span> PM</span>
<span id="cb26-14"><a href="back.html#cb26-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb26-15"><a href="back.html#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb26-16"><a href="back.html#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> RedisConfig <span class="op">{</span></span>
<span id="cb26-17"><a href="back.html#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="back.html#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb26-19"><a href="back.html#cb26-19" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">去掉</span>key<span class="co">前面的乱码</span></span>
<span id="cb26-20"><a href="back.html#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>return</span>
<span id="cb26-21"><a href="back.html#cb26-21" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb26-22"><a href="back.html#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb26-23"><a href="back.html#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> <span class="fu">redisTemplateInit</span><span class="op">(</span>RedisConnectionFactory redisConnectionFactory<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-24"><a href="back.html#cb26-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">//设置序列化Key的实例化对象</span></span>
<span id="cb26-25"><a href="back.html#cb26-25" aria-hidden="true" tabindex="-1"></a>        RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate <span class="op">=</span> <span class="kw">new</span> RedisTemplate<span class="op">&lt;&gt;();</span></span>
<span id="cb26-26"><a href="back.html#cb26-26" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">setConnectionFactory</span><span class="op">(</span>redisConnectionFactory<span class="op">);</span></span>
<span id="cb26-27"><a href="back.html#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="back.html#cb26-28" aria-hidden="true" tabindex="-1"></a>        StringRedisSerializer stringRedisSerializer <span class="op">=</span> <span class="kw">new</span> <span class="fu">StringRedisSerializer</span><span class="op">();</span></span>
<span id="cb26-29"><a href="back.html#cb26-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-30"><a href="back.html#cb26-30" aria-hidden="true" tabindex="-1"></a>        Jackson2JsonRedisSerializer<span class="op">&lt;</span><span class="bu">Object</span><span class="op">&gt;</span> jackson2JsonRedisSerializer <span class="op">=</span> <span class="kw">new</span> Jackson2JsonRedisSerializer<span class="op">&lt;&gt;(</span><span class="bu">Object</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb26-31"><a href="back.html#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="back.html#cb26-32" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">setKeySerializer</span><span class="op">(</span>stringRedisSerializer<span class="op">);</span></span>
<span id="cb26-33"><a href="back.html#cb26-33" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">setHashKeySerializer</span><span class="op">(</span>stringRedisSerializer<span class="op">);</span></span>
<span id="cb26-34"><a href="back.html#cb26-34" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">setHashValueSerializer</span><span class="op">(</span>jackson2JsonRedisSerializer<span class="op">);</span></span>
<span id="cb26-35"><a href="back.html#cb26-35" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">setValueSerializer</span><span class="op">(</span>jackson2JsonRedisSerializer<span class="op">);</span></span>
<span id="cb26-36"><a href="back.html#cb26-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redisTemplate<span class="op">;</span></span>
<span id="cb26-37"><a href="back.html#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb26-38"><a href="back.html#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="back.html#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>因为Redis前缀的问题，必须在这里设置序列化器。一开始我用的是alibaba的fastjson，但是上线以后各种报错，最后还是换成jackson了。</p>
</div>
<div id="elasticsearch" class="section level2" number="1.5">
<h2><span class="header-section-number">1.5</span> ElasticSearch</h2>
<p>在Springboot启动的时候，他会自动帮你创建ES的索引。但是有时候他是不会创建的，这时候需要手动去创建。参考<a href="https://blog.csdn.net/syc000666/article/details/95609937" class="uri">https://blog.csdn.net/syc000666/article/details/95609937</a>。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb27-1"><a href="back.html#cb27-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-2"><a href="back.html#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">;</span></span>
<span id="cb27-3"><a href="back.html#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="back.html#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonFormat</span><span class="op">;</span></span>
<span id="cb27-5"><a href="back.html#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonDeserialize</span><span class="op">;</span></span>
<span id="cb27-6"><a href="back.html#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">JsonSerialize</span><span class="op">;</span></span>
<span id="cb27-7"><a href="back.html#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">datatype</span><span class="op">.</span><span class="im">jsr310</span><span class="op">.</span><span class="im">deser</span><span class="op">.</span><span class="im">LocalDateTimeDeserializer</span><span class="op">;</span></span>
<span id="cb27-8"><a href="back.html#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">datatype</span><span class="op">.</span><span class="im">jsr310</span><span class="op">.</span><span class="im">ser</span><span class="op">.</span><span class="im">LocalDateTimeSerializer</span><span class="op">;</span></span>
<span id="cb27-9"><a href="back.html#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb27-10"><a href="back.html#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Id</span><span class="op">;</span></span>
<span id="cb27-11"><a href="back.html#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">annotations</span><span class="op">.</span><span class="im">DateFormat</span><span class="op">;</span></span>
<span id="cb27-12"><a href="back.html#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">annotations</span><span class="op">.</span><span class="im">Document</span><span class="op">;</span></span>
<span id="cb27-13"><a href="back.html#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">annotations</span><span class="op">.</span><span class="im">Field</span><span class="op">;</span></span>
<span id="cb27-14"><a href="back.html#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">annotations</span><span class="op">.</span><span class="im">FieldType</span><span class="op">;</span></span>
<span id="cb27-15"><a href="back.html#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="back.html#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb27-17"><a href="back.html#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">LocalDateTime</span><span class="op">;</span></span>
<span id="cb27-18"><a href="back.html#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="back.html#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb27-20"><a href="back.html#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb27-21"><a href="back.html#cb27-21" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-12</span> <span class="co">6:55</span> AM</span>
<span id="cb27-22"><a href="back.html#cb27-22" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb27-23"><a href="back.html#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb27-24"><a href="back.html#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="at">@Document</span><span class="op">(</span>indexName <span class="op">=</span> <span class="st">&quot;vueblogpost&quot;</span><span class="op">)</span></span>
<span id="cb27-25"><a href="back.html#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> BlogPostDocument <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb27-26"><a href="back.html#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="back.html#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Id</span></span>
<span id="cb27-28"><a href="back.html#cb27-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> id<span class="op">;</span></span>
<span id="cb27-29"><a href="back.html#cb27-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span>type <span class="op">=</span> FieldType<span class="op">.</span><span class="fu">Long</span><span class="op">)</span></span>
<span id="cb27-30"><a href="back.html#cb27-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> userId<span class="op">;</span></span>
<span id="cb27-31"><a href="back.html#cb27-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span>type <span class="op">=</span> FieldType<span class="op">.</span><span class="fu">Keyword</span><span class="op">)</span></span>
<span id="cb27-32"><a href="back.html#cb27-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Integer</span> status<span class="op">;</span></span>
<span id="cb27-33"><a href="back.html#cb27-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span>type <span class="op">=</span> FieldType<span class="op">.</span><span class="fu">Text</span><span class="op">,</span> searchAnalyzer <span class="op">=</span> <span class="st">&quot;ik_smart&quot;</span><span class="op">,</span> analyzer <span class="op">=</span> <span class="st">&quot;ik_max_word&quot;</span><span class="op">)</span></span>
<span id="cb27-34"><a href="back.html#cb27-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> title<span class="op">;</span></span>
<span id="cb27-35"><a href="back.html#cb27-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span>type <span class="op">=</span> FieldType<span class="op">.</span><span class="fu">Text</span><span class="op">,</span> searchAnalyzer <span class="op">=</span> <span class="st">&quot;ik_smart&quot;</span><span class="op">,</span> analyzer <span class="op">=</span> <span class="st">&quot;ik_max_word&quot;</span><span class="op">)</span></span>
<span id="cb27-36"><a href="back.html#cb27-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> description<span class="op">;</span></span>
<span id="cb27-37"><a href="back.html#cb27-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span>type <span class="op">=</span> FieldType<span class="op">.</span><span class="fu">Text</span><span class="op">,</span> searchAnalyzer <span class="op">=</span> <span class="st">&quot;ik_smart&quot;</span><span class="op">,</span> analyzer <span class="op">=</span> <span class="st">&quot;ik_max_word&quot;</span><span class="op">)</span></span>
<span id="cb27-38"><a href="back.html#cb27-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> content<span class="op">;</span></span>
<span id="cb27-39"><a href="back.html#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="back.html#cb27-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonDeserialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeDeserializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb27-41"><a href="back.html#cb27-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonSerialize</span><span class="op">(</span>using <span class="op">=</span> LocalDateTimeSerializer<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb27-42"><a href="back.html#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@JsonFormat</span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">&quot;uuuu-MM-dd&#39;T&#39;HH:mm:ss&quot;</span><span class="op">)</span></span>
<span id="cb27-43"><a href="back.html#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Field</span><span class="op">(</span>type <span class="op">=</span> FieldType<span class="op">.</span><span class="fu">Date</span><span class="op">,</span> format <span class="op">=</span> <span class="bu">DateFormat</span><span class="op">.</span><span class="fu">date_hour_minute_second</span><span class="op">)</span></span>
<span id="cb27-44"><a href="back.html#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> LocalDateTime created<span class="op">;</span></span>
<span id="cb27-45"><a href="back.html#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="rabbitmq" class="section level2" number="1.6">
<h2><span class="header-section-number">1.6</span> RabbitMQ</h2>
<p>我用消息队列主要是用来配合ES工作的，没有涉及太深。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb28-1"><a href="back.html#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="back.html#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb28-3"><a href="back.html#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="back.html#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">Binding</span><span class="op">;</span></span>
<span id="cb28-5"><a href="back.html#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">BindingBuilder</span><span class="op">;</span></span>
<span id="cb28-6"><a href="back.html#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">DirectExchange</span><span class="op">;</span></span>
<span id="cb28-7"><a href="back.html#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">Queue</span><span class="op">;</span></span>
<span id="cb28-8"><a href="back.html#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb28-9"><a href="back.html#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb28-10"><a href="back.html#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="back.html#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb28-12"><a href="back.html#cb28-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> RabbitMQ</span>
<span id="cb28-13"><a href="back.html#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb28-14"><a href="back.html#cb28-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-12</span> <span class="co">11:22</span> PM</span>
<span id="cb28-15"><a href="back.html#cb28-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb28-16"><a href="back.html#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb28-17"><a href="back.html#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> RabbitConfig <span class="op">{</span></span>
<span id="cb28-18"><a href="back.html#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="back.html#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ES_QUEUE <span class="op">=</span> <span class="st">&quot;ex_queue&quot;</span><span class="op">;</span></span>
<span id="cb28-20"><a href="back.html#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ES_EXCHANGE <span class="op">=</span> <span class="st">&quot;ex_exchange&quot;</span><span class="op">;</span></span>
<span id="cb28-21"><a href="back.html#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ES_BINDING_KEY <span class="op">=</span> <span class="st">&quot;ex_exchange&quot;</span><span class="op">;</span></span>
<span id="cb28-22"><a href="back.html#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="back.html#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//队列</span></span>
<span id="cb28-24"><a href="back.html#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb28-25"><a href="back.html#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Queue</span> <span class="fu">exQueue</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb28-26"><a href="back.html#cb28-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Queue</span><span class="op">(</span>ES_QUEUE<span class="op">);</span></span>
<span id="cb28-27"><a href="back.html#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-28"><a href="back.html#cb28-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-29"><a href="back.html#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">//交换机</span></span>
<span id="cb28-30"><a href="back.html#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb28-31"><a href="back.html#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DirectExchange <span class="fu">exchange</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb28-32"><a href="back.html#cb28-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">DirectExchange</span><span class="op">(</span>ES_EXCHANGE<span class="op">);</span></span>
<span id="cb28-33"><a href="back.html#cb28-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-34"><a href="back.html#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="back.html#cb28-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">//绑定队列和交换机</span></span>
<span id="cb28-36"><a href="back.html#cb28-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb28-37"><a href="back.html#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Binding</span> <span class="fu">binding</span><span class="op">(</span><span class="bu">Queue</span> exQueue<span class="op">,</span> DirectExchange exchange<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-38"><a href="back.html#cb28-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BindingBuilder<span class="op">.</span><span class="fu">bind</span><span class="op">(</span>exQueue<span class="op">).</span><span class="fu">to</span><span class="op">(</span>exchange<span class="op">).</span><span class="fu">with</span><span class="op">(</span>ES_BINDING_KEY<span class="op">);</span></span>
<span id="cb28-39"><a href="back.html#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-40"><a href="back.html#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb29-1"><a href="back.html#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">.</span><span class="im">mq</span><span class="op">;</span></span>
<span id="cb29-2"><a href="back.html#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="back.html#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">AllArgsConstructor</span><span class="op">;</span></span>
<span id="cb29-4"><a href="back.html#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb29-5"><a href="back.html#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="back.html#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb29-7"><a href="back.html#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="back.html#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb29-9"><a href="back.html#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb29-10"><a href="back.html#cb29-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-13</span> <span class="co">10:46</span> AM</span>
<span id="cb29-11"><a href="back.html#cb29-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb29-12"><a href="back.html#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb29-13"><a href="back.html#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="at">@AllArgsConstructor</span></span>
<span id="cb29-14"><a href="back.html#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PostMQIndexMessage <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb29-15"><a href="back.html#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="back.html#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> UPDATE <span class="op">=</span> <span class="st">&quot;update&quot;</span><span class="op">;</span></span>
<span id="cb29-17"><a href="back.html#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> REMOVE <span class="op">=</span> <span class="st">&quot;remove&quot;</span><span class="op">;</span></span>
<span id="cb29-18"><a href="back.html#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> CREATE <span class="op">=</span> <span class="st">&quot;create&quot;</span><span class="op">;</span></span>
<span id="cb29-19"><a href="back.html#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="back.html#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="back.html#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Long</span> postId<span class="op">;</span></span>
<span id="cb29-22"><a href="back.html#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="back.html#cb29-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> type<span class="op">;</span></span>
<span id="cb29-24"><a href="back.html#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="back.html#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-26"><a href="back.html#cb29-26" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb30-1"><a href="back.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">.</span><span class="im">mq</span><span class="op">;</span></span>
<span id="cb30-2"><a href="back.html#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="back.html#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">ObjectMapper</span><span class="op">;</span></span>
<span id="cb30-4"><a href="back.html#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">RabbitConfig</span><span class="op">;</span></span>
<span id="cb30-5"><a href="back.html#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Blog</span><span class="op">;</span></span>
<span id="cb30-6"><a href="back.html#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">search</span><span class="op">.</span><span class="im">model</span><span class="op">.</span><span class="im">BlogPostDocument</span><span class="op">;</span></span>
<span id="cb30-7"><a href="back.html#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">BlogService</span><span class="op">;</span></span>
<span id="cb30-8"><a href="back.html#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">MyUtils</span><span class="op">;</span></span>
<span id="cb30-9"><a href="back.html#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">SneakyThrows</span><span class="op">;</span></span>
<span id="cb30-10"><a href="back.html#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb30-11"><a href="back.html#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">rabbit</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RabbitHandler</span><span class="op">;</span></span>
<span id="cb30-12"><a href="back.html#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">rabbit</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RabbitListener</span><span class="op">;</span></span>
<span id="cb30-13"><a href="back.html#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb30-14"><a href="back.html#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">ElasticsearchRestTemplate</span><span class="op">;</span></span>
<span id="cb30-15"><a href="back.html#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">document</span><span class="op">.</span><span class="im">Document</span><span class="op">;</span></span>
<span id="cb30-16"><a href="back.html#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">mapping</span><span class="op">.</span><span class="im">IndexCoordinates</span><span class="op">;</span></span>
<span id="cb30-17"><a href="back.html#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">UpdateQuery</span><span class="op">;</span></span>
<span id="cb30-18"><a href="back.html#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">UpdateResponse</span><span class="op">;</span></span>
<span id="cb30-19"><a href="back.html#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb30-20"><a href="back.html#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="back.html#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb30-22"><a href="back.html#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb30-23"><a href="back.html#cb30-23" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-13</span> <span class="co">11:38</span> AM</span>
<span id="cb30-24"><a href="back.html#cb30-24" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb30-25"><a href="back.html#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb30-26"><a href="back.html#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb30-27"><a href="back.html#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="at">@RabbitListener</span><span class="op">(</span>queues <span class="op">=</span> RabbitConfig<span class="op">.</span><span class="fu">ES_QUEUE</span><span class="op">)</span></span>
<span id="cb30-28"><a href="back.html#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MQMessageHandler <span class="op">{</span></span>
<span id="cb30-29"><a href="back.html#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="back.html#cb30-30" aria-hidden="true" tabindex="-1"></a>    BlogService blogService<span class="op">;</span></span>
<span id="cb30-31"><a href="back.html#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="back.html#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb30-33"><a href="back.html#cb30-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setBlogService</span><span class="op">(</span>BlogService blogService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-34"><a href="back.html#cb30-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">blogService</span> <span class="op">=</span> blogService<span class="op">;</span></span>
<span id="cb30-35"><a href="back.html#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-36"><a href="back.html#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="back.html#cb30-37" aria-hidden="true" tabindex="-1"></a>    ElasticsearchRestTemplate elasticsearchRestTemplate<span class="op">;</span></span>
<span id="cb30-38"><a href="back.html#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="back.html#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb30-40"><a href="back.html#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setElasticsearchRestTemplate</span><span class="op">(</span>ElasticsearchRestTemplate elasticsearchRestTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-41"><a href="back.html#cb30-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">elasticsearchRestTemplate</span> <span class="op">=</span> elasticsearchRestTemplate<span class="op">;</span></span>
<span id="cb30-42"><a href="back.html#cb30-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-43"><a href="back.html#cb30-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-44"><a href="back.html#cb30-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">@SneakyThrows</span></span>
<span id="cb30-45"><a href="back.html#cb30-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RabbitHandler</span></span>
<span id="cb30-46"><a href="back.html#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handler</span><span class="op">(</span>PostMQIndexMessage message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-47"><a href="back.html#cb30-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>message<span class="op">.</span><span class="fu">getType</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb30-48"><a href="back.html#cb30-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> PostMQIndexMessage<span class="op">.</span><span class="fu">UPDATE</span><span class="op">:</span></span>
<span id="cb30-49"><a href="back.html#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="back.html#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="co">//                Thread.sleep(500);</span></span>
<span id="cb30-51"><a href="back.html#cb30-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-52"><a href="back.html#cb30-52" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Long</span> updateId <span class="op">=</span> message<span class="op">.</span><span class="fu">getPostId</span><span class="op">();</span></span>
<span id="cb30-53"><a href="back.html#cb30-53" aria-hidden="true" tabindex="-1"></a>                Blog blogExisted <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>updateId<span class="op">);</span></span>
<span id="cb30-54"><a href="back.html#cb30-54" aria-hidden="true" tabindex="-1"></a>                BlogPostDocument postDocument <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">blogToDocument</span><span class="op">(</span>blogExisted<span class="op">);</span></span>
<span id="cb30-55"><a href="back.html#cb30-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-56"><a href="back.html#cb30-56" aria-hidden="true" tabindex="-1"></a>                ObjectMapper objectMapper <span class="op">=</span> <span class="kw">new</span> <span class="fu">ObjectMapper</span><span class="op">();</span></span>
<span id="cb30-57"><a href="back.html#cb30-57" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> obj <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">writeValueAsString</span><span class="op">(</span>postDocument<span class="op">);</span></span>
<span id="cb30-58"><a href="back.html#cb30-58" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Document</span> document <span class="op">=</span> <span class="bu">Document</span><span class="op">.</span><span class="fu">parse</span><span class="op">(</span>obj<span class="op">);</span></span>
<span id="cb30-59"><a href="back.html#cb30-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-60"><a href="back.html#cb30-60" aria-hidden="true" tabindex="-1"></a>                UpdateQuery query <span class="op">=</span> UpdateQuery</span>
<span id="cb30-61"><a href="back.html#cb30-61" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">builder</span><span class="op">(</span><span class="bu">String</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>updateId<span class="op">))</span></span>
<span id="cb30-62"><a href="back.html#cb30-62" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">withDocument</span><span class="op">(</span>document<span class="op">)</span></span>
<span id="cb30-63"><a href="back.html#cb30-63" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb30-64"><a href="back.html#cb30-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-65"><a href="back.html#cb30-65" aria-hidden="true" tabindex="-1"></a>                IndexCoordinates indexCoordinates <span class="op">=</span> elasticsearchRestTemplate<span class="op">.</span><span class="fu">getIndexCoordinatesFor</span><span class="op">(</span>BlogPostDocument<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb30-66"><a href="back.html#cb30-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-67"><a href="back.html#cb30-67" aria-hidden="true" tabindex="-1"></a>                UpdateResponse update <span class="op">=</span> elasticsearchRestTemplate<span class="op">.</span><span class="fu">update</span><span class="op">(</span>query<span class="op">,</span> indexCoordinates<span class="op">);</span></span>
<span id="cb30-68"><a href="back.html#cb30-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-69"><a href="back.html#cb30-69" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> result <span class="op">=</span> <span class="bu">String</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>update<span class="op">.</span><span class="fu">getResult</span><span class="op">());</span></span>
<span id="cb30-70"><a href="back.html#cb30-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-71"><a href="back.html#cb30-71" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;更新结果: {}&quot;</span><span class="op">,</span> result<span class="op">);</span></span>
<span id="cb30-72"><a href="back.html#cb30-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb30-73"><a href="back.html#cb30-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> PostMQIndexMessage<span class="op">.</span><span class="fu">REMOVE</span><span class="op">:</span></span>
<span id="cb30-74"><a href="back.html#cb30-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-75"><a href="back.html#cb30-75" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Long</span> deleteId <span class="op">=</span> message<span class="op">.</span><span class="fu">getPostId</span><span class="op">();</span></span>
<span id="cb30-76"><a href="back.html#cb30-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-77"><a href="back.html#cb30-77" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> delete <span class="op">=</span> elasticsearchRestTemplate<span class="op">.</span><span class="fu">delete</span><span class="op">(</span>deleteId<span class="op">.</span><span class="fu">toString</span><span class="op">(),</span> BlogPostDocument<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb30-78"><a href="back.html#cb30-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-79"><a href="back.html#cb30-79" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;删除结果: {}&quot;</span><span class="op">,</span> delete<span class="op">);</span></span>
<span id="cb30-80"><a href="back.html#cb30-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-81"><a href="back.html#cb30-81" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb30-82"><a href="back.html#cb30-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> PostMQIndexMessage<span class="op">.</span><span class="fu">CREATE</span><span class="op">:</span></span>
<span id="cb30-83"><a href="back.html#cb30-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-84"><a href="back.html#cb30-84" aria-hidden="true" tabindex="-1"></a><span class="co">//                Thread.sleep(500);</span></span>
<span id="cb30-85"><a href="back.html#cb30-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-86"><a href="back.html#cb30-86" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Long</span> createId <span class="op">=</span> message<span class="op">.</span><span class="fu">getPostId</span><span class="op">();</span></span>
<span id="cb30-87"><a href="back.html#cb30-87" aria-hidden="true" tabindex="-1"></a>                Blog newBlog <span class="op">=</span> blogService<span class="op">.</span><span class="fu">getById</span><span class="op">(</span>createId<span class="op">);</span></span>
<span id="cb30-88"><a href="back.html#cb30-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-89"><a href="back.html#cb30-89" aria-hidden="true" tabindex="-1"></a>                BlogPostDocument newDocument <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">blogToDocument</span><span class="op">(</span>newBlog<span class="op">);</span></span>
<span id="cb30-90"><a href="back.html#cb30-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-91"><a href="back.html#cb30-91" aria-hidden="true" tabindex="-1"></a>                BlogPostDocument save <span class="op">=</span> elasticsearchRestTemplate<span class="op">.</span><span class="fu">save</span><span class="op">(</span>newDocument<span class="op">);</span></span>
<span id="cb30-92"><a href="back.html#cb30-92" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;保存结果: {}&quot;</span><span class="op">,</span> save<span class="op">);</span></span>
<span id="cb30-93"><a href="back.html#cb30-93" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb30-94"><a href="back.html#cb30-94" aria-hidden="true" tabindex="-1"></a>            <span class="kw">default</span><span class="op">:</span></span>
<span id="cb30-95"><a href="back.html#cb30-95" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;没找到对应的消息类型: {}&quot;</span><span class="op">,</span> message<span class="op">);</span></span>
<span id="cb30-96"><a href="back.html#cb30-96" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb30-97"><a href="back.html#cb30-97" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-98"><a href="back.html#cb30-98" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-99"><a href="back.html#cb30-99" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>用了ElasticReasrchRestTemplate。</p>
</div>
<div id="websocket" class="section level2" number="1.7">
<h2><span class="header-section-number">1.7</span> WebSocket</h2>
<div id="javax的api" class="section level3" number="1.7.1">
<h3><span class="header-section-number">1.7.1</span> javax的API：</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb31-1"><a href="back.html#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb31-2"><a href="back.html#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="back.html#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb31-4"><a href="back.html#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb31-5"><a href="back.html#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">socket</span><span class="op">.</span><span class="im">server</span><span class="op">.</span><span class="im">standard</span><span class="op">.</span><span class="im">ServerEndpointExporter</span><span class="op">;</span></span>
<span id="cb31-6"><a href="back.html#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="back.html#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb31-8"><a href="back.html#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb31-9"><a href="back.html#cb31-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-21</span> <span class="co">11:11</span> AM</span>
<span id="cb31-10"><a href="back.html#cb31-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb31-11"><a href="back.html#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb31-12"><a href="back.html#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketConfig <span class="op">{</span></span>
<span id="cb31-13"><a href="back.html#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="back.html#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb31-15"><a href="back.html#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ServerEndpointExporter <span class="fu">serverEndpointExporter</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-16"><a href="back.html#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">ServerEndpointExporter</span><span class="op">();</span></span>
<span id="cb31-17"><a href="back.html#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-18"><a href="back.html#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="back.html#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-20"><a href="back.html#cb31-20" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb32-1"><a href="back.html#cb32-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-2"><a href="back.html#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">component</span><span class="op">;</span></span>
<span id="cb32-3"><a href="back.html#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">json</span><span class="op">.</span><span class="im">JSONArray</span><span class="op">;</span></span>
<span id="cb32-4"><a href="back.html#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">json</span><span class="op">.</span><span class="im">JSONObject</span><span class="op">;</span></span>
<span id="cb32-5"><a href="back.html#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">json</span><span class="op">.</span><span class="im">JSONUtil</span><span class="op">;</span></span>
<span id="cb32-6"><a href="back.html#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryWrapper</span><span class="op">;</span></span>
<span id="cb32-7"><a href="back.html#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb32-8"><a href="back.html#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb32-9"><a href="back.html#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">JwtToken</span><span class="op">;</span></span>
<span id="cb32-10"><a href="back.html#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb32-11"><a href="back.html#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">SpringUtil</span><span class="op">;</span></span>
<span id="cb32-12"><a href="back.html#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb32-13"><a href="back.html#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">SneakyThrows</span><span class="op">;</span></span>
<span id="cb32-14"><a href="back.html#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Logger</span><span class="op">;</span></span>
<span id="cb32-15"><a href="back.html#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">LoggerFactory</span><span class="op">;</span></span>
<span id="cb32-16"><a href="back.html#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb32-17"><a href="back.html#cb32-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-18"><a href="back.html#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">websocket</span><span class="op">.*;</span></span>
<span id="cb32-19"><a href="back.html#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">websocket</span><span class="op">.</span><span class="im">server</span><span class="op">.</span><span class="im">PathParam</span><span class="op">;</span></span>
<span id="cb32-20"><a href="back.html#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">websocket</span><span class="op">.</span><span class="im">server</span><span class="op">.</span><span class="im">ServerEndpoint</span><span class="op">;</span></span>
<span id="cb32-21"><a href="back.html#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Map</span><span class="op">;</span></span>
<span id="cb32-22"><a href="back.html#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">ConcurrentHashMap</span><span class="op">;</span></span>
<span id="cb32-23"><a href="back.html#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="back.html#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="back.html#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb32-26"><a href="back.html#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author websocket<span class="co">服务</span></span>
<span id="cb32-27"><a href="back.html#cb32-27" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb32-28"><a href="back.html#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="at">@ServerEndpoint</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;/imserver/{username}/{token}&quot;</span><span class="op">)</span></span>
<span id="cb32-29"><a href="back.html#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb32-30"><a href="back.html#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketServer <span class="op">{</span></span>
<span id="cb32-31"><a href="back.html#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="back.html#cb32-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Logger</span> log <span class="op">=</span> LoggerFactory<span class="op">.</span><span class="fu">getLogger</span><span class="op">(</span>WebSocketServer<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb32-33"><a href="back.html#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="back.html#cb32-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb32-35"><a href="back.html#cb32-35" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">记录当前在线连接数</span></span>
<span id="cb32-36"><a href="back.html#cb32-36" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb32-37"><a href="back.html#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> Session<span class="op">&gt;</span> sessionMap <span class="op">=</span> <span class="kw">new</span> <span class="bu">ConcurrentHashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb32-38"><a href="back.html#cb32-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-39"><a href="back.html#cb32-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb32-40"><a href="back.html#cb32-40" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">连接建立成功调用的方法</span></span>
<span id="cb32-41"><a href="back.html#cb32-41" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb32-42"><a href="back.html#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OnOpen</span></span>
<span id="cb32-43"><a href="back.html#cb32-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">onOpen</span><span class="op">(</span>Session session<span class="op">,</span> <span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;token&quot;</span><span class="op">)</span> <span class="bu">String</span> token<span class="op">,</span> <span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">)</span> <span class="bu">String</span> username<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-44"><a href="back.html#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="back.html#cb32-45" aria-hidden="true" tabindex="-1"></a>        JwtUtils jwtUtils <span class="op">=</span> SpringUtil<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span>JwtUtils<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb32-46"><a href="back.html#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="back.html#cb32-47" aria-hidden="true" tabindex="-1"></a>        JwtToken jwtToken <span class="op">=</span> <span class="kw">new</span> <span class="fu">JwtToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb32-48"><a href="back.html#cb32-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-49"><a href="back.html#cb32-49" aria-hidden="true" tabindex="-1"></a>        Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> jwtToken<span class="op">.</span><span class="fu">getCredentials</span><span class="op">());</span></span>
<span id="cb32-50"><a href="back.html#cb32-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-51"><a href="back.html#cb32-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>claim <span class="op">==</span> <span class="kw">null</span> <span class="op">||</span> jwtUtils<span class="op">.</span><span class="fu">isTokenExpired</span><span class="op">(</span>claim<span class="op">.</span><span class="fu">getExpiration</span><span class="op">())){</span></span>
<span id="cb32-52"><a href="back.html#cb32-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span><span class="op">(</span><span class="st">&quot;身份过期&quot;</span><span class="op">);</span></span>
<span id="cb32-53"><a href="back.html#cb32-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-54"><a href="back.html#cb32-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-55"><a href="back.html#cb32-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> userId <span class="op">=</span> claim<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb32-56"><a href="back.html#cb32-56" aria-hidden="true" tabindex="-1"></a>        UserService userService <span class="op">=</span> SpringUtil<span class="op">.</span><span class="fu">getBean</span><span class="op">(</span>UserService<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb32-57"><a href="back.html#cb32-57" aria-hidden="true" tabindex="-1"></a>        User user <span class="op">=</span> userService<span class="op">.</span><span class="fu">getOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> userId<span class="op">));</span></span>
<span id="cb32-58"><a href="back.html#cb32-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>username<span class="op">.</span><span class="fu">equals</span><span class="op">(</span>user<span class="op">.</span><span class="fu">getUsername</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb32-59"><a href="back.html#cb32-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span><span class="op">(</span><span class="st">&quot;连接拒绝&quot;</span><span class="op">);</span></span>
<span id="cb32-60"><a href="back.html#cb32-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-61"><a href="back.html#cb32-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-62"><a href="back.html#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="back.html#cb32-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>sessionMap<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-64"><a href="back.html#cb32-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span><span class="op">(</span><span class="st">&quot;人数已满&quot;</span><span class="op">);</span></span>
<span id="cb32-65"><a href="back.html#cb32-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-66"><a href="back.html#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="back.html#cb32-67" aria-hidden="true" tabindex="-1"></a>        sessionMap<span class="op">.</span><span class="fu">put</span><span class="op">(</span>username<span class="op">,</span> session<span class="op">);</span></span>
<span id="cb32-68"><a href="back.html#cb32-68" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;有新用户加入，username={}, 当前在线人数为：{}&quot;</span><span class="op">,</span> username<span class="op">,</span> sessionMap<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb32-69"><a href="back.html#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-70"><a href="back.html#cb32-70" aria-hidden="true" tabindex="-1"></a>        JSONObject result <span class="op">=</span> <span class="kw">new</span> <span class="fu">JSONObject</span><span class="op">();</span></span>
<span id="cb32-71"><a href="back.html#cb32-71" aria-hidden="true" tabindex="-1"></a>        JSONArray array <span class="op">=</span> <span class="kw">new</span> <span class="fu">JSONArray</span><span class="op">();</span></span>
<span id="cb32-72"><a href="back.html#cb32-72" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;users&quot;</span><span class="op">,</span> array<span class="op">);</span></span>
<span id="cb32-73"><a href="back.html#cb32-73" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> num <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb32-74"><a href="back.html#cb32-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span> key <span class="op">:</span> sessionMap<span class="op">.</span><span class="fu">keySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb32-75"><a href="back.html#cb32-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="back.html#cb32-76" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> avatar <span class="op">=</span> userService<span class="op">.</span><span class="fu">getOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">,</span> username<span class="op">)).</span><span class="fu">getAvatar</span><span class="op">();</span></span>
<span id="cb32-77"><a href="back.html#cb32-77" aria-hidden="true" tabindex="-1"></a>            JSONObject jsonObject <span class="op">=</span> <span class="kw">new</span> <span class="fu">JSONObject</span><span class="op">();</span></span>
<span id="cb32-78"><a href="back.html#cb32-78" aria-hidden="true" tabindex="-1"></a>            jsonObject<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">,</span> key<span class="op">);</span></span>
<span id="cb32-79"><a href="back.html#cb32-79" aria-hidden="true" tabindex="-1"></a>            jsonObject<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;avatar&quot;</span><span class="op">,</span> avatar<span class="op">);</span></span>
<span id="cb32-80"><a href="back.html#cb32-80" aria-hidden="true" tabindex="-1"></a>            jsonObject<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;number&quot;</span><span class="op">,</span> <span class="op">++</span>num<span class="op">);</span></span>
<span id="cb32-81"><a href="back.html#cb32-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-82"><a href="back.html#cb32-82" aria-hidden="true" tabindex="-1"></a>            array<span class="op">.</span><span class="fu">add</span><span class="op">(</span>jsonObject<span class="op">);</span></span>
<span id="cb32-83"><a href="back.html#cb32-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-84"><a href="back.html#cb32-84" aria-hidden="true" tabindex="-1"></a><span class="co">//        {&quot;users&quot;: [{&quot;username&quot;: &quot;zhang&quot;},{ &quot;username&quot;: &quot;admin&quot;}]}</span></span>
<span id="cb32-85"><a href="back.html#cb32-85" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sendAllMessage</span><span class="op">(</span>JSONUtil<span class="op">.</span><span class="fu">toJsonStr</span><span class="op">(</span>result<span class="op">));</span>  <span class="co">// 后台发送消息给所有的客户端</span></span>
<span id="cb32-86"><a href="back.html#cb32-86" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-87"><a href="back.html#cb32-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-88"><a href="back.html#cb32-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb32-89"><a href="back.html#cb32-89" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">连接关闭调用的方法</span></span>
<span id="cb32-90"><a href="back.html#cb32-90" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb32-91"><a href="back.html#cb32-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OnClose</span></span>
<span id="cb32-92"><a href="back.html#cb32-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onClose</span><span class="op">(</span>Session session<span class="op">,</span> <span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">)</span> <span class="bu">String</span> username<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-93"><a href="back.html#cb32-93" aria-hidden="true" tabindex="-1"></a>        sessionMap<span class="op">.</span><span class="fu">remove</span><span class="op">(</span>username<span class="op">);</span></span>
<span id="cb32-94"><a href="back.html#cb32-94" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;有一连接关闭，移除username={}的用户session, 当前在线人数为：{}&quot;</span><span class="op">,</span> username<span class="op">,</span> sessionMap<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb32-95"><a href="back.html#cb32-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-96"><a href="back.html#cb32-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-97"><a href="back.html#cb32-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb32-98"><a href="back.html#cb32-98" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">收到客户端消息后调用的方法</span></span>
<span id="cb32-99"><a href="back.html#cb32-99" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">后台收到客户端发送过来的消息</span></span>
<span id="cb32-100"><a href="back.html#cb32-100" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> onMessage <span class="co">是一个消息的中转站</span></span>
<span id="cb32-101"><a href="back.html#cb32-101" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">接受</span> <span class="co">浏览器端</span> socket<span class="co">.</span>send <span class="co">发送过来的</span> json<span class="co">数据</span></span>
<span id="cb32-102"><a href="back.html#cb32-102" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param message <span class="co">客户端发送过来的消息</span></span>
<span id="cb32-103"><a href="back.html#cb32-103" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb32-104"><a href="back.html#cb32-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">@SneakyThrows</span></span>
<span id="cb32-105"><a href="back.html#cb32-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OnMessage</span></span>
<span id="cb32-106"><a href="back.html#cb32-106" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onMessage</span><span class="op">(</span><span class="bu">String</span> message<span class="op">,</span> Session session<span class="op">,</span> <span class="at">@PathParam</span><span class="op">(</span><span class="st">&quot;username&quot;</span><span class="op">)</span> <span class="bu">String</span> username<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-107"><a href="back.html#cb32-107" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;服务端收到用户username={}的消息:{}&quot;</span><span class="op">,</span> username<span class="op">,</span> message<span class="op">);</span></span>
<span id="cb32-108"><a href="back.html#cb32-108" aria-hidden="true" tabindex="-1"></a>        JSONObject obj <span class="op">=</span> JSONUtil<span class="op">.</span><span class="fu">parseObj</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb32-109"><a href="back.html#cb32-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-110"><a href="back.html#cb32-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>obj<span class="op">.</span><span class="fu">containsKey</span><span class="op">(</span><span class="st">&quot;to&quot;</span><span class="op">)</span> <span class="op">&amp;&amp;</span> obj<span class="op">.</span><span class="fu">containsKey</span><span class="op">(</span><span class="st">&quot;from&quot;</span><span class="op">)</span> <span class="op">&amp;&amp;</span> obj<span class="op">.</span><span class="fu">containsKey</span><span class="op">(</span><span class="st">&quot;text&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb32-111"><a href="back.html#cb32-111" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> toUsername <span class="op">=</span> obj<span class="op">.</span><span class="fu">getStr</span><span class="op">(</span><span class="st">&quot;to&quot;</span><span class="op">);</span> <span class="co">// to表示发送给哪个用户，比如 admin</span></span>
<span id="cb32-112"><a href="back.html#cb32-112" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> text <span class="op">=</span> obj<span class="op">.</span><span class="fu">getStr</span><span class="op">(</span><span class="st">&quot;text&quot;</span><span class="op">);</span> <span class="co">// 发送的消息文本  hello</span></span>
<span id="cb32-113"><a href="back.html#cb32-113" aria-hidden="true" tabindex="-1"></a>            <span class="co">// {&quot;to&quot;: &quot;admin&quot;, &quot;text&quot;: &quot;聊天文本&quot;}</span></span>
<span id="cb32-114"><a href="back.html#cb32-114" aria-hidden="true" tabindex="-1"></a>            Session toSession <span class="op">=</span> sessionMap<span class="op">.</span><span class="fu">get</span><span class="op">(</span>toUsername<span class="op">);</span> <span class="co">// 根据 to用户名来获取 session，再通过session发送消息文本</span></span>
<span id="cb32-115"><a href="back.html#cb32-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>toSession <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-116"><a href="back.html#cb32-116" aria-hidden="true" tabindex="-1"></a>                <span class="co">// 服务器端 再把消息组装一下，组装后的消息包含发送人和发送的文本内容</span></span>
<span id="cb32-117"><a href="back.html#cb32-117" aria-hidden="true" tabindex="-1"></a>                <span class="co">// {&quot;from&quot;: &quot;zhang&quot;, &quot;text&quot;: &quot;hello&quot;}</span></span>
<span id="cb32-118"><a href="back.html#cb32-118" aria-hidden="true" tabindex="-1"></a>                JSONObject jsonObject <span class="op">=</span> <span class="kw">new</span> <span class="fu">JSONObject</span><span class="op">();</span></span>
<span id="cb32-119"><a href="back.html#cb32-119" aria-hidden="true" tabindex="-1"></a>                jsonObject<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;from&quot;</span><span class="op">,</span> username<span class="op">);</span>  <span class="co">// from 是 zhang</span></span>
<span id="cb32-120"><a href="back.html#cb32-120" aria-hidden="true" tabindex="-1"></a>                jsonObject<span class="op">.</span><span class="fu">set</span><span class="op">(</span><span class="st">&quot;text&quot;</span><span class="op">,</span> text<span class="op">);</span>  <span class="co">// text 同上面的text</span></span>
<span id="cb32-121"><a href="back.html#cb32-121" aria-hidden="true" tabindex="-1"></a>                <span class="kw">this</span><span class="op">.</span><span class="fu">sendMessage</span><span class="op">(</span>jsonObject<span class="op">.</span><span class="fu">toString</span><span class="op">(),</span> toSession<span class="op">);</span></span>
<span id="cb32-122"><a href="back.html#cb32-122" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;发送给用户username={}，消息：{}&quot;</span><span class="op">,</span> toUsername<span class="op">,</span> jsonObject<span class="op">.</span><span class="fu">toString</span><span class="op">());</span></span>
<span id="cb32-123"><a href="back.html#cb32-123" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb32-124"><a href="back.html#cb32-124" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;发送失败，未找到用户username={}的session&quot;</span><span class="op">,</span> toUsername<span class="op">);</span></span>
<span id="cb32-125"><a href="back.html#cb32-125" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb32-126"><a href="back.html#cb32-126" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>obj<span class="op">.</span><span class="fu">containsKey</span><span class="op">(</span><span class="st">&quot;content&quot;</span><span class="op">)</span> <span class="op">&amp;&amp;</span> obj<span class="op">.</span><span class="fu">containsKey</span><span class="op">(</span><span class="st">&quot;from&quot;</span><span class="op">)</span> <span class="op">||</span> obj<span class="op">.</span><span class="fu">containsKey</span><span class="op">(</span><span class="st">&quot;dead&quot;</span><span class="op">)</span> <span class="op">&amp;&amp;</span> obj<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;from&quot;</span><span class="op">).</span><span class="fu">equals</span><span class="op">(</span><span class="st">&quot;admin&quot;</span><span class="op">))</span> <span class="op">{</span></span>
<span id="cb32-127"><a href="back.html#cb32-127" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="bu">Map</span><span class="op">.</span><span class="fu">Entry</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> Session<span class="op">&gt;</span> entry <span class="op">:</span> sessionMap<span class="op">.</span><span class="fu">entrySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb32-128"><a href="back.html#cb32-128" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(!</span>entry<span class="op">.</span><span class="fu">getKey</span><span class="op">().</span><span class="fu">equals</span><span class="op">(</span>username<span class="op">))</span> <span class="op">{</span></span>
<span id="cb32-129"><a href="back.html#cb32-129" aria-hidden="true" tabindex="-1"></a>                    entry<span class="op">.</span><span class="fu">getValue</span><span class="op">().</span><span class="fu">getBasicRemote</span><span class="op">().</span><span class="fu">sendText</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb32-130"><a href="back.html#cb32-130" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb32-131"><a href="back.html#cb32-131" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb32-132"><a href="back.html#cb32-132" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-133"><a href="back.html#cb32-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-134"><a href="back.html#cb32-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-135"><a href="back.html#cb32-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">@OnError</span></span>
<span id="cb32-136"><a href="back.html#cb32-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onError</span><span class="op">(</span>Session session<span class="op">,</span> <span class="bu">Throwable</span> error<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-137"><a href="back.html#cb32-137" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;发生错误&quot;</span><span class="op">);</span></span>
<span id="cb32-138"><a href="back.html#cb32-138" aria-hidden="true" tabindex="-1"></a>        error<span class="op">.</span><span class="fu">printStackTrace</span><span class="op">();</span></span>
<span id="cb32-139"><a href="back.html#cb32-139" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-140"><a href="back.html#cb32-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-141"><a href="back.html#cb32-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb32-142"><a href="back.html#cb32-142" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">服务端发送消息给客户端</span></span>
<span id="cb32-143"><a href="back.html#cb32-143" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb32-144"><a href="back.html#cb32-144" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">sendMessage</span><span class="op">(</span><span class="bu">String</span> message<span class="op">,</span> Session toSession<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-145"><a href="back.html#cb32-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb32-146"><a href="back.html#cb32-146" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;服务端给客户端[{}]发送消息{}&quot;</span><span class="op">,</span> toSession<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> message<span class="op">);</span></span>
<span id="cb32-147"><a href="back.html#cb32-147" aria-hidden="true" tabindex="-1"></a>            toSession<span class="op">.</span><span class="fu">getBasicRemote</span><span class="op">().</span><span class="fu">sendText</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb32-148"><a href="back.html#cb32-148" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-149"><a href="back.html#cb32-149" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;服务端发送消息给客户端失败&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb32-150"><a href="back.html#cb32-150" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-151"><a href="back.html#cb32-151" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-152"><a href="back.html#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-153"><a href="back.html#cb32-153" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb32-154"><a href="back.html#cb32-154" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">服务端发送消息给所有客户端</span></span>
<span id="cb32-155"><a href="back.html#cb32-155" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb32-156"><a href="back.html#cb32-156" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">sendAllMessage</span><span class="op">(</span><span class="bu">String</span> message<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-157"><a href="back.html#cb32-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb32-158"><a href="back.html#cb32-158" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>Session session <span class="op">:</span> sessionMap<span class="op">.</span><span class="fu">values</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb32-159"><a href="back.html#cb32-159" aria-hidden="true" tabindex="-1"></a>                log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;服务端给客户端[{}]发送消息{}&quot;</span><span class="op">,</span> session<span class="op">.</span><span class="fu">getId</span><span class="op">(),</span> message<span class="op">);</span></span>
<span id="cb32-160"><a href="back.html#cb32-160" aria-hidden="true" tabindex="-1"></a>                session<span class="op">.</span><span class="fu">getBasicRemote</span><span class="op">().</span><span class="fu">sendText</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb32-161"><a href="back.html#cb32-161" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb32-162"><a href="back.html#cb32-162" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">catch</span> <span class="op">(</span><span class="bu">Exception</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb32-163"><a href="back.html#cb32-163" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;服务端发送消息给客户端失败&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb32-164"><a href="back.html#cb32-164" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-165"><a href="back.html#cb32-165" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb32-166"><a href="back.html#cb32-166" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>这里面认证会麻烦一些，shiro的注解都失效了。我这里实现了一个合作编辑的功能，可以聊天沟通，各方可以看到其他人的书写实时状态。当然，这个和真正的协作编辑还是有差别的，但是大多数场景都可以了，尤其是多人合作一篇论文这种场合。</p>
</div>
<div id="spring的api" class="section level3" number="1.7.2">
<h3><span class="header-section-number">1.7.2</span> spring的API</h3>
<p>写了两套，这套比较适合正式场景。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb33-1"><a href="back.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb33-2"><a href="back.html#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="back.html#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">JwtToken</span><span class="op">;</span></span>
<span id="cb33-4"><a href="back.html#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb33-5"><a href="back.html#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb33-6"><a href="back.html#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">NonNull</span><span class="op">;</span></span>
<span id="cb33-7"><a href="back.html#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">AuthenticationException</span><span class="op">;</span></span>
<span id="cb33-8"><a href="back.html#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb33-9"><a href="back.html#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb33-10"><a href="back.html#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">Message</span><span class="op">;</span></span>
<span id="cb33-11"><a href="back.html#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">MessageChannel</span><span class="op">;</span></span>
<span id="cb33-12"><a href="back.html#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">simp</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">ChannelRegistration</span><span class="op">;</span></span>
<span id="cb33-13"><a href="back.html#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">simp</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">MessageBrokerRegistry</span><span class="op">;</span></span>
<span id="cb33-14"><a href="back.html#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">simp</span><span class="op">.</span><span class="im">stomp</span><span class="op">.</span><span class="im">StompCommand</span><span class="op">;</span></span>
<span id="cb33-15"><a href="back.html#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">simp</span><span class="op">.</span><span class="im">stomp</span><span class="op">.</span><span class="im">StompHeaderAccessor</span><span class="op">;</span></span>
<span id="cb33-16"><a href="back.html#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">support</span><span class="op">.</span><span class="im">ChannelInterceptor</span><span class="op">;</span></span>
<span id="cb33-17"><a href="back.html#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">support</span><span class="op">.</span><span class="im">MessageHeaderAccessor</span><span class="op">;</span></span>
<span id="cb33-18"><a href="back.html#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">socket</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">EnableWebSocketMessageBroker</span><span class="op">;</span></span>
<span id="cb33-19"><a href="back.html#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">socket</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">StompEndpointRegistry</span><span class="op">;</span></span>
<span id="cb33-20"><a href="back.html#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">socket</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">WebSocketMessageBrokerConfigurer</span><span class="op">;</span></span>
<span id="cb33-21"><a href="back.html#cb33-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-22"><a href="back.html#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb33-23"><a href="back.html#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb33-24"><a href="back.html#cb33-24" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-21</span> <span class="co">11:11</span> AM</span>
<span id="cb33-25"><a href="back.html#cb33-25" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb33-26"><a href="back.html#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb33-27"><a href="back.html#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableWebSocketMessageBroker</span></span>
<span id="cb33-28"><a href="back.html#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketConfig <span class="kw">implements</span> WebSocketMessageBrokerConfigurer<span class="op">{</span></span>
<span id="cb33-29"><a href="back.html#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="back.html#cb33-30" aria-hidden="true" tabindex="-1"></a>    JwtUtils jwtUtils<span class="op">;</span></span>
<span id="cb33-31"><a href="back.html#cb33-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-32"><a href="back.html#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb33-33"><a href="back.html#cb33-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtUtils jwtUtils<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-34"><a href="back.html#cb33-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtUtils</span> <span class="op">=</span> jwtUtils<span class="op">;</span></span>
<span id="cb33-35"><a href="back.html#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-36"><a href="back.html#cb33-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-37"><a href="back.html#cb33-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb33-38"><a href="back.html#cb33-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">registerStompEndpoints</span><span class="op">(</span>StompEndpointRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-39"><a href="back.html#cb33-39" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addEndpoint</span><span class="op">(</span><span class="st">&quot;/ws&quot;</span><span class="op">).</span><span class="fu">setAllowedOriginPatterns</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">).</span><span class="fu">withSockJS</span><span class="op">();</span></span>
<span id="cb33-40"><a href="back.html#cb33-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-41"><a href="back.html#cb33-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-42"><a href="back.html#cb33-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb33-43"><a href="back.html#cb33-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">configureMessageBroker</span><span class="op">(</span>MessageBrokerRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-44"><a href="back.html#cb33-44" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">setApplicationDestinationPrefixes</span><span class="op">(</span><span class="st">&quot;/app&quot;</span><span class="op">);</span></span>
<span id="cb33-45"><a href="back.html#cb33-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">//客户端订阅消息的前缀</span></span>
<span id="cb33-46"><a href="back.html#cb33-46" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">enableSimpleBroker</span><span class="op">(</span><span class="st">&quot;/topic&quot;</span><span class="op">,</span> <span class="st">&quot;/queue&quot;</span><span class="op">,</span> <span class="st">&quot;/user&quot;</span><span class="op">);</span></span>
<span id="cb33-47"><a href="back.html#cb33-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">//用户级别订阅消息的前缀(默认已经配了)</span></span>
<span id="cb33-48"><a href="back.html#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="co">//        registry.setUserDestinationPrefix(&quot;/user&quot;);</span></span>
<span id="cb33-49"><a href="back.html#cb33-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-50"><a href="back.html#cb33-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-51"><a href="back.html#cb33-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-52"><a href="back.html#cb33-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb33-53"><a href="back.html#cb33-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">configureClientInboundChannel</span><span class="op">(</span>ChannelRegistration registration<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-54"><a href="back.html#cb33-54" aria-hidden="true" tabindex="-1"></a>        registration<span class="op">.</span><span class="fu">interceptors</span><span class="op">(</span><span class="kw">new</span> <span class="fu">ChannelInterceptor</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb33-55"><a href="back.html#cb33-55" aria-hidden="true" tabindex="-1"></a>            <span class="at">@Override</span></span>
<span id="cb33-56"><a href="back.html#cb33-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">public</span> Message<span class="op">&lt;?&gt;</span> <span class="fu">preSend</span><span class="op">(</span><span class="at">@NonNull</span> Message<span class="op">&lt;?&gt;</span> message<span class="op">,</span> <span class="at">@NonNull</span> MessageChannel channel<span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-57"><a href="back.html#cb33-57" aria-hidden="true" tabindex="-1"></a>                StompHeaderAccessor accessor <span class="op">=</span> MessageHeaderAccessor<span class="op">.</span><span class="fu">getAccessor</span><span class="op">(</span>message<span class="op">,</span> StompHeaderAccessor<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb33-58"><a href="back.html#cb33-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-59"><a href="back.html#cb33-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>accessor <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb33-60"><a href="back.html#cb33-60" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">(</span>StompCommand<span class="op">.</span><span class="fu">CONNECT</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>accessor<span class="op">.</span><span class="fu">getCommand</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb33-61"><a href="back.html#cb33-61" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">String</span> token <span class="op">=</span> accessor<span class="op">.</span><span class="fu">getFirstNativeHeader</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb33-62"><a href="back.html#cb33-62" aria-hidden="true" tabindex="-1"></a>                        <span class="co">//验证token是否有效</span></span>
<span id="cb33-63"><a href="back.html#cb33-63" aria-hidden="true" tabindex="-1"></a>                        JwtToken jwtToken <span class="op">=</span> <span class="kw">new</span> <span class="fu">JwtToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb33-64"><a href="back.html#cb33-64" aria-hidden="true" tabindex="-1"></a>                        Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> jwtToken<span class="op">.</span><span class="fu">getCredentials</span><span class="op">());</span></span>
<span id="cb33-65"><a href="back.html#cb33-65" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">(</span>claim <span class="op">==</span> <span class="kw">null</span> <span class="op">||</span> jwtUtils<span class="op">.</span><span class="fu">isTokenExpired</span><span class="op">(</span>claim<span class="op">.</span><span class="fu">getExpiration</span><span class="op">())){</span></span>
<span id="cb33-66"><a href="back.html#cb33-66" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">AuthenticationException</span><span class="op">(</span><span class="st">&quot;token验证失败&quot;</span><span class="op">);</span></span>
<span id="cb33-67"><a href="back.html#cb33-67" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb33-68"><a href="back.html#cb33-68" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb33-69"><a href="back.html#cb33-69" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> message<span class="op">;</span></span>
<span id="cb33-70"><a href="back.html#cb33-70" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb33-71"><a href="back.html#cb33-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb33-72"><a href="back.html#cb33-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb33-73"><a href="back.html#cb33-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">});</span></span>
<span id="cb33-74"><a href="back.html#cb33-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-75"><a href="back.html#cb33-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb34-1"><a href="back.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb34-2"><a href="back.html#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="back.html#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">conditions</span><span class="op">.</span><span class="im">query</span><span class="op">.</span><span class="im">QueryWrapper</span><span class="op">;</span></span>
<span id="cb34-4"><a href="back.html#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Const</span><span class="op">;</span></span>
<span id="cb34-5"><a href="back.html#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Content</span><span class="op">;</span></span>
<span id="cb34-6"><a href="back.html#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">Message</span><span class="op">;</span></span>
<span id="cb34-7"><a href="back.html#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">entity</span><span class="op">.</span><span class="im">User</span><span class="op">;</span></span>
<span id="cb34-8"><a href="back.html#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">service</span><span class="op">.</span><span class="im">UserService</span><span class="op">;</span></span>
<span id="cb34-9"><a href="back.html#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">JwtToken</span><span class="op">;</span></span>
<span id="cb34-10"><a href="back.html#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">JwtUtils</span><span class="op">;</span></span>
<span id="cb34-11"><a href="back.html#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">MyUtils</span><span class="op">;</span></span>
<span id="cb34-12"><a href="back.html#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">io</span><span class="op">.</span><span class="im">jsonwebtoken</span><span class="op">.</span><span class="im">Claims</span><span class="op">;</span></span>
<span id="cb34-13"><a href="back.html#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb34-14"><a href="back.html#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb34-15"><a href="back.html#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb34-16"><a href="back.html#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">handler</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">DestinationVariable</span><span class="op">;</span></span>
<span id="cb34-17"><a href="back.html#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">handler</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Headers</span><span class="op">;</span></span>
<span id="cb34-18"><a href="back.html#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">handler</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">MessageMapping</span><span class="op">;</span></span>
<span id="cb34-19"><a href="back.html#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">simp</span><span class="op">.</span><span class="im">SimpMessagingTemplate</span><span class="op">;</span></span>
<span id="cb34-20"><a href="back.html#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Controller</span><span class="op">;</span></span>
<span id="cb34-21"><a href="back.html#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">LinkedMultiValueMap</span><span class="op">;</span></span>
<span id="cb34-22"><a href="back.html#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="back.html#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">ArrayList</span><span class="op">;</span></span>
<span id="cb34-24"><a href="back.html#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">List</span><span class="op">;</span></span>
<span id="cb34-25"><a href="back.html#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Map</span><span class="op">;</span></span>
<span id="cb34-26"><a href="back.html#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">TimeUnit</span><span class="op">;</span></span>
<span id="cb34-27"><a href="back.html#cb34-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-28"><a href="back.html#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb34-29"><a href="back.html#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb34-30"><a href="back.html#cb34-30" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-27</span> <span class="co">7:03</span> PM</span>
<span id="cb34-31"><a href="back.html#cb34-31" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb34-32"><a href="back.html#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb34-33"><a href="back.html#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb34-34"><a href="back.html#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebSocketController <span class="op">{</span></span>
<span id="cb34-35"><a href="back.html#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="back.html#cb34-36" aria-hidden="true" tabindex="-1"></a>    UserService userService<span class="op">;</span></span>
<span id="cb34-37"><a href="back.html#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="back.html#cb34-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb34-39"><a href="back.html#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setUserService</span><span class="op">(</span>UserService userService<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-40"><a href="back.html#cb34-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">userService</span> <span class="op">=</span> userService<span class="op">;</span></span>
<span id="cb34-41"><a href="back.html#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-42"><a href="back.html#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="back.html#cb34-43" aria-hidden="true" tabindex="-1"></a>    RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb34-44"><a href="back.html#cb34-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-45"><a href="back.html#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb34-46"><a href="back.html#cb34-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setRedisTemplate</span><span class="op">(</span>RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-47"><a href="back.html#cb34-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">redisTemplate</span> <span class="op">=</span> redisTemplate<span class="op">;</span></span>
<span id="cb34-48"><a href="back.html#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-49"><a href="back.html#cb34-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-50"><a href="back.html#cb34-50" aria-hidden="true" tabindex="-1"></a>    SimpMessagingTemplate simpMessagingTemplate<span class="op">;</span></span>
<span id="cb34-51"><a href="back.html#cb34-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-52"><a href="back.html#cb34-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb34-53"><a href="back.html#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setSimpMessagingTemplate</span><span class="op">(</span>SimpMessagingTemplate simpMessagingTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-54"><a href="back.html#cb34-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">simpMessagingTemplate</span> <span class="op">=</span> simpMessagingTemplate<span class="op">;</span></span>
<span id="cb34-55"><a href="back.html#cb34-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-56"><a href="back.html#cb34-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-57"><a href="back.html#cb34-57" aria-hidden="true" tabindex="-1"></a>    JwtUtils jwtUtils<span class="op">;</span></span>
<span id="cb34-58"><a href="back.html#cb34-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-59"><a href="back.html#cb34-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb34-60"><a href="back.html#cb34-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setJwtUtils</span><span class="op">(</span>JwtUtils jwtUtils<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-61"><a href="back.html#cb34-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">jwtUtils</span> <span class="op">=</span> jwtUtils<span class="op">;</span></span>
<span id="cb34-62"><a href="back.html#cb34-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-63"><a href="back.html#cb34-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-64"><a href="back.html#cb34-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/init/{blogId}&quot;</span><span class="op">)</span></span>
<span id="cb34-65"><a href="back.html#cb34-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">synchronized</span> <span class="dt">void</span> <span class="fu">init</span><span class="op">(</span><span class="at">@Headers</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> headers<span class="op">,</span> <span class="at">@DestinationVariable</span> <span class="bu">Long</span> blogId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-66"><a href="back.html#cb34-66" aria-hidden="true" tabindex="-1"></a>        LinkedMultiValueMap<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="op">(</span>LinkedMultiValueMap<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;)</span> headers<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;nativeHeaders&quot;</span><span class="op">);</span></span>
<span id="cb34-67"><a href="back.html#cb34-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> authorization <span class="op">=</span> map<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb34-68"><a href="back.html#cb34-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>authorization <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-69"><a href="back.html#cb34-69" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> token <span class="op">=</span> authorization<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb34-70"><a href="back.html#cb34-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-71"><a href="back.html#cb34-71" aria-hidden="true" tabindex="-1"></a>            JwtToken jwtToken <span class="op">=</span> <span class="kw">new</span> <span class="fu">JwtToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb34-72"><a href="back.html#cb34-72" aria-hidden="true" tabindex="-1"></a>            Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> jwtToken<span class="op">.</span><span class="fu">getCredentials</span><span class="op">());</span></span>
<span id="cb34-73"><a href="back.html#cb34-73" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> userId <span class="op">=</span> claim<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb34-74"><a href="back.html#cb34-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-75"><a href="back.html#cb34-75" aria-hidden="true" tabindex="-1"></a>            User user <span class="op">=</span> userService<span class="op">.</span><span class="fu">getBaseMapper</span><span class="op">().</span><span class="fu">selectOne</span><span class="op">(</span><span class="kw">new</span> QueryWrapper<span class="op">&lt;</span>User<span class="op">&gt;().</span><span class="fu">eq</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> userId<span class="op">).</span><span class="fu">select</span><span class="op">(</span><span class="st">&quot;id&quot;</span><span class="op">,</span> <span class="st">&quot;username&quot;</span><span class="op">,</span> <span class="st">&quot;avatar&quot;</span><span class="op">));</span></span>
<span id="cb34-76"><a href="back.html#cb34-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-77"><a href="back.html#cb34-77" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">setNumber</span><span class="op">(</span>redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">size</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">));</span></span>
<span id="cb34-78"><a href="back.html#cb34-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-79"><a href="back.html#cb34-79" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">expire</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">,</span> <span class="dv">4</span> <span class="op">*</span> <span class="dv">60</span><span class="op">,</span> <span class="bu">TimeUnit</span><span class="op">.</span><span class="fu">MINUTES</span><span class="op">);</span></span>
<span id="cb34-80"><a href="back.html#cb34-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-81"><a href="back.html#cb34-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(!</span>redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">hasKey</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">,</span> userId<span class="op">))</span> <span class="op">{</span></span>
<span id="cb34-82"><a href="back.html#cb34-82" aria-hidden="true" tabindex="-1"></a>                redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">put</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">,</span> userId<span class="op">,</span> user<span class="op">);</span></span>
<span id="cb34-83"><a href="back.html#cb34-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb34-84"><a href="back.html#cb34-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-85"><a href="back.html#cb34-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-86"><a href="back.html#cb34-86" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> entries <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">entries</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">);</span></span>
<span id="cb34-87"><a href="back.html#cb34-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-88"><a href="back.html#cb34-88" aria-hidden="true" tabindex="-1"></a>            <span class="bu">ArrayList</span><span class="op">&lt;</span>User<span class="op">&gt;</span> users <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb34-89"><a href="back.html#cb34-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-90"><a href="back.html#cb34-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="bu">Map</span><span class="op">.</span><span class="fu">Entry</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> entry <span class="op">:</span> entries<span class="op">.</span><span class="fu">entrySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb34-91"><a href="back.html#cb34-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-92"><a href="back.html#cb34-92" aria-hidden="true" tabindex="-1"></a>                User value <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">jsonToObj</span><span class="op">(</span>entry<span class="op">.</span><span class="fu">getValue</span><span class="op">(),</span> User<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb34-93"><a href="back.html#cb34-93" aria-hidden="true" tabindex="-1"></a>                users<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb34-94"><a href="back.html#cb34-94" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb34-95"><a href="back.html#cb34-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-96"><a href="back.html#cb34-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-97"><a href="back.html#cb34-97" aria-hidden="true" tabindex="-1"></a>            simpMessagingTemplate<span class="op">.</span><span class="fu">convertAndSendToUser</span><span class="op">(</span>blogId<span class="op">.</span><span class="fu">toString</span><span class="op">(),</span><span class="st">&quot;/topic/users&quot;</span><span class="op">,</span> users<span class="op">);</span></span>
<span id="cb34-98"><a href="back.html#cb34-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-99"><a href="back.html#cb34-99" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;{}号用户加入{}号编辑室&quot;</span><span class="op">,</span> userId<span class="op">,</span> blogId<span class="op">);</span></span>
<span id="cb34-100"><a href="back.html#cb34-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-101"><a href="back.html#cb34-101" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb34-102"><a href="back.html#cb34-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-103"><a href="back.html#cb34-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-104"><a href="back.html#cb34-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/destroy/{blogId}&quot;</span><span class="op">)</span></span>
<span id="cb34-105"><a href="back.html#cb34-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">destroy</span><span class="op">(</span><span class="at">@Headers</span> <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> headers<span class="op">,</span> <span class="at">@DestinationVariable</span> <span class="bu">Long</span> blogId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-106"><a href="back.html#cb34-106" aria-hidden="true" tabindex="-1"></a>        LinkedMultiValueMap<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;</span> map <span class="op">=</span> <span class="op">(</span>LinkedMultiValueMap<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">String</span><span class="op">&gt;)</span> headers<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;nativeHeaders&quot;</span><span class="op">);</span></span>
<span id="cb34-107"><a href="back.html#cb34-107" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">&gt;</span> authorization <span class="op">=</span> map<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="st">&quot;Authorization&quot;</span><span class="op">);</span></span>
<span id="cb34-108"><a href="back.html#cb34-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>authorization <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-109"><a href="back.html#cb34-109" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> token <span class="op">=</span> authorization<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb34-110"><a href="back.html#cb34-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-111"><a href="back.html#cb34-111" aria-hidden="true" tabindex="-1"></a>            JwtToken jwtToken <span class="op">=</span> <span class="kw">new</span> <span class="fu">JwtToken</span><span class="op">(</span>token<span class="op">);</span></span>
<span id="cb34-112"><a href="back.html#cb34-112" aria-hidden="true" tabindex="-1"></a>            Claims claim <span class="op">=</span> jwtUtils<span class="op">.</span><span class="fu">getClaimByToken</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> jwtToken<span class="op">.</span><span class="fu">getCredentials</span><span class="op">());</span></span>
<span id="cb34-113"><a href="back.html#cb34-113" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> userId <span class="op">=</span> claim<span class="op">.</span><span class="fu">getSubject</span><span class="op">();</span></span>
<span id="cb34-114"><a href="back.html#cb34-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-115"><a href="back.html#cb34-115" aria-hidden="true" tabindex="-1"></a>            redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">delete</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">,</span> userId<span class="op">);</span></span>
<span id="cb34-116"><a href="back.html#cb34-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-117"><a href="back.html#cb34-117" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> entries <span class="op">=</span> redisTemplate<span class="op">.</span><span class="fu">opsForHash</span><span class="op">().</span><span class="fu">entries</span><span class="op">(</span>Const<span class="op">.</span><span class="fu">WS_PREFIX</span> <span class="op">+</span> blogId<span class="op">);</span></span>
<span id="cb34-118"><a href="back.html#cb34-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-119"><a href="back.html#cb34-119" aria-hidden="true" tabindex="-1"></a>            <span class="bu">ArrayList</span><span class="op">&lt;</span>User<span class="op">&gt;</span> users <span class="op">=</span> <span class="kw">new</span> <span class="bu">ArrayList</span><span class="op">&lt;&gt;();</span></span>
<span id="cb34-120"><a href="back.html#cb34-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-121"><a href="back.html#cb34-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="bu">Map</span><span class="op">.</span><span class="fu">Entry</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> entry <span class="op">:</span> entries<span class="op">.</span><span class="fu">entrySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb34-122"><a href="back.html#cb34-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-123"><a href="back.html#cb34-123" aria-hidden="true" tabindex="-1"></a>                User value <span class="op">=</span> MyUtils<span class="op">.</span><span class="fu">jsonToObj</span><span class="op">(</span>entry<span class="op">.</span><span class="fu">getValue</span><span class="op">(),</span> User<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb34-124"><a href="back.html#cb34-124" aria-hidden="true" tabindex="-1"></a>                users<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb34-125"><a href="back.html#cb34-125" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb34-126"><a href="back.html#cb34-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-127"><a href="back.html#cb34-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-128"><a href="back.html#cb34-128" aria-hidden="true" tabindex="-1"></a>            simpMessagingTemplate<span class="op">.</span><span class="fu">convertAndSendToUser</span><span class="op">(</span>blogId<span class="op">.</span><span class="fu">toString</span><span class="op">(),</span><span class="st">&quot;/topic/users&quot;</span><span class="op">,</span> users<span class="op">);</span></span>
<span id="cb34-129"><a href="back.html#cb34-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-130"><a href="back.html#cb34-130" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;{}号用户退出编辑室&quot;</span><span class="op">,</span> userId<span class="op">);</span></span>
<span id="cb34-131"><a href="back.html#cb34-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-132"><a href="back.html#cb34-132" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb34-133"><a href="back.html#cb34-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-134"><a href="back.html#cb34-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-135"><a href="back.html#cb34-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/chat/{from}/{to}&quot;</span><span class="op">)</span></span>
<span id="cb34-136"><a href="back.html#cb34-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">chat</span><span class="op">(</span><span class="bu">String</span> msg<span class="op">,</span> <span class="at">@DestinationVariable</span> <span class="bu">String</span> from<span class="op">,</span> <span class="at">@DestinationVariable</span> <span class="bu">Long</span> to<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-137"><a href="back.html#cb34-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-138"><a href="back.html#cb34-138" aria-hidden="true" tabindex="-1"></a>        Message message <span class="op">=</span> <span class="kw">new</span> <span class="fu">Message</span><span class="op">();</span></span>
<span id="cb34-139"><a href="back.html#cb34-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-140"><a href="back.html#cb34-140" aria-hidden="true" tabindex="-1"></a>        message<span class="op">.</span><span class="fu">setMessage</span><span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb34-141"><a href="back.html#cb34-141" aria-hidden="true" tabindex="-1"></a>        message<span class="op">.</span><span class="fu">setFrom</span><span class="op">(</span>from<span class="op">);</span></span>
<span id="cb34-142"><a href="back.html#cb34-142" aria-hidden="true" tabindex="-1"></a>        message<span class="op">.</span><span class="fu">setTo</span><span class="op">(</span>to<span class="op">);</span></span>
<span id="cb34-143"><a href="back.html#cb34-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-144"><a href="back.html#cb34-144" aria-hidden="true" tabindex="-1"></a>        simpMessagingTemplate<span class="op">.</span><span class="fu">convertAndSendToUser</span><span class="op">(</span>to<span class="op">.</span><span class="fu">toString</span><span class="op">(),</span> <span class="st">&quot;/queue/chat&quot;</span><span class="op">,</span> message<span class="op">);</span></span>
<span id="cb34-145"><a href="back.html#cb34-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-146"><a href="back.html#cb34-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-147"><a href="back.html#cb34-147" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-148"><a href="back.html#cb34-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-149"><a href="back.html#cb34-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-150"><a href="back.html#cb34-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/sync/{from}&quot;</span><span class="op">)</span></span>
<span id="cb34-151"><a href="back.html#cb34-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">syncContent</span><span class="op">(</span><span class="at">@DestinationVariable</span> <span class="bu">Long</span> from<span class="op">,</span> <span class="bu">String</span> content<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-152"><a href="back.html#cb34-152" aria-hidden="true" tabindex="-1"></a>        Content msg <span class="op">=</span> <span class="kw">new</span> <span class="fu">Content</span><span class="op">();</span></span>
<span id="cb34-153"><a href="back.html#cb34-153" aria-hidden="true" tabindex="-1"></a>        msg<span class="op">.</span><span class="fu">setContent</span><span class="op">(</span>content<span class="op">);</span></span>
<span id="cb34-154"><a href="back.html#cb34-154" aria-hidden="true" tabindex="-1"></a>        msg<span class="op">.</span><span class="fu">setFrom</span><span class="op">(</span>from<span class="op">);</span></span>
<span id="cb34-155"><a href="back.html#cb34-155" aria-hidden="true" tabindex="-1"></a>        simpMessagingTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span><span class="st">&quot;/topic/content&quot;</span><span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb34-156"><a href="back.html#cb34-156" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-157"><a href="back.html#cb34-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-158"><a href="back.html#cb34-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-159"><a href="back.html#cb34-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/taskOver/{from}&quot;</span><span class="op">)</span></span>
<span id="cb34-160"><a href="back.html#cb34-160" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">taskOver</span><span class="op">(</span><span class="at">@DestinationVariable</span> <span class="bu">Long</span> from<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-161"><a href="back.html#cb34-161" aria-hidden="true" tabindex="-1"></a>        simpMessagingTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span><span class="st">&quot;/topic/over&quot;</span><span class="op">,</span> from<span class="op">);</span></span>
<span id="cb34-162"><a href="back.html#cb34-162" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-163"><a href="back.html#cb34-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-164"><a href="back.html#cb34-164" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="统一缓存和统一异常处理" class="section level2" number="1.8">
<h2><span class="header-section-number">1.8</span> 统一缓存和统一异常处理</h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb35-1"><a href="back.html#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">cache</span><span class="op">;</span></span>
<span id="cb35-2"><a href="back.html#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="back.html#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">annotation</span><span class="op">.*;</span></span>
<span id="cb35-4"><a href="back.html#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="back.html#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb35-6"><a href="back.html#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb35-7"><a href="back.html#cb35-7" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-01</span> <span class="co">7:45</span> AM</span>
<span id="cb35-8"><a href="back.html#cb35-8" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb35-9"><a href="back.html#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="at">@Target</span><span class="op">({</span><span class="bu">ElementType</span><span class="op">.</span><span class="fu">METHOD</span><span class="op">})</span></span>
<span id="cb35-10"><a href="back.html#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="at">@Retention</span><span class="op">(</span><span class="bu">RetentionPolicy</span><span class="op">.</span><span class="fu">RUNTIME</span><span class="op">)</span></span>
<span id="cb35-11"><a href="back.html#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="at">@Documented</span></span>
<span id="cb35-12"><a href="back.html#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="at">@interface</span> Cache <span class="op">{</span></span>
<span id="cb35-13"><a href="back.html#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="back.html#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">long</span> <span class="fu">expire</span><span class="op">()</span> <span class="kw">default</span> <span class="dv">120</span> <span class="op">*</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb35-15"><a href="back.html#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="back.html#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> <span class="fu">name</span><span class="op">()</span> <span class="kw">default</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb35-17"><a href="back.html#cb35-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-18"><a href="back.html#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-19"><a href="back.html#cb35-19" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb36-1"><a href="back.html#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="back.html#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">cache</span><span class="op">;</span></span>
<span id="cb36-3"><a href="back.html#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="back.html#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">cn</span><span class="op">.</span><span class="im">hutool</span><span class="op">.</span><span class="im">crypto</span><span class="op">.</span><span class="im">digest</span><span class="op">.</span><span class="im">DigestUtil</span><span class="op">;</span></span>
<span id="cb36-5"><a href="back.html#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">fasterxml</span><span class="op">.</span><span class="im">jackson</span><span class="op">.</span><span class="im">databind</span><span class="op">.</span><span class="im">ObjectMapper</span><span class="op">;</span></span>
<span id="cb36-6"><a href="back.html#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb36-7"><a href="back.html#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">SneakyThrows</span><span class="op">;</span></span>
<span id="cb36-8"><a href="back.html#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb36-9"><a href="back.html#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">aspectj</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">ProceedingJoinPoint</span><span class="op">;</span></span>
<span id="cb36-10"><a href="back.html#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">aspectj</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Signature</span><span class="op">;</span></span>
<span id="cb36-11"><a href="back.html#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">aspectj</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Around</span><span class="op">;</span></span>
<span id="cb36-12"><a href="back.html#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">aspectj</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Aspect</span><span class="op">;</span></span>
<span id="cb36-13"><a href="back.html#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">aspectj</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Pointcut</span><span class="op">;</span></span>
<span id="cb36-14"><a href="back.html#cb36-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb36-15"><a href="back.html#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">data</span><span class="op">.</span><span class="im">redis</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">RedisTemplate</span><span class="op">;</span></span>
<span id="cb36-16"><a href="back.html#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb36-17"><a href="back.html#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">StringUtils</span><span class="op">;</span></span>
<span id="cb36-18"><a href="back.html#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">reflect</span><span class="op">.</span><span class="im">Method</span><span class="op">;</span></span>
<span id="cb36-19"><a href="back.html#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">time</span><span class="op">.</span><span class="im">Duration</span><span class="op">;</span></span>
<span id="cb36-20"><a href="back.html#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Arrays</span><span class="op">;</span></span>
<span id="cb36-21"><a href="back.html#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">LinkedHashMap</span><span class="op">;</span></span>
<span id="cb36-22"><a href="back.html#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-23"><a href="back.html#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb36-24"><a href="back.html#cb36-24" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">统一缓存处理</span></span>
<span id="cb36-25"><a href="back.html#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb36-26"><a href="back.html#cb36-26" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-01</span> <span class="co">7:48</span> AM</span>
<span id="cb36-27"><a href="back.html#cb36-27" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb36-28"><a href="back.html#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="at">@Aspect</span></span>
<span id="cb36-29"><a href="back.html#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb36-30"><a href="back.html#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb36-31"><a href="back.html#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CacheAspect <span class="op">{</span></span>
<span id="cb36-32"><a href="back.html#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="back.html#cb36-33" aria-hidden="true" tabindex="-1"></a>    RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">;</span></span>
<span id="cb36-34"><a href="back.html#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="back.html#cb36-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb36-36"><a href="back.html#cb36-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">setRedisTemplateImpl</span><span class="op">(</span>RedisTemplate<span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-37"><a href="back.html#cb36-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">redisTemplate</span> <span class="op">=</span> redisTemplate<span class="op">;</span></span>
<span id="cb36-38"><a href="back.html#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-39"><a href="back.html#cb36-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-40"><a href="back.html#cb36-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Pointcut</span><span class="op">(</span><span class="st">&quot;@annotation(com.markerhub.common.cache.Cache)&quot;</span><span class="op">)</span></span>
<span id="cb36-41"><a href="back.html#cb36-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">pt</span><span class="op">()</span> <span class="op">{}</span></span>
<span id="cb36-42"><a href="back.html#cb36-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-43"><a href="back.html#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@SneakyThrows</span></span>
<span id="cb36-44"><a href="back.html#cb36-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Around</span><span class="op">(</span><span class="st">&quot;pt()&quot;</span><span class="op">)</span></span>
<span id="cb36-45"><a href="back.html#cb36-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Object</span> <span class="fu">around</span><span class="op">(</span>ProceedingJoinPoint pjp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-46"><a href="back.html#cb36-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Signature</span> signature <span class="op">=</span> pjp<span class="op">.</span><span class="fu">getSignature</span><span class="op">();</span></span>
<span id="cb36-47"><a href="back.html#cb36-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">//类名</span></span>
<span id="cb36-48"><a href="back.html#cb36-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> className <span class="op">=</span> pjp<span class="op">.</span><span class="fu">getTarget</span><span class="op">().</span><span class="fu">getClass</span><span class="op">().</span><span class="fu">getSimpleName</span><span class="op">();</span></span>
<span id="cb36-49"><a href="back.html#cb36-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">//调用的方法名</span></span>
<span id="cb36-50"><a href="back.html#cb36-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> methodName <span class="op">=</span> signature<span class="op">.</span><span class="fu">getName</span><span class="op">();</span></span>
<span id="cb36-51"><a href="back.html#cb36-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-52"><a href="back.html#cb36-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Class</span><span class="op">[]</span> parameterTypes <span class="op">=</span> <span class="kw">new</span> <span class="bu">Class</span><span class="op">[</span>pjp<span class="op">.</span><span class="fu">getArgs</span><span class="op">().</span><span class="fu">length</span><span class="op">];</span></span>
<span id="cb36-53"><a href="back.html#cb36-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span><span class="op">[]</span> args <span class="op">=</span> pjp<span class="op">.</span><span class="fu">getArgs</span><span class="op">();</span></span>
<span id="cb36-54"><a href="back.html#cb36-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">//参数</span></span>
<span id="cb36-55"><a href="back.html#cb36-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">StringBuilder</span> params <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">();</span></span>
<span id="cb36-56"><a href="back.html#cb36-56" aria-hidden="true" tabindex="-1"></a>        ObjectMapper objectMapper <span class="op">=</span> <span class="kw">new</span> <span class="fu">ObjectMapper</span><span class="op">();</span></span>
<span id="cb36-57"><a href="back.html#cb36-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> args<span class="op">.</span><span class="fu">length</span><span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb36-58"><a href="back.html#cb36-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>args<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-59"><a href="back.html#cb36-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-60"><a href="back.html#cb36-60" aria-hidden="true" tabindex="-1"></a>                params<span class="op">.</span><span class="fu">append</span><span class="op">(</span>objectMapper<span class="op">.</span><span class="fu">writeValueAsString</span><span class="op">(</span>args<span class="op">[</span>i<span class="op">]));</span></span>
<span id="cb36-61"><a href="back.html#cb36-61" aria-hidden="true" tabindex="-1"></a>                parameterTypes<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> args<span class="op">[</span>i<span class="op">].</span><span class="fu">getClass</span><span class="op">();</span></span>
<span id="cb36-62"><a href="back.html#cb36-62" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb36-63"><a href="back.html#cb36-63" aria-hidden="true" tabindex="-1"></a>                parameterTypes<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb36-64"><a href="back.html#cb36-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb36-65"><a href="back.html#cb36-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-66"><a href="back.html#cb36-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>StringUtils<span class="op">.</span><span class="fu">hasLength</span><span class="op">(</span>params<span class="op">.</span><span class="fu">toString</span><span class="op">()))</span> <span class="op">{</span></span>
<span id="cb36-67"><a href="back.html#cb36-67" aria-hidden="true" tabindex="-1"></a>            params <span class="op">=</span> <span class="kw">new</span> <span class="bu">StringBuilder</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">toString</span><span class="op">(</span>DigestUtil<span class="op">.</span><span class="fu">md5</span><span class="op">(</span>params<span class="op">.</span><span class="fu">toString</span><span class="op">())));</span></span>
<span id="cb36-68"><a href="back.html#cb36-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-69"><a href="back.html#cb36-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Method</span> method <span class="op">=</span> pjp<span class="op">.</span><span class="fu">getSignature</span><span class="op">().</span><span class="fu">getDeclaringType</span><span class="op">().</span><span class="fu">getMethod</span><span class="op">(</span>methodName<span class="op">,</span> parameterTypes<span class="op">);</span></span>
<span id="cb36-70"><a href="back.html#cb36-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-71"><a href="back.html#cb36-71" aria-hidden="true" tabindex="-1"></a>        Cache annotation <span class="op">=</span> method<span class="op">.</span><span class="fu">getAnnotation</span><span class="op">(</span>Cache<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb36-72"><a href="back.html#cb36-72" aria-hidden="true" tabindex="-1"></a>        <span class="dt">long</span> expire <span class="op">=</span> annotation<span class="op">.</span><span class="fu">expire</span><span class="op">();</span></span>
<span id="cb36-73"><a href="back.html#cb36-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> name <span class="op">=</span> annotation<span class="op">.</span><span class="fu">name</span><span class="op">();</span></span>
<span id="cb36-74"><a href="back.html#cb36-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-75"><a href="back.html#cb36-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> redisKey <span class="op">=</span> name <span class="op">+</span> <span class="st">&quot;::&quot;</span> <span class="op">+</span> className <span class="op">+</span> <span class="st">&quot;::&quot;</span> <span class="op">+</span> methodName <span class="op">+</span> <span class="st">&quot;::&quot;</span> <span class="op">+</span> params<span class="op">;</span></span>
<span id="cb36-76"><a href="back.html#cb36-76" aria-hidden="true" tabindex="-1"></a>        <span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> redisValue <span class="op">=</span> <span class="op">(</span><span class="bu">LinkedHashMap</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;)</span> redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">get</span><span class="op">(</span>redisKey<span class="op">);</span></span>
<span id="cb36-77"><a href="back.html#cb36-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Result</span> result <span class="op">=</span> objectMapper<span class="op">.</span><span class="fu">convertValue</span><span class="op">(</span>redisValue<span class="op">,</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb36-78"><a href="back.html#cb36-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>result <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-79"><a href="back.html#cb36-79" aria-hidden="true" tabindex="-1"></a>            log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;走了缓存, {}, {}&quot;</span><span class="op">,</span> className<span class="op">,</span> methodName<span class="op">);</span></span>
<span id="cb36-80"><a href="back.html#cb36-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb36-81"><a href="back.html#cb36-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb36-82"><a href="back.html#cb36-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-83"><a href="back.html#cb36-83" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;执行目标方法{}&quot;</span><span class="op">,</span> methodName<span class="op">);</span></span>
<span id="cb36-84"><a href="back.html#cb36-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-85"><a href="back.html#cb36-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Object</span> proceed <span class="op">=</span> pjp<span class="op">.</span><span class="fu">proceed</span><span class="op">();</span></span>
<span id="cb36-86"><a href="back.html#cb36-86" aria-hidden="true" tabindex="-1"></a>        redisTemplate<span class="op">.</span><span class="fu">opsForValue</span><span class="op">().</span><span class="fu">set</span><span class="op">(</span>redisKey<span class="op">,</span> proceed<span class="op">,</span> <span class="bu">Duration</span><span class="op">.</span><span class="fu">ofMillis</span><span class="op">(</span>expire<span class="op">));</span></span>
<span id="cb36-87"><a href="back.html#cb36-87" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;存入缓存, {}, {}&quot;</span><span class="op">,</span> className<span class="op">,</span> methodName<span class="op">);</span></span>
<span id="cb36-88"><a href="back.html#cb36-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> proceed<span class="op">;</span></span>
<span id="cb36-89"><a href="back.html#cb36-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-90"><a href="back.html#cb36-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-91"><a href="back.html#cb36-91" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-92"><a href="back.html#cb36-92" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb37-1"><a href="back.html#cb37-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2"><a href="back.html#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">exception</span><span class="op">;</span></span>
<span id="cb37-3"><a href="back.html#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="back.html#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">.</span><span class="im">Result</span><span class="op">;</span></span>
<span id="cb37-5"><a href="back.html#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb37-6"><a href="back.html#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">ShiroException</span><span class="op">;</span></span>
<span id="cb37-7"><a href="back.html#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">apache</span><span class="op">.</span><span class="im">shiro</span><span class="op">.</span><span class="im">authc</span><span class="op">.</span><span class="im">ExpiredCredentialsException</span><span class="op">;</span></span>
<span id="cb37-8"><a href="back.html#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">elasticsearch</span><span class="op">.</span><span class="im">client</span><span class="op">.</span><span class="im">tasks</span><span class="op">.</span><span class="im">ElasticsearchException</span><span class="op">;</span></span>
<span id="cb37-9"><a href="back.html#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">http</span><span class="op">.</span><span class="im">HttpStatus</span><span class="op">;</span></span>
<span id="cb37-10"><a href="back.html#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">BindingResult</span><span class="op">;</span></span>
<span id="cb37-11"><a href="back.html#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">ObjectError</span><span class="op">;</span></span>
<span id="cb37-12"><a href="back.html#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">MethodArgumentNotValidException</span><span class="op">;</span></span>
<span id="cb37-13"><a href="back.html#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">ExceptionHandler</span><span class="op">;</span></span>
<span id="cb37-14"><a href="back.html#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">ResponseStatus</span><span class="op">;</span></span>
<span id="cb37-15"><a href="back.html#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">bind</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RestControllerAdvice</span><span class="op">;</span></span>
<span id="cb37-16"><a href="back.html#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="back.html#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">ServletException</span><span class="op">;</span></span>
<span id="cb37-18"><a href="back.html#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="back.html#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb37-20"><a href="back.html#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb37-21"><a href="back.html#cb37-21" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">9:29</span> PM</span>
<span id="cb37-22"><a href="back.html#cb37-22" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb37-23"><a href="back.html#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb37-24"><a href="back.html#cb37-24" aria-hidden="true" tabindex="-1"></a><span class="at">@RestControllerAdvice</span></span>
<span id="cb37-25"><a href="back.html#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> GlobalExceptionHandler <span class="op">{</span></span>
<span id="cb37-26"><a href="back.html#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="back.html#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResponseStatus</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">UNAUTHORIZED</span><span class="op">)</span></span>
<span id="cb37-28"><a href="back.html#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ExceptionHandler</span><span class="op">(</span>value <span class="op">=</span> ShiroException<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb37-29"><a href="back.html#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">handler</span><span class="op">(</span>ShiroException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-30"><a href="back.html#cb37-30" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;权限异常------------{}&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb37-31"><a href="back.html#cb37-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span><span class="dv">401</span><span class="op">,</span> e<span class="op">.</span><span class="fu">getMessage</span><span class="op">(),</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb37-32"><a href="back.html#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-33"><a href="back.html#cb37-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-34"><a href="back.html#cb37-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResponseStatus</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">BAD_REQUEST</span><span class="op">)</span></span>
<span id="cb37-35"><a href="back.html#cb37-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ExceptionHandler</span><span class="op">(</span>value <span class="op">=</span> <span class="bu">RuntimeException</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb37-36"><a href="back.html#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">handler</span><span class="op">(</span><span class="bu">RuntimeException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-37"><a href="back.html#cb37-37" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;运行时异常------------{}&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb37-38"><a href="back.html#cb37-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span>e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb37-39"><a href="back.html#cb37-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-40"><a href="back.html#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="back.html#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResponseStatus</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">BAD_REQUEST</span><span class="op">)</span></span>
<span id="cb37-42"><a href="back.html#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ExceptionHandler</span><span class="op">(</span>value <span class="op">=</span> MethodArgumentNotValidException<span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb37-43"><a href="back.html#cb37-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">handler</span><span class="op">(</span>MethodArgumentNotValidException e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-44"><a href="back.html#cb37-44" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;实体校验异常------------{}&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb37-45"><a href="back.html#cb37-45" aria-hidden="true" tabindex="-1"></a>        BindingResult bindingResult <span class="op">=</span> e<span class="op">.</span><span class="fu">getBindingResult</span><span class="op">();</span></span>
<span id="cb37-46"><a href="back.html#cb37-46" aria-hidden="true" tabindex="-1"></a>        ObjectError objectError <span class="op">=</span> bindingResult<span class="op">.</span><span class="fu">getAllErrors</span><span class="op">().</span><span class="fu">stream</span><span class="op">().</span><span class="fu">findFirst</span><span class="op">().</span><span class="fu">get</span><span class="op">();</span></span>
<span id="cb37-47"><a href="back.html#cb37-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span>objectError<span class="op">.</span><span class="fu">getDefaultMessage</span><span class="op">());</span></span>
<span id="cb37-48"><a href="back.html#cb37-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-49"><a href="back.html#cb37-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-50"><a href="back.html#cb37-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ResponseStatus</span><span class="op">(</span>HttpStatus<span class="op">.</span><span class="fu">BAD_REQUEST</span><span class="op">)</span></span>
<span id="cb37-51"><a href="back.html#cb37-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">@ExceptionHandler</span><span class="op">(</span>value <span class="op">=</span> <span class="bu">IllegalArgumentException</span><span class="op">.</span><span class="fu">class</span><span class="op">)</span></span>
<span id="cb37-52"><a href="back.html#cb37-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Result</span> <span class="fu">handler</span><span class="op">(</span><span class="bu">IllegalArgumentException</span> e<span class="op">)</span> <span class="op">{</span></span>
<span id="cb37-53"><a href="back.html#cb37-53" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">error</span><span class="op">(</span><span class="st">&quot;Assert断言异常------------{}&quot;</span><span class="op">,</span> e<span class="op">);</span></span>
<span id="cb37-54"><a href="back.html#cb37-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">Result</span><span class="op">.</span><span class="fu">fail</span><span class="op">(</span>e<span class="op">.</span><span class="fu">getMessage</span><span class="op">());</span></span>
<span id="cb37-55"><a href="back.html#cb37-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb37-56"><a href="back.html#cb37-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-57"><a href="back.html#cb37-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb37-58"><a href="back.html#cb37-58" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<div id="其他部分" class="section level2" number="1.9">
<h2><span class="header-section-number">1.9</span> 其他部分</h2>
<div class="sourceCode" id="cb38"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb38-1"><a href="back.html#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb38-2"><a href="back.html#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="back.html#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">google</span><span class="op">.</span><span class="im">code</span><span class="op">.</span><span class="im">kaptcha</span><span class="op">.</span><span class="im">impl</span><span class="op">.</span><span class="im">DefaultKaptcha</span><span class="op">;</span></span>
<span id="cb38-4"><a href="back.html#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">google</span><span class="op">.</span><span class="im">code</span><span class="op">.</span><span class="im">kaptcha</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Config</span><span class="op">;</span></span>
<span id="cb38-5"><a href="back.html#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb38-6"><a href="back.html#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb38-7"><a href="back.html#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="back.html#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">Properties</span><span class="op">;</span></span>
<span id="cb38-9"><a href="back.html#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">util</span><span class="op">.</span><span class="im">concurrent</span><span class="op">.</span><span class="im">TimeUnit</span><span class="op">;</span></span>
<span id="cb38-10"><a href="back.html#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="back.html#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb38-12"><a href="back.html#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb38-13"><a href="back.html#cb38-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-14</span> <span class="co">11:52</span> AM</span>
<span id="cb38-14"><a href="back.html#cb38-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb38-15"><a href="back.html#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb38-16"><a href="back.html#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> KaptchaConfig <span class="op">{</span></span>
<span id="cb38-17"><a href="back.html#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="back.html#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb38-19"><a href="back.html#cb38-19" aria-hidden="true" tabindex="-1"></a>    DefaultKaptcha <span class="fu">producer</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb38-20"><a href="back.html#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Properties</span> properties <span class="op">=</span> <span class="kw">new</span> <span class="bu">Properties</span><span class="op">();</span></span>
<span id="cb38-21"><a href="back.html#cb38-21" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;kaptcha.border&quot;</span><span class="op">,</span> <span class="st">&quot;no&quot;</span><span class="op">);</span></span>
<span id="cb38-22"><a href="back.html#cb38-22" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;kaptcha.textproducer.font.color&quot;</span><span class="op">,</span> <span class="st">&quot;black&quot;</span><span class="op">);</span></span>
<span id="cb38-23"><a href="back.html#cb38-23" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;kaptcha.textproducer.char.space&quot;</span><span class="op">,</span> <span class="st">&quot;4&quot;</span><span class="op">);</span></span>
<span id="cb38-24"><a href="back.html#cb38-24" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;kaptcha.image.height&quot;</span><span class="op">,</span> <span class="st">&quot;40&quot;</span><span class="op">);</span></span>
<span id="cb38-25"><a href="back.html#cb38-25" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;kaptcha.image.width&quot;</span><span class="op">,</span> <span class="st">&quot;120&quot;</span><span class="op">);</span></span>
<span id="cb38-26"><a href="back.html#cb38-26" aria-hidden="true" tabindex="-1"></a>        properties<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;kaptcha.textproducer.font.size&quot;</span><span class="op">,</span> <span class="st">&quot;30&quot;</span><span class="op">);</span></span>
<span id="cb38-27"><a href="back.html#cb38-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-28"><a href="back.html#cb38-28" aria-hidden="true" tabindex="-1"></a>        Config config <span class="op">=</span> <span class="kw">new</span> <span class="fu">Config</span><span class="op">(</span>properties<span class="op">);</span></span>
<span id="cb38-29"><a href="back.html#cb38-29" aria-hidden="true" tabindex="-1"></a>        DefaultKaptcha defaultKaptcha <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultKaptcha</span><span class="op">();</span></span>
<span id="cb38-30"><a href="back.html#cb38-30" aria-hidden="true" tabindex="-1"></a>        defaultKaptcha<span class="op">.</span><span class="fu">setConfig</span><span class="op">(</span>config<span class="op">);</span></span>
<span id="cb38-31"><a href="back.html#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="back.html#cb38-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> defaultKaptcha<span class="op">;</span></span>
<span id="cb38-33"><a href="back.html#cb38-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-34"><a href="back.html#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb38-35"><a href="back.html#cb38-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-36"><a href="back.html#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb39-1"><a href="back.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb39-2"><a href="back.html#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="back.html#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">DbType</span><span class="op">;</span></span>
<span id="cb39-4"><a href="back.html#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">plugins</span><span class="op">.</span><span class="im">MybatisPlusInterceptor</span><span class="op">;</span></span>
<span id="cb39-5"><a href="back.html#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">baomidou</span><span class="op">.</span><span class="im">mybatisplus</span><span class="op">.</span><span class="im">extension</span><span class="op">.</span><span class="im">plugins</span><span class="op">.</span><span class="im">inner</span><span class="op">.</span><span class="im">PaginationInnerInterceptor</span><span class="op">;</span></span>
<span id="cb39-6"><a href="back.html#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">mybatis</span><span class="op">.</span><span class="im">spring</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">MapperScan</span><span class="op">;</span></span>
<span id="cb39-7"><a href="back.html#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb39-8"><a href="back.html#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb39-9"><a href="back.html#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">transaction</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">EnableTransactionManagement</span><span class="op">;</span></span>
<span id="cb39-10"><a href="back.html#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="back.html#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb39-12"><a href="back.html#cb39-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">分页拦截器</span></span>
<span id="cb39-13"><a href="back.html#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb39-14"><a href="back.html#cb39-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">2:39</span> PM</span>
<span id="cb39-15"><a href="back.html#cb39-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb39-16"><a href="back.html#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb39-17"><a href="back.html#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="at">@EnableTransactionManagement</span></span>
<span id="cb39-18"><a href="back.html#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="at">@MapperScan</span><span class="op">(</span><span class="st">&quot;com.markerhub.mapper&quot;</span><span class="op">)</span></span>
<span id="cb39-19"><a href="back.html#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> MyBatisPlusConfig <span class="op">{</span></span>
<span id="cb39-20"><a href="back.html#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="back.html#cb39-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb39-22"><a href="back.html#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> MybatisPlusInterceptor <span class="fu">mybatisPlusInterceptor</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb39-23"><a href="back.html#cb39-23" aria-hidden="true" tabindex="-1"></a>        MybatisPlusInterceptor interceptor <span class="op">=</span> <span class="kw">new</span> <span class="fu">MybatisPlusInterceptor</span><span class="op">();</span></span>
<span id="cb39-24"><a href="back.html#cb39-24" aria-hidden="true" tabindex="-1"></a>        interceptor<span class="op">.</span><span class="fu">addInnerInterceptor</span><span class="op">(</span><span class="kw">new</span> <span class="fu">PaginationInnerInterceptor</span><span class="op">(</span>DbType<span class="op">.</span><span class="fu">MYSQL</span><span class="op">));</span></span>
<span id="cb39-25"><a href="back.html#cb39-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> interceptor<span class="op">;</span></span>
<span id="cb39-26"><a href="back.html#cb39-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb39-27"><a href="back.html#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-28"><a href="back.html#cb39-28" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb40-1"><a href="back.html#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb40-2"><a href="back.html#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="back.html#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="back.html#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb40-5"><a href="back.html#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">CorsRegistry</span><span class="op">;</span></span>
<span id="cb40-6"><a href="back.html#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">InterceptorRegistry</span><span class="op">;</span></span>
<span id="cb40-7"><a href="back.html#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">ResourceHandlerRegistry</span><span class="op">;</span></span>
<span id="cb40-8"><a href="back.html#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">web</span><span class="op">.</span><span class="im">servlet</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">WebMvcConfigurer</span><span class="op">;</span></span>
<span id="cb40-9"><a href="back.html#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="back.html#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb40-11"><a href="back.html#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb40-12"><a href="back.html#cb40-12" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-11-06</span> <span class="co">6:24</span> PM</span>
<span id="cb40-13"><a href="back.html#cb40-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb40-14"><a href="back.html#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb40-15"><a href="back.html#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> WebMvcConfig <span class="kw">implements</span> WebMvcConfigurer <span class="op">{</span></span>
<span id="cb40-16"><a href="back.html#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb40-17"><a href="back.html#cb40-17" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">文件上传处理，</span>URL<span class="co">映射到本地磁盘路径</span></span>
<span id="cb40-18"><a href="back.html#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param registry</span>
<span id="cb40-19"><a href="back.html#cb40-19" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb40-20"><a href="back.html#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb40-21"><a href="back.html#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">addResourceHandlers</span><span class="op">(</span>ResourceHandlerRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-22"><a href="back.html#cb40-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">//测试环境</span></span>
<span id="cb40-23"><a href="back.html#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co">//        registry.addResourceHandler(&quot;/upload/**&quot;).addResourceLocations(&quot;file:/users/mingchiuli/desktop/&quot;);</span></span>
<span id="cb40-24"><a href="back.html#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co">//        服务器环境</span></span>
<span id="cb40-25"><a href="back.html#cb40-25" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addResourceHandler</span><span class="op">(</span><span class="st">&quot;/upload/**&quot;</span><span class="op">).</span><span class="fu">addResourceLocations</span><span class="op">(</span><span class="st">&quot;file:/usr/local/vueblogresources/&quot;</span><span class="op">);</span></span>
<span id="cb40-26"><a href="back.html#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-27"><a href="back.html#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="back.html#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb40-29"><a href="back.html#cb40-29" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> <span class="co">解决跨域问题</span></span>
<span id="cb40-30"><a href="back.html#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="co">     * @</span>param registry</span>
<span id="cb40-31"><a href="back.html#cb40-31" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb40-32"><a href="back.html#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb40-33"><a href="back.html#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">addCorsMappings</span><span class="op">(</span>CorsRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-34"><a href="back.html#cb40-34" aria-hidden="true" tabindex="-1"></a>        registry<span class="op">.</span><span class="fu">addMapping</span><span class="op">(</span><span class="st">&quot;/**&quot;</span><span class="op">)</span></span>
<span id="cb40-35"><a href="back.html#cb40-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">allowedOriginPatterns</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">)</span></span>
<span id="cb40-36"><a href="back.html#cb40-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">allowedMethods</span><span class="op">(</span><span class="st">&quot;GET&quot;</span><span class="op">,</span> <span class="st">&quot;HEAD&quot;</span><span class="op">,</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="st">&quot;PUT&quot;</span><span class="op">,</span> <span class="st">&quot;DELETE&quot;</span><span class="op">,</span> <span class="st">&quot;OPTIONS&quot;</span><span class="op">)</span></span>
<span id="cb40-37"><a href="back.html#cb40-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">allowCredentials</span><span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb40-38"><a href="back.html#cb40-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">maxAge</span><span class="op">(</span><span class="dv">3600</span><span class="op">)</span></span>
<span id="cb40-39"><a href="back.html#cb40-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">allowedHeaders</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">);</span></span>
<span id="cb40-40"><a href="back.html#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb40-41"><a href="back.html#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-42"><a href="back.html#cb40-42" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb41-1"><a href="back.html#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">dto</span><span class="op">;</span></span>
<span id="cb41-2"><a href="back.html#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="back.html#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb41-4"><a href="back.html#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="back.html#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">constraints</span><span class="op">.</span><span class="im">NotBlank</span><span class="op">;</span></span>
<span id="cb41-6"><a href="back.html#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb41-7"><a href="back.html#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="back.html#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb41-9"><a href="back.html#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LoginDto <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb41-10"><a href="back.html#cb41-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-11"><a href="back.html#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;昵称不能为空&quot;</span><span class="op">)</span></span>
<span id="cb41-12"><a href="back.html#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> username<span class="op">;</span></span>
<span id="cb41-13"><a href="back.html#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="back.html#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;密码不能为空&quot;</span><span class="op">)</span></span>
<span id="cb41-15"><a href="back.html#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> password<span class="op">;</span></span>
<span id="cb41-16"><a href="back.html#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="back.html#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;验证码异常&quot;</span><span class="op">)</span></span>
<span id="cb41-18"><a href="back.html#cb41-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> token<span class="op">;</span></span>
<span id="cb41-19"><a href="back.html#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="back.html#cb41-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;验证码异常&quot;</span><span class="op">)</span></span>
<span id="cb41-21"><a href="back.html#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> code<span class="op">;</span></span>
<span id="cb41-22"><a href="back.html#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-23"><a href="back.html#cb41-23" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="back.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">dto</span><span class="op">;</span></span>
<span id="cb42-2"><a href="back.html#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="back.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb42-4"><a href="back.html#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="back.html#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">javax</span><span class="op">.</span><span class="im">validation</span><span class="op">.</span><span class="im">constraints</span><span class="op">.</span><span class="im">NotBlank</span><span class="op">;</span></span>
<span id="cb42-6"><a href="back.html#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="back.html#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb42-8"><a href="back.html#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb42-9"><a href="back.html#cb42-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-14</span> <span class="co">2:08</span> PM</span>
<span id="cb42-10"><a href="back.html#cb42-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb42-11"><a href="back.html#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb42-12"><a href="back.html#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> PasswordDto <span class="op">{</span></span>
<span id="cb42-13"><a href="back.html#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;昵称不能为空&quot;</span><span class="op">)</span></span>
<span id="cb42-14"><a href="back.html#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> username<span class="op">;</span></span>
<span id="cb42-15"><a href="back.html#cb42-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-16"><a href="back.html#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@NotBlank</span><span class="op">(</span>message <span class="op">=</span> <span class="st">&quot;密码不能为空&quot;</span><span class="op">)</span></span>
<span id="cb42-17"><a href="back.html#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> password<span class="op">;</span></span>
<span id="cb42-18"><a href="back.html#cb42-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-19"><a href="back.html#cb42-19" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb43-1"><a href="back.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">;</span></span>
<span id="cb43-2"><a href="back.html#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="back.html#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb43-4"><a href="back.html#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb43-5"><a href="back.html#cb43-5" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-14</span> <span class="co">11:58</span> AM</span>
<span id="cb43-6"><a href="back.html#cb43-6" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb43-7"><a href="back.html#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> Const <span class="op">{</span></span>
<span id="cb43-8"><a href="back.html#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="back.html#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> CAPTCHA_KEY <span class="op">=</span> <span class="st">&quot;captcha&quot;</span><span class="op">;</span></span>
<span id="cb43-10"><a href="back.html#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="back.html#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> USER_PREFIX <span class="op">=</span> <span class="st">&quot;user:&quot;</span><span class="op">;</span></span>
<span id="cb43-12"><a href="back.html#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="back.html#cb43-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> USER_OBJECT <span class="op">=</span> <span class="st">&quot;userObj&quot;</span><span class="op">;</span></span>
<span id="cb43-14"><a href="back.html#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="back.html#cb43-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> TOKEN <span class="op">=</span> <span class="st">&quot;token&quot;</span><span class="op">;</span></span>
<span id="cb43-16"><a href="back.html#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="back.html#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> READ_SUM <span class="op">=</span> <span class="st">&quot;blogsReadSum&quot;</span><span class="op">;</span></span>
<span id="cb43-18"><a href="back.html#cb43-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-19"><a href="back.html#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> READ_RECENT <span class="op">=</span> <span class="st">&quot;blogReadRecent:&quot;</span><span class="op">;</span></span>
<span id="cb43-20"><a href="back.html#cb43-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-21"><a href="back.html#cb43-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> HOT_PREFIX <span class="op">=</span> <span class="st">&quot;hot_blogs&quot;</span><span class="op">;</span></span>
<span id="cb43-22"><a href="back.html#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="back.html#cb43-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">//url相关，不相关上传路径</span></span>
<span id="cb43-24"><a href="back.html#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="bu">String</span> UPLOAD_IMG_PATH <span class="op">=</span> <span class="st">&quot;/upload/img/&quot;</span><span class="op">;</span></span>
<span id="cb43-25"><a href="back.html#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="back.html#cb43-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ROLE_PREFIX <span class="op">=</span> <span class="st">&quot;role:&quot;</span><span class="op">;</span></span>
<span id="cb43-27"><a href="back.html#cb43-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-28"><a href="back.html#cb43-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb44-1"><a href="back.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">common</span><span class="op">.</span><span class="im">lang</span><span class="op">;</span></span>
<span id="cb44-2"><a href="back.html#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="back.html#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">Data</span><span class="op">;</span></span>
<span id="cb44-4"><a href="back.html#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="back.html#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">java</span><span class="op">.</span><span class="im">io</span><span class="op">.</span><span class="im">Serializable</span><span class="op">;</span></span>
<span id="cb44-6"><a href="back.html#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="back.html#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb44-8"><a href="back.html#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb44-9"><a href="back.html#cb44-9" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-10-27</span> <span class="co">3:27</span> PM</span>
<span id="cb44-10"><a href="back.html#cb44-10" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb44-11"><a href="back.html#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="at">@Data</span></span>
<span id="cb44-12"><a href="back.html#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> <span class="bu">Result</span> <span class="kw">implements</span> <span class="bu">Serializable</span> <span class="op">{</span></span>
<span id="cb44-13"><a href="back.html#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="back.html#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">int</span> code<span class="op">;</span></span>
<span id="cb44-15"><a href="back.html#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> msg<span class="op">;</span></span>
<span id="cb44-16"><a href="back.html#cb44-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">Object</span> data<span class="op">;</span></span>
<span id="cb44-17"><a href="back.html#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="back.html#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">Result</span> <span class="fu">succ</span><span class="op">(</span><span class="bu">Object</span> data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-19"><a href="back.html#cb44-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">load</span><span class="op">(</span><span class="dv">200</span><span class="op">,</span> <span class="st">&quot;操作成功&quot;</span><span class="op">,</span>data<span class="op">);</span> <span class="co">//200为正常，非200为非正常</span></span>
<span id="cb44-20"><a href="back.html#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-21"><a href="back.html#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="back.html#cb44-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="bu">Result</span> <span class="fu">load</span><span class="op">(</span><span class="dt">int</span> code<span class="op">,</span> <span class="bu">String</span> msg<span class="op">,</span> <span class="bu">Object</span> data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-23"><a href="back.html#cb44-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Result</span> r <span class="op">=</span> <span class="kw">new</span> <span class="bu">Result</span><span class="op">();</span></span>
<span id="cb44-24"><a href="back.html#cb44-24" aria-hidden="true" tabindex="-1"></a>        r<span class="op">.</span><span class="fu">setCode</span><span class="op">(</span>code<span class="op">);</span></span>
<span id="cb44-25"><a href="back.html#cb44-25" aria-hidden="true" tabindex="-1"></a>        r<span class="op">.</span><span class="fu">setData</span><span class="op">(</span>data<span class="op">);</span></span>
<span id="cb44-26"><a href="back.html#cb44-26" aria-hidden="true" tabindex="-1"></a>        r<span class="op">.</span><span class="fu">setMsg</span><span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb44-27"><a href="back.html#cb44-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> r<span class="op">;</span></span>
<span id="cb44-28"><a href="back.html#cb44-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-29"><a href="back.html#cb44-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">Result</span> <span class="fu">fail</span><span class="op">(</span><span class="bu">Integer</span> code<span class="op">,</span> <span class="bu">String</span> msg<span class="op">,</span> <span class="bu">Object</span> data<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-30"><a href="back.html#cb44-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">load</span><span class="op">(</span>code<span class="op">,</span> msg<span class="op">,</span> data<span class="op">);</span></span>
<span id="cb44-31"><a href="back.html#cb44-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-32"><a href="back.html#cb44-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-33"><a href="back.html#cb44-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="bu">Result</span> <span class="fu">fail</span><span class="op">(</span><span class="bu">String</span> msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-34"><a href="back.html#cb44-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">load</span><span class="op">(</span><span class="dv">400</span><span class="op">,</span> msg<span class="op">,</span> <span class="kw">null</span><span class="op">);</span></span>
<span id="cb44-35"><a href="back.html#cb44-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-36"><a href="back.html#cb44-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-37"><a href="back.html#cb44-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="日志监控" class="section level2" number="1.10">
<h2><span class="header-section-number">1.10</span> 日志监控</h2>
<p>打一条日志就往rabbitmq灌一条，然后ws输出到网页上。</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb45-1"><a href="back.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">log</span><span class="op">.</span><span class="im">mq</span><span class="op">;</span></span>
<span id="cb45-2"><a href="back.html#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="back.html#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">.</span><span class="im">RabbitConfig</span><span class="op">;</span></span>
<span id="cb45-4"><a href="back.html#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb45-5"><a href="back.html#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">rabbit</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">RabbitListener</span><span class="op">;</span></span>
<span id="cb45-6"><a href="back.html#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb45-7"><a href="back.html#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">simp</span><span class="op">.</span><span class="im">SimpMessagingTemplate</span><span class="op">;</span></span>
<span id="cb45-8"><a href="back.html#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Component</span><span class="op">;</span></span>
<span id="cb45-9"><a href="back.html#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="back.html#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb45-11"><a href="back.html#cb45-11" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> logback<span class="co">日志内容塞到</span>rabbitmq<span class="co">队列里</span></span>
<span id="cb45-12"><a href="back.html#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb45-13"><a href="back.html#cb45-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2022-01-03</span> <span class="co">8:56</span> PM</span>
<span id="cb45-14"><a href="back.html#cb45-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb45-15"><a href="back.html#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb45-16"><a href="back.html#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb45-17"><a href="back.html#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogMessageHandler <span class="op">{</span></span>
<span id="cb45-18"><a href="back.html#cb45-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-19"><a href="back.html#cb45-19" aria-hidden="true" tabindex="-1"></a>    SimpMessagingTemplate simpMessagingTemplate<span class="op">;</span></span>
<span id="cb45-20"><a href="back.html#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="back.html#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb45-22"><a href="back.html#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setSimpMessagingTemplate</span><span class="op">(</span>SimpMessagingTemplate simpMessagingTemplate<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-23"><a href="back.html#cb45-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">simpMessagingTemplate</span> <span class="op">=</span> simpMessagingTemplate<span class="op">;</span></span>
<span id="cb45-24"><a href="back.html#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-25"><a href="back.html#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="back.html#cb45-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@RabbitListener</span><span class="op">(</span>id <span class="op">=</span> <span class="st">&quot;log&quot;</span><span class="op">,</span> queues <span class="op">=</span> RabbitConfig<span class="op">.</span><span class="fu">LOG_QUEUE</span><span class="op">,</span> autoStartup <span class="op">=</span> <span class="st">&quot;false&quot;</span><span class="op">)</span></span>
<span id="cb45-27"><a href="back.html#cb45-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">processMessage</span><span class="op">(</span><span class="bu">String</span> msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb45-28"><a href="back.html#cb45-28" aria-hidden="true" tabindex="-1"></a>        simpMessagingTemplate<span class="op">.</span><span class="fu">convertAndSend</span><span class="op">(</span><span class="st">&quot;/logs/log&quot;</span><span class="op">,</span> msg<span class="op">);</span></span>
<span id="cb45-29"><a href="back.html#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb45-30"><a href="back.html#cb45-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb46-1"><a href="back.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">controller</span><span class="op">;</span></span>
<span id="cb46-2"><a href="back.html#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="back.html#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">lombok</span><span class="op">.</span><span class="im">extern</span><span class="op">.</span><span class="im">slf4j</span><span class="op">.</span><span class="im">Slf4j</span><span class="op">;</span></span>
<span id="cb46-4"><a href="back.html#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">rabbit</span><span class="op">.</span><span class="im">listener</span><span class="op">.</span><span class="im">MessageListenerContainer</span><span class="op">;</span></span>
<span id="cb46-5"><a href="back.html#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">rabbit</span><span class="op">.</span><span class="im">listener</span><span class="op">.</span><span class="im">RabbitListenerEndpointRegistry</span><span class="op">;</span></span>
<span id="cb46-6"><a href="back.html#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Autowired</span><span class="op">;</span></span>
<span id="cb46-7"><a href="back.html#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">messaging</span><span class="op">.</span><span class="im">handler</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">MessageMapping</span><span class="op">;</span></span>
<span id="cb46-8"><a href="back.html#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">stereotype</span><span class="op">.</span><span class="im">Controller</span><span class="op">;</span></span>
<span id="cb46-9"><a href="back.html#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="back.html#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="back.html#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb46-12"><a href="back.html#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb46-13"><a href="back.html#cb46-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2022-01-04</span> <span class="co">4:35</span> PM</span>
<span id="cb46-14"><a href="back.html#cb46-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb46-15"><a href="back.html#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="at">@Controller</span></span>
<span id="cb46-16"><a href="back.html#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="at">@Slf4j</span></span>
<span id="cb46-17"><a href="back.html#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> LogController <span class="op">{</span></span>
<span id="cb46-18"><a href="back.html#cb46-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-19"><a href="back.html#cb46-19" aria-hidden="true" tabindex="-1"></a>    RabbitListenerEndpointRegistry registry<span class="op">;</span></span>
<span id="cb46-20"><a href="back.html#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="back.html#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb46-22"><a href="back.html#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setRegistry</span><span class="op">(</span>RabbitListenerEndpointRegistry registry<span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-23"><a href="back.html#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">registry</span> <span class="op">=</span> registry<span class="op">;</span></span>
<span id="cb46-24"><a href="back.html#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-25"><a href="back.html#cb46-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-26"><a href="back.html#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/startMQ&quot;</span><span class="op">)</span></span>
<span id="cb46-27"><a href="back.html#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">start</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb46-28"><a href="back.html#cb46-28" aria-hidden="true" tabindex="-1"></a>        MessageListenerContainer logContainer <span class="op">=</span> registry<span class="op">.</span><span class="fu">getListenerContainer</span><span class="op">(</span><span class="st">&quot;log&quot;</span><span class="op">);</span></span>
<span id="cb46-29"><a href="back.html#cb46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-30"><a href="back.html#cb46-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>logContainer<span class="op">.</span><span class="fu">isRunning</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb46-31"><a href="back.html#cb46-31" aria-hidden="true" tabindex="-1"></a>            logContainer<span class="op">.</span><span class="fu">start</span><span class="op">();</span></span>
<span id="cb46-32"><a href="back.html#cb46-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb46-33"><a href="back.html#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="back.html#cb46-34" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;消息队列日志监听器已开启&quot;</span><span class="op">);</span></span>
<span id="cb46-35"><a href="back.html#cb46-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-36"><a href="back.html#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="back.html#cb46-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">@MessageMapping</span><span class="op">(</span><span class="st">&quot;/stopMQ&quot;</span><span class="op">)</span></span>
<span id="cb46-38"><a href="back.html#cb46-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">stop</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb46-39"><a href="back.html#cb46-39" aria-hidden="true" tabindex="-1"></a>        MessageListenerContainer logContainer <span class="op">=</span> registry<span class="op">.</span><span class="fu">getListenerContainer</span><span class="op">(</span><span class="st">&quot;log&quot;</span><span class="op">);</span></span>
<span id="cb46-40"><a href="back.html#cb46-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-41"><a href="back.html#cb46-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>logContainer<span class="op">.</span><span class="fu">isRunning</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb46-42"><a href="back.html#cb46-42" aria-hidden="true" tabindex="-1"></a>            logContainer<span class="op">.</span><span class="fu">stop</span><span class="op">();</span></span>
<span id="cb46-43"><a href="back.html#cb46-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb46-44"><a href="back.html#cb46-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-45"><a href="back.html#cb46-45" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;消息队列日志监听器已关闭&quot;</span><span class="op">);</span></span>
<span id="cb46-46"><a href="back.html#cb46-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb46-47"><a href="back.html#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb47-1"><a href="back.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span><span class="im"> com</span><span class="op">.</span><span class="im">markerhub</span><span class="op">.</span><span class="im">config</span><span class="op">;</span></span>
<span id="cb47-2"><a href="back.html#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="back.html#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">Binding</span><span class="op">;</span></span>
<span id="cb47-4"><a href="back.html#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">BindingBuilder</span><span class="op">;</span></span>
<span id="cb47-5"><a href="back.html#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">DirectExchange</span><span class="op">;</span></span>
<span id="cb47-6"><a href="back.html#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">core</span><span class="op">.</span><span class="im">Queue</span><span class="op">;</span></span>
<span id="cb47-7"><a href="back.html#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">amqp</span><span class="op">.</span><span class="im">rabbit</span><span class="op">.</span><span class="im">listener</span><span class="op">.</span><span class="im">RabbitListenerEndpointRegistry</span><span class="op">;</span></span>
<span id="cb47-8"><a href="back.html#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">beans</span><span class="op">.</span><span class="im">factory</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Qualifier</span><span class="op">;</span></span>
<span id="cb47-9"><a href="back.html#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Bean</span><span class="op">;</span></span>
<span id="cb47-10"><a href="back.html#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">org</span><span class="op">.</span><span class="im">springframework</span><span class="op">.</span><span class="im">context</span><span class="op">.</span><span class="im">annotation</span><span class="op">.</span><span class="im">Configuration</span><span class="op">;</span></span>
<span id="cb47-11"><a href="back.html#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="back.html#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb47-13"><a href="back.html#cb47-13" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> RabbitMQ</span>
<span id="cb47-14"><a href="back.html#cb47-14" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">作用是同步</span>ES</span>
<span id="cb47-15"><a href="back.html#cb47-15" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">和</span></span>
<span id="cb47-16"><a href="back.html#cb47-16" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">将日志输出到</span>MQ</span>
<span id="cb47-17"><a href="back.html#cb47-17" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span></span>
<span id="cb47-18"><a href="back.html#cb47-18" aria-hidden="true" tabindex="-1"></a><span class="co"> * @</span>author mingchiuli</span>
<span id="cb47-19"><a href="back.html#cb47-19" aria-hidden="true" tabindex="-1"></a> <span class="co">*</span> <span class="co">@</span>create <span class="co">2021-12-12</span> <span class="co">11:22</span> PM</span>
<span id="cb47-20"><a href="back.html#cb47-20" aria-hidden="true" tabindex="-1"></a> <span class="co">*/</span></span>
<span id="cb47-21"><a href="back.html#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="at">@Configuration</span></span>
<span id="cb47-22"><a href="back.html#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> RabbitConfig <span class="op">{</span></span>
<span id="cb47-23"><a href="back.html#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="back.html#cb47-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ES_QUEUE <span class="op">=</span> <span class="st">&quot;ex_queue&quot;</span><span class="op">;</span></span>
<span id="cb47-25"><a href="back.html#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ES_EXCHANGE <span class="op">=</span> <span class="st">&quot;ex_exchange&quot;</span><span class="op">;</span></span>
<span id="cb47-26"><a href="back.html#cb47-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> ES_BINDING_KEY <span class="op">=</span> <span class="st">&quot;ex_exchange&quot;</span><span class="op">;</span></span>
<span id="cb47-27"><a href="back.html#cb47-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-28"><a href="back.html#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> LOG_QUEUE <span class="op">=</span> <span class="st">&quot;log_queue&quot;</span><span class="op">;</span></span>
<span id="cb47-29"><a href="back.html#cb47-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> LOG_EXCHANGE <span class="op">=</span> <span class="st">&quot;log_exchange&quot;</span><span class="op">;</span></span>
<span id="cb47-30"><a href="back.html#cb47-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> LOG_BINDING_KEY <span class="op">=</span> <span class="st">&quot;log_exchange&quot;</span><span class="op">;</span></span>
<span id="cb47-31"><a href="back.html#cb47-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-32"><a href="back.html#cb47-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-33"><a href="back.html#cb47-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-34"><a href="back.html#cb47-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">//ES队列</span></span>
<span id="cb47-35"><a href="back.html#cb47-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span><span class="op">(</span><span class="st">&quot;ES_QUEUE&quot;</span><span class="op">)</span></span>
<span id="cb47-36"><a href="back.html#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Queue</span> <span class="fu">esQueue</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-37"><a href="back.html#cb47-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Queue</span><span class="op">(</span>ES_QUEUE<span class="op">);</span></span>
<span id="cb47-38"><a href="back.html#cb47-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-39"><a href="back.html#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="back.html#cb47-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">//ES交换机</span></span>
<span id="cb47-41"><a href="back.html#cb47-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span><span class="op">(</span><span class="st">&quot;ES_EXCHANGE&quot;</span><span class="op">)</span></span>
<span id="cb47-42"><a href="back.html#cb47-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DirectExchange <span class="fu">esExchange</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-43"><a href="back.html#cb47-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">DirectExchange</span><span class="op">(</span>ES_EXCHANGE<span class="op">);</span></span>
<span id="cb47-44"><a href="back.html#cb47-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-45"><a href="back.html#cb47-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-46"><a href="back.html#cb47-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">//绑定ES队列和ES交换机</span></span>
<span id="cb47-47"><a href="back.html#cb47-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb47-48"><a href="back.html#cb47-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Binding</span> <span class="fu">esBinding</span><span class="op">(</span><span class="at">@Qualifier</span><span class="op">(</span><span class="st">&quot;ES_QUEUE&quot;</span><span class="op">)</span> <span class="bu">Queue</span> esQueue<span class="op">,</span> <span class="at">@Qualifier</span><span class="op">(</span><span class="st">&quot;ES_EXCHANGE&quot;</span><span class="op">)</span> DirectExchange esExchange<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-49"><a href="back.html#cb47-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BindingBuilder<span class="op">.</span><span class="fu">bind</span><span class="op">(</span>esQueue<span class="op">).</span><span class="fu">to</span><span class="op">(</span>esExchange<span class="op">).</span><span class="fu">with</span><span class="op">(</span>ES_BINDING_KEY<span class="op">);</span></span>
<span id="cb47-50"><a href="back.html#cb47-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-51"><a href="back.html#cb47-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-52"><a href="back.html#cb47-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">//LOG队列</span></span>
<span id="cb47-53"><a href="back.html#cb47-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span><span class="op">(</span><span class="st">&quot;LOG_QUEUE&quot;</span><span class="op">)</span></span>
<span id="cb47-54"><a href="back.html#cb47-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Queue</span> <span class="fu">logQueue</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-55"><a href="back.html#cb47-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Queue</span><span class="op">(</span>LOG_QUEUE<span class="op">);</span></span>
<span id="cb47-56"><a href="back.html#cb47-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-57"><a href="back.html#cb47-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-58"><a href="back.html#cb47-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">//LOG交换机</span></span>
<span id="cb47-59"><a href="back.html#cb47-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span><span class="op">(</span><span class="st">&quot;LOG_EXCHANGE&quot;</span><span class="op">)</span></span>
<span id="cb47-60"><a href="back.html#cb47-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> DirectExchange <span class="fu">logExchange</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb47-61"><a href="back.html#cb47-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">DirectExchange</span><span class="op">(</span>LOG_EXCHANGE<span class="op">);</span></span>
<span id="cb47-62"><a href="back.html#cb47-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-63"><a href="back.html#cb47-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-64"><a href="back.html#cb47-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">//绑定LOG队列和LOG交换机</span></span>
<span id="cb47-65"><a href="back.html#cb47-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Bean</span></span>
<span id="cb47-66"><a href="back.html#cb47-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">Binding</span> <span class="fu">LogBinding</span><span class="op">(</span><span class="at">@Qualifier</span><span class="op">(</span><span class="st">&quot;LOG_QUEUE&quot;</span><span class="op">)</span> <span class="bu">Queue</span> logQueue<span class="op">,</span> <span class="at">@Qualifier</span><span class="op">(</span><span class="st">&quot;LOG_EXCHANGE&quot;</span><span class="op">)</span> DirectExchange logExchange<span class="op">)</span> <span class="op">{</span></span>
<span id="cb47-67"><a href="back.html#cb47-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BindingBuilder<span class="op">.</span><span class="fu">bind</span><span class="op">(</span>logQueue<span class="op">).</span><span class="fu">to</span><span class="op">(</span>logExchange<span class="op">).</span><span class="fu">with</span><span class="op">(</span>LOG_BINDING_KEY<span class="op">);</span></span>
<span id="cb47-68"><a href="back.html#cb47-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb47-69"><a href="back.html#cb47-69" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="author.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="front.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/yihui/bookdown-chinese/edit/master/01-back.Rmd",
"text": "编辑"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown.pdf", "bookdown.epub"],
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "none"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
